<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- CSS -->
        <link rel="stylesheet" href="../css/login.css" />
        <title>ƒêƒÉng nh·∫≠p</title>
    </head>
    <body>
        <div class="auth">
            <div class="card">
                <div class="tabs">
                    <button class="tab active" data-tab="login">
                        ƒêƒÉng nh·∫≠p
                    </button>
                    <button class="tab register-active" data-tab="register">
                        ƒêƒÉng k√Ω
                    </button>
                </div>
                <form id="loginForm" class="panel active" novalidate>
                    <div class="form-header">
                        <h2>Ch√†o m·ª´ng tr·ªü l·∫°i!</h2>
                        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</p>
                    </div>
                    <div class="form-body">
                        <div class="field">
                            <label>
                                <span>Email ho·∫∑c Username</span>
                                <input
                                    name="identity"
                                    autocomplete="username"
                                    placeholder="Nh·∫≠p email ho·∫∑c t√™n ƒëƒÉng nh·∫≠p"
                                    required
                                />
                            </label>
                        </div>
                        <div class="field">
                            <label>
                                <span>M·∫≠t kh·∫©u</span>
                                <div class="pw">
                                    <input
                                        type="password"
                                        name="password"
                                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                                        autocomplete="current-password"
                                        required
                                        minlength="6"
                                    />
                                    <button
                                        type="button"
                                        class="pw-toggle"
                                        aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"
                                    >
                                        üëÅ
                                    </button>
                                </div>
                            </label>
                        </div>
                        <div class="options-row">
                            <label class="chk">
                                <input type="checkbox" id="remember" />
                                <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                            </label>
                            <a class="link" href="#" id="forgot">Qu√™n m·∫≠t kh·∫©u?</a>
                        </div>
                    </div>
                    <div class="form-footer">
                        <button class="btn primary" type="submit">ƒêƒÉng nh·∫≠p</button>
                        <p class="error" id="loginError" hidden></p>
                    </div>
                </form>

                <form id="registerForm" class="panel" novalidate>
                    <div class="form-header">
                        <h2>T·∫°o t√†i kho·∫£n m·ªõi</h2>
                        <p>ƒêi·ªÅn th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </div>
                    <div class="form-body">
                        <div class="grid">
                            <div class="field">
                                <label>
                                    <span>H·ªç t√™n</span>
                                    <input 
                                        name="full_name" 
                                        placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß"
                                        required 
                                    />
                                </label>
                            </div>
                            <div class="field">
                                <label>
                                    <span>Email</span>
                                    <input
                                        type="email"
                                        name="email"
                                        placeholder="example@email.com"
                                        autocomplete="email"
                                        required
                                    />
                                </label>
                            </div>
                        </div>
                        <div class="field">
                            <label>
                                <span>T√™n ƒëƒÉng nh·∫≠p</span>
                                <input
                                    name="username"
                                    placeholder="Ch·ªçn t√™n ƒëƒÉng nh·∫≠p"
                                    autocomplete="username"
                                    required
                                />
                            </label>
                        </div>
                        <div class="grid">
                            <div class="field">
                                <label>
                                    <span>M·∫≠t kh·∫©u</span>
                                    <div class="pw">
                                        <input
                                            type="password"
                                            name="password"
                                            placeholder="T·∫°o m·∫≠t kh·∫©u"
                                            autocomplete="new-password"
                                            required
                                            minlength="8"
                                        />
                                        <button type="button" class="pw-toggle">
                                            üëÅ
                                        </button>
                                    </div>
                                </label>
                                <small id="strength">ƒê·ªô m·∫°nh: ‚Äî</small>
                            </div>
                            <div class="field">
                                <label>
                                    <span>X√°c nh·∫≠n m·∫≠t kh·∫©u</span>
                                    <input
                                        type="password"
                                        name="confirm"
                                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                                        required
                                        minlength="8"
                                    />
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-footer">
                        <button class="btn primary" type="submit">
                            T·∫°o t√†i kho·∫£n
                        </button>
                        <p class="error" id="registerError" hidden></p>
                    </div>
                </form>
                <p class="hint">
                    B·∫±ng vi·ªác ti·∫øp t·ª•c, b·∫°n ƒë·ªìng √Ω v·ªõi ƒêi·ªÅu kho·∫£n & Ch√≠nh s√°ch
                    b·∫£o m·∫≠t.
                </p>
            </div>
        </div>
        <script type="module" src="../../shared/api.js"></script>
        <script>
            const { userAPI } = window;

            const tabs = document.querySelectorAll(".tab");
            const panels = {
                login: document.getElementById("loginForm"),
                register: document.getElementById("registerForm"),
            };

            function show(tab) {
                // toggle tab button
                tabs.forEach((t) =>
                    t.classList.toggle("active", t.dataset.tab === tab)
                );
                // toggle panel
                Object.values(panels).forEach((p) =>
                    p.classList.remove("active")
                );
                panels[tab].classList.add("active");
                // ƒë·ªïi ti√™u ƒë·ªÅ & hash (ti·ªán m·ªü tr·ª±c ti·∫øp)
                document.title = tab === "login" ? "ƒêƒÉng nh·∫≠p" : "ƒêƒÉng k√Ω";
                location.hash = tab;
            }

            // click handler
            tabs.forEach((t) =>
                t.addEventListener("click", () => show(t.dataset.tab))
            );

            // m·ªü ƒë√∫ng tab theo URL hash (#login | #register)
            const init = (location.hash || "#login").slice(1);
            show(init);

            // (optional) khi back/forward tr√™n tr√¨nh duy·ªát
            window.addEventListener("hashchange", () =>
                show((location.hash || "#login").slice(1))
            );

            // --- UX helpers: show/hide password ---
            document.querySelectorAll('.pw-toggle').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const pw = btn.closest('.pw').querySelector('input');
                    if (!pw) return;
                    if (pw.type === 'password') {
                        pw.type = 'text';
                        btn.textContent = 'üôà';
                    } else {
                        pw.type = 'password';
                        btn.textContent = 'üëÅ';
                    }
                });
            });

            // --- password strength and match for register form ---
            const registerForm = document.getElementById('registerForm');
            const strengthEl = document.getElementById('strength');
            const regPwd = registerForm.querySelector('input[name="password"]');
            const regConfirm = registerForm.querySelector('input[name="confirm"]');
            const registerError = document.getElementById('registerError');

            function calcStrength(s) {
                let score = 0;
                if (!s) return {score: 0, label: '‚Äî'};
                if (s.length >= 8) score++;
                if (/[A-Z]/.test(s)) score++;
                if (/[0-9]/.test(s)) score++;
                if (/[^A-Za-z0-9]/.test(s)) score++;
                let label = 'Y·∫øu';
                if (score >= 4) label = 'R·∫•t m·∫°nh';
                else if (score === 3) label = 'M·∫°nh';
                else if (score === 2) label = 'Trung b√¨nh';
                return {score, label};
            }

            regPwd.addEventListener('input', () => {
                const s = calcStrength(regPwd.value);
                strengthEl.textContent = `ƒê·ªô m·∫°nh: ${s.label}`;
                strengthEl.style.color = s.score >= 3 ? 'var(--ok)' : (s.score === 2 ? 'orange' : 'var(--muted)');
                // clear previous errors
                registerError.hidden = true;
            });

            regConfirm.addEventListener('input', () => {
                if (regConfirm.value && regPwd.value !== regConfirm.value) {
                    registerError.textContent = 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.';
                    registerError.hidden = false;
                } else {
                    registerError.hidden = true;
                }
            });

            // --- basic form handling (client-side demo) ---
            const loginError = document.getElementById('loginError');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = new FormData(loginForm);
                const identity = data.get("identity")?.trim();
                const password = data.get("password")?.trim();

                if (!identity || !password) {
                    loginError.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.";
                    loginError.hidden = false;
                    return;
                }

                try {
                    const response = await userAPI.login({ 
                        username: identity, 
                        password 
                    });
                    
                    if (response.success) {
                        localStorage.setItem("user", JSON.stringify(response.data));
                        localStorage.setItem("token", response.token || "");
                        window.location.href = "/Web/user/index.html";
                    } else {
                        loginError.textContent = response.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i";
                        loginError.hidden = false;
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    loginError.textContent = "L·ªói k·∫øt n·ªëi server";
                    loginError.hidden = false;
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                registerError.hidden = true;
                const data = new FormData(registerForm);
                const pwd = data.get("password") || "";
                const conf = data.get("confirm") || "";

                if (pwd !== conf) {
                    registerError.textContent = "M·∫≠t kh·∫©u kh√¥ng kh·ªõp";
                    registerError.hidden = false;
                    return;
                }

                try {
                    const response = await userAPI.register({
                        username: data.get("username"),
                        password: pwd,
                        full_name: data.get("full_name"),
                        email: data.get("email"),
                    });

                    if (response.success) {
                        alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                        show("login");
                    } else {
                        registerError.textContent = response.message;
                        registerError.hidden = false;
                    }
                } catch (error) {
                    registerError.textContent = "L·ªói k·∫øt n·ªëi server";
                    registerError.hidden = false;
                }
            });
        </script>
    </body>
</html>

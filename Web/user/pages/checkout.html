<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/checkout.css" />
  </head>

  <body>
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <main class="content">
      <div class="checkout-container">
        <div class="checkout-header">
          <h2>üõí Thanh to√°n ƒë∆°n h√†ng</h2>
          <div class="checkout-steps">
            <div class="step active">
              <div class="step-number">1</div>
              <span>Gi·ªè h√†ng</span>
            </div>
            <div class="step-line"></div>
            <div class="step active">
              <div class="step-number">2</div>
              <span>Thanh to√°n</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-number">3</div>
              <span>Ho√†n t·∫•t</span>
            </div>
          </div>
        </div>

        <div class="checkout-content">
          <!-- Left: Form th√¥ng tin -->
          <div class="checkout-form">
            <div class="form-section">
              <h3>üìç Th√¥ng tin giao h√†ng</h3>
              <div class="form-group">
                <label for="fullName">H·ªç v√† t√™n <span class="required">*</span></label>
                <input type="text" id="fullName" placeholder="Nguy·ªÖn VƒÉn A" required />
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="phone">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                  <input type="tel" id="phone" placeholder="0123456789" required />
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" placeholder="email@example.com" />
                </div>
              </div>

              <div class="form-group">
                <label for="address">ƒê·ªãa ch·ªâ giao h√†ng <span class="required">*</span></label>
                <input type="text" id="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="city">T·ªânh/Th√†nh ph·ªë <span class="required">*</span></label>
                  <select id="city" required>
                    <option value="">Ch·ªçn t·ªânh/th√†nh</option>
                    <option value="H√† N·ªôi">H√† N·ªôi</option>
                    <option value="H·ªì Ch√≠ Minh">H·ªì Ch√≠ Minh</option>
                    <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                    <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                    <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="district">Qu·∫≠n/Huy·ªán <span class="required">*</span></label>
                  <select id="district" required>
                    <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                    <option value="Qu·∫≠n 1">Qu·∫≠n 1</option>
                    <option value="Qu·∫≠n 3">Qu·∫≠n 3</option>
                    <option value="Qu·∫≠n 5">Qu·∫≠n 5</option>
                    <option value="Qu·∫≠n 10">Qu·∫≠n 10</option>
                    <option value="Th·ªß ƒê·ª©c">Th·ªß ƒê·ª©c</option>
                    <option value="B√¨nh Th·∫°nh">B√¨nh Th·∫°nh</option>
                    <option value="G√≤ V·∫•p">G√≤ V·∫•p</option>
                    <option value="T√¢n B√¨nh">T√¢n B√¨nh</option>
                    <option value="Ph√∫ Nhu·∫≠n">Ph√∫ Nhu·∫≠n</option>
                    <option value="B√¨nh T√¢n">B√¨nh T√¢n</option>
                    <option value="T√¢n Ph√∫">T√¢n Ph√∫</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="notes">Ghi ch√∫</label>
                <textarea id="notes" rows="3" placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
              <div class="payment-methods">
                <label class="payment-method active">
                  <input type="radio" name="payment" value="cash" checked />
                  <div class="payment-content">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-info">
                      <h4>Ti·ªÅn m·∫∑t (COD)</h4>
                      <p>Thanh to√°n khi nh·∫≠n h√†ng</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="card" />
                  <div class="payment-content">
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-info">
                      <h4>Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</h4>
                      <p>Visa, Mastercard, JCB</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="online" />
                  <div class="payment-content">
                    <div class="payment-icon">üì±</div>
                    <div class="payment-info">
                      <h4>V√≠ ƒëi·ªán t·ª≠</h4>
                      <p>MoMo, ZaloPay, VNPay</p>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Right: Order Summary -->
          <div class="order-summary">
            <div class="summary-card">
              <h3>üì¶ ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
              
              <div id="orderItems" class="order-items">
                <div style="text-align: center; padding: 20px; color: #999;">ƒêang t·∫£i...</div>
              </div>

              <div class="summary-row">
                <span>T·∫°m t√≠nh</span>
                <span id="subtotal">0‚Ç´</span>
              </div>

              <div class="summary-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span id="shippingFee">Mi·ªÖn ph√≠</span>
              </div>

              <div class="summary-row discount-row">
                <input type="text" id="couponCode" placeholder="M√£ gi·∫£m gi√°" />
                <button onclick="window.applyCoupon()" class="apply-btn">√Åp d·ª•ng</button>
              </div>

              <div class="summary-row discount-applied" id="discountRow" style="display: none;">
                <span>Gi·∫£m gi√°</span>
                <span id="discountAmount" style="color: #10b981;">-0‚Ç´</span>
              </div>

              <div class="summary-divider"></div>

              <div class="summary-row total">
                <span>T·ªïng thanh to√°n</span>
                <span id="totalAmount">0‚Ç´</span>
              </div>

              <button onclick="window.completeCheckout()" class="checkout-btn">
                <span>ƒê·∫∑t h√†ng</span>
                <span>‚Üí</span>
              </button>

              <div class="security-note">
                üîí Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c b·∫£o m·∫≠t
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { orderAPI, invoiceAPI } from "../../shared/api.js";
      import { cartAPI } from "../../shared/cartApi.js";

      let cart = [];
      let subtotal = 0;
      let discount = 0;
      let shippingFee = 0;

      // Load cart items
      async function loadCart() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        // Try to get cart from server or localStorage
        try {
          if (user && user.user_id) {
            const res = await cartAPI.get(user.user_id);
            const serverCart = res.data || res;
            if (serverCart && serverCart.items && serverCart.items.length > 0) {
              cart = serverCart.items;
            } else {
              cart = JSON.parse(localStorage.getItem('cart') || '[]');
            }
          } else {
            const guest = localStorage.getItem('guest_token');
            if (guest) {
              const res = await cartAPI.get(guest);
              const serverCart = res.data || res;
              if (serverCart && serverCart.items && serverCart.items.length > 0) {
                cart = serverCart.items;
              } else {
                cart = JSON.parse(localStorage.getItem('cart') || '[]');
              }
            } else {
              cart = JSON.parse(localStorage.getItem('cart') || '[]');
            }
          }
        } catch (err) {
          console.warn('Load cart failed, using localStorage', err);
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
        }

        if (cart.length === 0) {
          alert('Gi·ªè h√†ng tr·ªëng!');
          window.location.href = '/Web/user/pages/cart.html';
          return;
        }

        renderOrderItems();
        updateTotals();
      }

      function renderOrderItems() {
        const container = document.getElementById('orderItems');
        container.innerHTML = cart.map(item => {
          const itemTotal = (item.price || 0) * (item.quantity || 1);
          return `
            <div class="order-item">
              <div class="item-info">
                <h4>${item.name}</h4>
                <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
              </div>
              <div class="item-price">${itemTotal.toLocaleString()}‚Ç´</div>
            </div>
          `;
        }).join('');
      }

      function updateTotals() {
        subtotal = cart.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0);
        const total = subtotal - discount + shippingFee;

        document.getElementById('subtotal').textContent = subtotal.toLocaleString() + '‚Ç´';
        document.getElementById('totalAmount').textContent = total.toLocaleString() + '‚Ç´';
      }

      window.applyCoupon = async () => {
        const code = document.getElementById('couponCode').value.trim();
        if (!code) {
          alert('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°');
          return;
        }

        // TODO: Call coupon API to validate and get discount
        alert('T√≠nh nƒÉng m√£ gi·∫£m gi√° ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
      };

      window.completeCheckout = async () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n');
          window.location.href = '/Web/user/pages/login.html';
          return;
        }

        // Validate form
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const city = document.getElementById('city').value;
        const district = document.getElementById('district').value;
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        const notes = document.getElementById('notes').value.trim();

        if (!fullName || !phone || !address || !city || !district) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng');
          return;
        }

        const shippingInfo = {
          fullName,
          phone,
          address: `${address}, ${district}, ${city}`,
          notes
        };

        try {
          const total = subtotal - discount + shippingFee;

          // Create order
          const orderRes = await orderAPI.create({
            customer_id: user.user_id,
            order_items: cart.map(item => ({
              drug_id: item.drug_id,
              drug_name: item.name,
              quantity: item.quantity,
              price: item.price
            })),
            total_amount: total,
            payment_method: paymentMethod,
            status: 'Pending',
            notes: JSON.stringify(shippingInfo)
          });

          const orderId = orderRes.data?.order_id || orderRes.order_id;

          // Create invoice
          const invoiceRes = await invoiceAPI.create({
            order_id: orderId,
            customer_id: user.user_id,
            items: cart.map(item => ({
              medicine_id: item.drug_id,
              name: item.name,
              quantity: item.quantity,
              unit_price: item.price,
              total_price: item.price * item.quantity
            })),
            subtotal: subtotal,
            discount: discount,
            tax: 0,
            shipping_fee: shippingFee,
            total: total,
            payment_method: paymentMethod,
            status: 'pending'
          });

          // Clear cart
          try {
            const guestToken = localStorage.getItem('guest_token');
            if (user.user_id) {
              const res = await cartAPI.get(user.user_id);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            } else if (guestToken) {
              const res = await cartAPI.get(guestToken);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            }
          } catch (err) {
            console.warn('Failed to clear server cart', err);
          }
          
          localStorage.removeItem('cart');

          // Redirect to success page
          localStorage.setItem('lastOrder', JSON.stringify({
            orderId,
            total,
            shippingInfo,
            items: cart
          }));

          window.location.href = '/Web/user/pages/order-success.html';
        } catch (error) {
          console.error('Checkout error:', error);
          alert('‚ùå L·ªói khi thanh to√°n: ' + (error.message || JSON.stringify(error)));
        }
      };

      // Payment method selection
      document.addEventListener('DOMContentLoaded', () => {
        loadCart();

        // Handle payment method click
        document.querySelectorAll('.payment-method').forEach(method => {
          method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
          });
        });

        // Auto-fill user info if available
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (user) {
          if (user.username) document.getElementById('fullName').value = user.username;
          if (user.email) document.getElementById('email').value = user.email;
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toÃ¡n - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/checkout.css" />
  </head>

  <body>
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <main class="content">
      <div class="checkout-container">
        <div class="checkout-header">
          <h2>ğŸ›’ Thanh toÃ¡n Ä‘Æ¡n hÃ ng</h2>
          <div class="checkout-steps">
            <div class="step active">
              <div class="step-number">1</div>
              <span>Giá» hÃ ng</span>
            </div>
            <div class="step-line"></div>
            <div class="step active">
              <div class="step-number">2</div>
              <span>Thanh toÃ¡n</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-number">3</div>
              <span>HoÃ n táº¥t</span>
            </div>
          </div>
        </div>

        <div class="checkout-content">
          <!-- Left: Form thÃ´ng tin -->
          <div class="checkout-form">
            <div class="form-section">
              <h3>ğŸ“ ThÃ´ng tin giao hÃ ng</h3>
              
              <div class="form-group" id="savedAddressGroup" style="display: none; margin-bottom: 1.5rem;">
                <label for="savedAddress" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Chá»n Ä‘á»‹a chá»‰ Ä‘Ã£ lÆ°u</label>
                <select id="savedAddress" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                  <option value="">-- Nháº­p Ä‘á»‹a chá»‰ má»›i --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="fullName">Há» vÃ  tÃªn <span class="required">*</span></label>
                <input type="text" id="fullName" placeholder="Nguyá»…n VÄƒn A" required />
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="phone">Sá»‘ Ä‘iá»‡n thoáº¡i <span class="required">*</span></label>
                  <input type="tel" id="phone" placeholder="0123456789" required />
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" placeholder="email@example.com" />
                </div>
              </div>

              <div class="form-group">
                <label for="address">Äá»‹a chá»‰ giao hÃ ng <span class="required">*</span></label>
                <input type="text" id="address" placeholder="Sá»‘ nhÃ , tÃªn Ä‘Æ°á»ng" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="city">Tá»‰nh/ThÃ nh phá»‘ <span class="required">*</span></label>
                  <select id="city" required>
                    <option value="">-- Chá»n tá»‰nh/thÃ nh --</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="district">Quáº­n/Huyá»‡n <span class="required">*</span></label>
                  <select id="district" required disabled>
                    <option value="">-- Chá»n quáº­n/huyá»‡n --</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="notes">Ghi chÃº</label>
                <textarea id="notes" rows="3" placeholder="Ghi chÃº thÃªm cho Ä‘Æ¡n hÃ ng (khÃ´ng báº¯t buá»™c)"></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>ğŸ’³ PhÆ°Æ¡ng thá»©c thanh toÃ¡n</h3>
              <div class="payment-methods">
                <label class="payment-method active">
                  <input type="radio" name="payment" value="cash" checked />
                  <div class="payment-content">
                    <div class="payment-icon">ğŸ’µ</div>
                    <div class="payment-info">
                      <h4>Tiá»n máº·t (COD)</h4>
                      <p>Thanh toÃ¡n khi nháº­n hÃ ng</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="card" />
                  <div class="payment-content">
                    <div class="payment-icon">ğŸ’³</div>
                    <div class="payment-info">
                      <h4>Tháº» tÃ­n dá»¥ng/Ghi ná»£</h4>
                      <p>Visa, Mastercard, JCB</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="online" />
                  <div class="payment-content">
                    <div class="payment-icon">ğŸ“±</div>
                    <div class="payment-info">
                      <h4>Chuyá»ƒn khoáº£n QR</h4>
                      <p>QuÃ©t mÃ£ QR Ä‘á»ƒ thanh toÃ¡n</p>
                    </div>
                  </div>
                </label>
              </div>

              <!-- Card Payment Details -->
              <div id="cardDetails" class="payment-details">
                <h4>ğŸ’³ ThÃ´ng tin tháº»</h4>
                
                <div class="card-form-group">
                  <label for="cardNumber">Sá»‘ tháº» <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="cardNumber" 
                    placeholder="1234 5678 9012 3456"
                    maxlength="19"
                    pattern="[0-9\s]*"
                  />
                  <div class="card-icons">
                    <div class="card-icon">VISA</div>
                    <div class="card-icon">MC</div>
                    <div class="card-icon">JCB</div>
                  </div>
                </div>

                <div class="card-form-group">
                  <label for="cardHolder">TÃªn chá»§ tháº» <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="cardHolder" 
                    placeholder="NGUYEN VAN A"
                    style="text-transform: uppercase;"
                  />
                </div>

                <div class="card-row">
                  <div class="card-form-group">
                    <label for="cardExpiry">NgÃ y háº¿t háº¡n <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="cardExpiry" 
                      placeholder="MM/YY"
                      maxlength="5"
                    />
                  </div>
                  <div class="card-form-group">
                    <label for="cardCVV">CVV <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="cardCVV" 
                      placeholder="123"
                      maxlength="4"
                      pattern="[0-9]*"
                    />
                  </div>
                </div>

                <div class="security-badge">
                  <span>ğŸ”’</span>
                  <span>Giao dá»‹ch Ä‘Æ°á»£c mÃ£ hÃ³a SSL 256-bit</span>
                </div>
              </div>

              <!-- QR Code Payment Details -->
              <div id="qrDetails" class="payment-details">
                <h4>ğŸ“± QuÃ©t mÃ£ QR Ä‘á»ƒ thanh toÃ¡n</h4>
                
                <div class="qr-section">
                  <div class="qr-code">
                    <img id="qrImage" 
                         src="https://img.vietqr.io/image/BIDV-8897180034-compact.png" 
                         alt="QR Payment"
                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
                  </div>

                  <div class="qr-info">
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">NgÃ¢n hÃ ng:</span>
                        <strong style="color: #1f2937;">BIDV</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Sá»‘ tÃ i khoáº£n:</span>
                        <strong style="color: #1f2937;">8897180034</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Chá»§ tÃ i khoáº£n:</span>
                        <strong style="color: #1f2937;">DRUGSTORE PHARMACY</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Sá»‘ tiá»n:</span>
                        <strong id="qrAmount" style="color: #10b981; font-size: 1.25rem;">0â‚«</strong>
                      </div>
                    </div>

                    <div style="background: #fef3c7; padding: 0.875rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                      <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                        âš ï¸ <strong>Ná»™i dung chuyá»ƒn khoáº£n:</strong> <span id="qrContent" style="font-weight: 700; color: #b45309;">ORD-XXXX</span>
                      </p>
                    </div>

                    <div style="background: #dbeafe; padding: 0.875rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                      <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">
                        ğŸ’¡ QuÃ©t mÃ£ QR báº±ng app ngÃ¢n hÃ ng cá»§a báº¡n Ä‘á»ƒ thanh toÃ¡n tá»± Ä‘á»™ng vá»›i Ä‘áº§y Ä‘á»§ thÃ´ng tin
                      </p>
                    </div>
                  </div>
                </div>

                <div class="security-badge" style="margin-top: 1rem;">
                  <span>ğŸ”’</span>
                  <span>Thanh toÃ¡n an toÃ n qua VietQR</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Order Summary -->
          <div class="order-summary">
            <div class="summary-card">
              <h3>ğŸ“¦ ÄÆ¡n hÃ ng cá»§a báº¡n</h3>
              
              <div id="orderItems" class="order-items">
                <div style="text-align: center; padding: 20px; color: #999;">Äang táº£i...</div>
              </div>

              <div class="summary-row">
                <span>Táº¡m tÃ­nh</span>
                <span id="subtotal">0â‚«</span>
              </div>

              <div class="summary-row">
                <span>PhÃ­ váº­n chuyá»ƒn</span>
                <span id="shippingFee">Miá»…n phÃ­</span>
              </div>

              <div class="summary-row discount-row">
                <input type="text" id="couponCode" placeholder="MÃ£ giáº£m giÃ¡" />
                <button onclick="window.applyCoupon()" class="apply-btn">Ãp dá»¥ng</button>
              </div>

              <div class="summary-row discount-applied" id="discountRow" style="display: none;">
                <span>Giáº£m giÃ¡</span>
                <span id="discountAmount" style="color: #10b981;">-0â‚«</span>
              </div>

              <div class="summary-divider"></div>

              <div class="summary-row total">
                <span>Tá»•ng thanh toÃ¡n</span>
                <span id="totalAmount">0â‚«</span>
              </div>

              <button onclick="window.completeCheckout()" class="checkout-btn">
                <span>Äáº·t hÃ ng</span>
                <span>â†’</span>
              </button>

              <div class="security-note">
                ğŸ”’ ThÃ´ng tin cá»§a báº¡n Ä‘Æ°á»£c báº£o máº­t
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { orderAPI, invoiceAPI, couponAPI, discountAPI } from "../../shared/api.js";
      import { cartAPI } from "../../shared/cartApi.js";
      import { initAdminSecretButton } from "../../shared/adminButton.js";

      // ğŸ”’ Khá»Ÿi táº¡o nÃºt admin áº©n
      initAdminSecretButton('/Web/admin/orders.html');

      let cart = [];
      let subtotal = 0;
      let discount = 0;
      let shippingFee = 0;

      // VietQR Configuration
      const VIETQR_CONFIG = {
        bankId: 'BIDV',
        accountNo: '8897180034',
        accountName: 'NGUYEN NGUYEN PHUC',
        template: 'compact'
      };

      // Dá»¯ liá»‡u 63 tá»‰nh/thÃ nh phá»‘ Viá»‡t Nam vÃ  quáº­n/huyá»‡n
      const vietnamData = {
        "An Giang": ["TP. Long XuyÃªn", "TP. ChÃ¢u Äá»‘c", "TX. TÃ¢n ChÃ¢u", "An PhÃº", "ChÃ¢u PhÃº", "ChÃ¢u ThÃ nh", "Chá»£ Má»›i", "PhÃº TÃ¢n", "Thoáº¡i SÆ¡n", "Tá»‹nh BiÃªn", "Tri TÃ´n"],
        
        "BÃ  Rá»‹a - VÅ©ng TÃ u": ["TP. VÅ©ng TÃ u", "TP. BÃ  Rá»‹a", "TX. PhÃº Má»¹", "ChÃ¢u Äá»©c", "CÃ´n Äáº£o", "Äáº¥t Äá»", "Long Äiá»n", "TÃ¢n ThÃ nh", "XuyÃªn Má»™c"],
        
        "Báº¡c LiÃªu": ["TP. Báº¡c LiÃªu", "TX. GiÃ¡ Rai", "ÄÃ´ng Háº£i", "HÃ²a BÃ¬nh", "Há»“ng DÃ¢n", "PhÆ°á»›c Long", "VÄ©nh Lá»£i"],
        
        "Báº¯c Giang": ["TP. Báº¯c Giang", "Hiá»‡p HÃ²a", "Láº¡ng Giang", "Lá»¥c Nam", "Lá»¥c Ngáº¡n", "SÆ¡n Äá»™ng", "TÃ¢n YÃªn", "Viá»‡t YÃªn", "YÃªn DÅ©ng", "YÃªn Tháº¿"],
        
        "Báº¯c Káº¡n": ["TP. Báº¯c Káº¡n", "Ba Bá»ƒ", "Báº¡ch ThÃ´ng", "Chá»£ Äá»“n", "Chá»£ Má»›i", "Na RÃ¬", "NgÃ¢n SÆ¡n", "PÃ¡c Náº·m"],
        
        "Báº¯c Ninh": ["TP. Báº¯c Ninh", "TX. Tá»« SÆ¡n", "Gia BÃ¬nh", "LÆ°Æ¡ng TÃ i", "Quáº¿ VÃµ", "Thuáº­n ThÃ nh", "TiÃªn Du", "YÃªn Phong"],
        
        "Báº¿n Tre": ["TP. Báº¿n Tre", "Ba Tri", "BÃ¬nh Äáº¡i", "ChÃ¢u ThÃ nh", "Chá»£ LÃ¡ch", "Giá»“ng TrÃ´m", "Má» CÃ y Báº¯c", "Má» CÃ y Nam", "Tháº¡nh PhÃº"],
        
        "BÃ¬nh DÆ°Æ¡ng": ["TP. Thá»§ Dáº§u Má»™t", "TP. Thuáº­n An", "TP. DÄ© An", "TX. TÃ¢n UyÃªn", "TX. Báº¿n CÃ¡t", "BÃ u BÃ ng", "Dáº§u Tiáº¿ng", "PhÃº GiÃ¡o"],
        
        "BÃ¬nh Äá»‹nh": ["TP. Quy NhÆ¡n", "TX. An NhÆ¡n", "TX. HoÃ i NhÆ¡n", "An LÃ£o", "HoÃ i Ã‚n", "PhÃº CÃ¡t", "PhÃº Má»¹", "TÃ¢y SÆ¡n", "Tuy PhÆ°á»›c", "VÃ¢n Canh", "VÄ©nh Tháº¡nh"],
        
        "BÃ¬nh PhÆ°á»›c": ["TP. Äá»“ng XoÃ i", "TX. BÃ¬nh Long", "TX. PhÆ°á»›c Long", "BÃ¹ ÄÄƒng", "BÃ¹ Äá»‘p", "BÃ¹ Gia Máº­p", "ChÆ¡n ThÃ nh", "Äá»“ng PhÃº", "Há»›n Quáº£n", "Lá»™c Ninh", "PhÃº Riá»ng"],
        
        "BÃ¬nh Thuáº­n": ["TP. Phan Thiáº¿t", "TX. La Gi", "Báº¯c BÃ¬nh", "Äá»©c Linh", "HÃ m Thuáº­n Báº¯c", "HÃ m Thuáº­n Nam", "HÃ m TÃ¢n", "PhÃº QuÃ­", "TÃ¡nh Linh", "Tuy Phong"],
        
        "CÃ  Mau": ["TP. CÃ  Mau", "CÃ¡i NÆ°á»›c", "Äáº§m DÆ¡i", "NÄƒm CÄƒn", "Ngá»c Hiá»ƒn", "PhÃº TÃ¢n", "Thá»›i BÃ¬nh", "Tráº§n VÄƒn Thá»i", "U Minh"],
        
        "Cáº§n ThÆ¡": ["Ninh Kiá»u", "Ã” MÃ´n", "BÃ¬nh Thuá»·", "CÃ¡i RÄƒng", "Thá»‘t Ná»‘t", "VÄ©nh Tháº¡nh", "Cá» Äá»", "Phong Äiá»n", "Thá»›i Lai"],
        
        "Cao Báº±ng": ["TP. Cao Báº±ng", "Báº£o Láº¡c", "Báº£o LÃ¢m", "HÃ  Quáº£ng", "Háº¡ Lang", "HÃ²a An", "NguyÃªn BÃ¬nh", "Phá»¥c HÃ²a", "Quáº£ng UyÃªn", "Tháº¡ch An", "ThÃ´ng NÃ´ng", "TrÃ  LÄ©nh", "TrÃ¹ng KhÃ¡nh"],
        
        "ÄÃ  Náºµng": ["Háº£i ChÃ¢u", "Thanh KhÃª", "SÆ¡n TrÃ ", "NgÅ© HÃ nh SÆ¡n", "LiÃªn Chiá»ƒu", "Cáº©m Lá»‡", "HÃ²a Vang", "HoÃ ng Sa"],
        
        "Äáº¯k Láº¯k": ["TP. BuÃ´n Ma Thuá»™t", "TX. BuÃ´n Há»“", "BuÃ´n ÄÃ´n", "CÆ° Kuin", "CÆ° M'gar", "Ea H'leo", "Ea Kar", "Ea SÃºp", "KrÃ´ng Ana", "KrÃ´ng BÃ´ng", "KrÃ´ng Buk", "KrÃ´ng NÄƒng", "KrÃ´ng Páº¯c", "Láº¯k", "M'Äráº¯k"],
        
        "Äáº¯k NÃ´ng": ["TP. Gia NghÄ©a", "CÃº JÃºt", "Äáº¯k Glong", "Äáº¯k Mil", "Äáº¯k R'Láº¥p", "Äáº¯k Song", "KrÃ´ng NÃ´", "Tuy Äá»©c"],
        
        "Äiá»‡n BiÃªn": ["TP. Äiá»‡n BiÃªn Phá»§", "TX. MÆ°á»ng Lay", "Äiá»‡n BiÃªn", "Äiá»‡n BiÃªn ÄÃ´ng", "MÆ°á»ng áº¢ng", "MÆ°á»ng ChÃ ", "MÆ°á»ng NhÃ©", "Náº­m Pá»“", "Tá»§a ChÃ¹a", "Tuáº§n GiÃ¡o"],
        
        "Äá»“ng Nai": ["TP. BiÃªn HÃ²a", "TP. Long KhÃ¡nh", "Cáº©m Má»¹", "Äá»‹nh QuÃ¡n", "Long ThÃ nh", "NhÆ¡n Tráº¡ch", "TÃ¢n PhÃº", "Thá»‘ng Nháº¥t", "Tráº£ng Bom", "VÄ©nh Cá»­u", "XuÃ¢n Lá»™c"],
        
        "Äá»“ng ThÃ¡p": ["TP. Cao LÃ£nh", "TP. Sa ÄÃ©c", "TX. Há»“ng Ngá»±", "Cao LÃ£nh", "ChÃ¢u ThÃ nh", "Há»“ng Ngá»±", "Lai Vung", "Láº¥p VÃ²", "Tam NÃ´ng", "TÃ¢n Há»“ng", "Thanh BÃ¬nh", "ThÃ¡p MÆ°á»i"],
        
        "Gia Lai": ["TP. Pleiku", "TX. An KhÃª", "TX. Ayun Pa", "ChÆ° PÄƒh", "ChÆ° PrÃ´ng", "ChÆ° PÆ°h", "ChÆ° SÃª", "Äáº¯k Äoa", "Äáº¯k PÆ¡", "Äá»©c CÆ¡", "Ia Grai", "Ia Pa", "K'Bang", "KÃ´ng Chro", "KrÃ´ng Pa", "Mang Yang", "PhÃº Thiá»‡n"],
        
        "HÃ  Giang": ["TP. HÃ  Giang", "Báº¯c MÃª", "Báº¯c Quang", "Äá»“ng VÄƒn", "HoÃ ng Su PhÃ¬", "MÃ¨o Váº¡c", "Quáº£n Báº¡", "Quáº£ng BÃ¬nh", "Vá»‹ XuyÃªn", "XÃ­n Máº§n", "YÃªn Minh"],
        
        "HÃ  Nam": ["TP. Phá»§ LÃ½", "TX. Duy TiÃªn", "BÃ¬nh Lá»¥c", "Kim Báº£ng", "LÃ½ NhÃ¢n", "Thanh LiÃªm"],
        
        "HÃ  Ná»™i": ["Ba ÄÃ¬nh", "HoÃ n Kiáº¿m", "Hai BÃ  TrÆ°ng", "Äá»‘ng Äa", "TÃ¢y Há»“", "Cáº§u Giáº¥y", "Thanh XuÃ¢n", "HoÃ ng Mai", "Long BiÃªn", "Nam Tá»« LiÃªm", "Báº¯c Tá»« LiÃªm", "HÃ  ÄÃ´ng", "TX. SÆ¡n TÃ¢y", "Ba VÃ¬", "ChÆ°Æ¡ng Má»¹", "Äan PhÆ°á»£ng", "ÄÃ´ng Anh", "Gia LÃ¢m", "HoÃ i Äá»©c", "MÃª Linh", "Má»¹ Äá»©c", "PhÃº XuyÃªn", "PhÃºc Thá»", "Quá»‘c Oai", "SÃ³c SÆ¡n", "Tháº¡ch Tháº¥t", "Thanh Oai", "Thanh TrÃ¬", "ThÆ°á»ng TÃ­n", "á»¨ng HÃ²a"],
        
        "HÃ  TÄ©nh": ["TP. HÃ  TÄ©nh", "TX. Há»“ng LÄ©nh", "TX. Ká»³ Anh", "Cáº©m XuyÃªn", "Can Lá»™c", "Äá»©c Thá»", "HÆ°Æ¡ng KhÃª", "HÆ°Æ¡ng SÆ¡n", "Ká»³ Anh", "Lá»™c HÃ ", "Nghi XuÃ¢n", "Tháº¡ch HÃ ", "VÅ© Quang"],
        
        "Háº£i DÆ°Æ¡ng": ["TP. Háº£i DÆ°Æ¡ng", "TP. ChÃ­ Linh", "TX. Kinh MÃ´n", "BÃ¬nh Giang", "Cáº©m GiÃ ng", "Gia Lá»™c", "Kim ThÃ nh", "Nam SÃ¡ch", "Ninh Giang", "Thanh HÃ ", "Thanh Miá»‡n", "Tá»© Ká»³"],
        
        "Háº£i PhÃ²ng": ["Há»“ng BÃ ng", "NgÃ´ Quyá»n", "LÃª ChÃ¢n", "Háº£i An", "Kiáº¿n An", "Äá»“ SÆ¡n", "DÆ°Æ¡ng Kinh", "An DÆ°Æ¡ng", "An LÃ£o", "Kiáº¿n Thuá»µ", "TiÃªn LÃ£ng", "VÄ©nh Báº£o", "CÃ¡t Háº£i", "Báº¡ch Long VÄ©"],
        
        "Háº­u Giang": ["TP. Vá»‹ Thanh", "TP. NgÃ£ Báº£y", "TX. Long Má»¹", "ChÃ¢u ThÃ nh", "ChÃ¢u ThÃ nh A", "Long Má»¹", "Phá»¥ng Hiá»‡p", "Vá»‹ Thuá»·"],
        
        "HÃ²a BÃ¬nh": ["TP. HÃ²a BÃ¬nh", "Cao Phong", "ÄÃ  Báº¯c", "Kim BÃ´i", "Ká»³ SÆ¡n", "Láº¡c SÆ¡n", "Láº¡c Thuá»·", "LÆ°Æ¡ng SÆ¡n", "Mai ChÃ¢u", "TÃ¢n Láº¡c", "YÃªn Thuá»·"],
        
        "HÆ°ng YÃªn": ["TP. HÆ°ng YÃªn", "Ã‚n Thi", "KhoÃ¡i ChÃ¢u", "Kim Äá»™ng", "Má»¹ HÃ o", "PhÃ¹ Cá»«", "TiÃªn Lá»¯", "VÄƒn Giang", "VÄƒn LÃ¢m", "YÃªn Má»¹"],
        
        "KhÃ¡nh HÃ²a": ["TP. Nha Trang", "TP. Cam Ranh", "TX. Ninh HÃ²a", "Cam LÃ¢m", "DiÃªn KhÃ¡nh", "KhÃ¡nh SÆ¡n", "KhÃ¡nh VÄ©nh", "TrÆ°á»ng Sa", "Váº¡n Ninh"],
        
        "KiÃªn Giang": ["TP. Ráº¡ch GiÃ¡", "TP. HÃ  TiÃªn", "TX. KiÃªn LÆ°Æ¡ng", "An BiÃªn", "An Minh", "ChÃ¢u ThÃ nh", "Giang ThÃ nh", "Giá»“ng Riá»ng", "GÃ² Quao", "HÃ²n Äáº¥t", "KiÃªn Háº£i", "PhÃº Quá»‘c", "TÃ¢n Hiá»‡p", "U Minh ThÆ°á»£ng", "VÄ©nh Thuáº­n"],
        
        "Kon Tum": ["TP. Kon Tum", "Äáº¯k Glei", "Äáº¯k HÃ ", "Äáº¯k TÃ´", "Ia H' Drai", "Kon PlÃ´ng", "Kon Ráº«y", "Ngá»c Há»“i", "Sa Tháº§y", "Tu MÆ¡ RÃ´ng"],
        
        "Lai ChÃ¢u": ["TP. Lai ChÃ¢u", "MÆ°á»ng TÃ¨", "Náº­m NhÃ¹n", "Phong Thá»•", "SÃ¬n Há»“", "Tam ÄÆ°á»ng", "TÃ¢n UyÃªn", "Than UyÃªn"],
        
        "LÃ¢m Äá»“ng": ["TP. ÄÃ  Láº¡t", "TP. Báº£o Lá»™c", "Báº£o LÃ¢m", "CÃ¡t TiÃªn", "Äáº¡ Huoai", "Äáº¡ Táº»h", "Äam RÃ´ng", "Di Linh", "ÄÆ¡n DÆ°Æ¡ng", "Äá»©c Trá»ng", "Láº¡c DÆ°Æ¡ng", "LÃ¢m HÃ "],
        
        "Láº¡ng SÆ¡n": ["TP. Láº¡ng SÆ¡n", "Báº¯c SÆ¡n", "BÃ¬nh Gia", "Cao Lá»™c", "Chi LÄƒng", "ÄÃ¬nh Láº­p", "Há»¯u LÅ©ng", "Lá»™c BÃ¬nh", "Trang Äá»‹nh", "VÄƒn LÃ£ng", "VÄƒn Quan"],
        
        "LÃ o Cai": ["TP. LÃ o Cai", "Báº¯c HÃ ", "Báº£o Tháº¯ng", "Báº£o YÃªn", "BÃ¡t XÃ¡t", "MÆ°á»ng KhÆ°Æ¡ng", "Sa Pa", "Si Ma Cai", "VÄƒn BÃ n"],
        
        "Long An": ["TP. TÃ¢n An", "TX. Kiáº¿n TÆ°á»ng", "Báº¿n Lá»©c", "Cáº§n ÄÆ°á»›c", "Cáº§n Giuá»™c", "ChÃ¢u ThÃ nh", "Äá»©c HÃ²a", "Äá»©c Huá»‡", "Má»™c HÃ³a", "TÃ¢n HÆ°ng", "TÃ¢n Tháº¡nh", "TÃ¢n Trá»¥", "Tháº¡nh HÃ³a", "Thá»§ Thá»«a", "VÄ©nh HÆ°ng"],
        
        "Nam Äá»‹nh": ["TP. Nam Äá»‹nh", "Giao Thuá»·", "Háº£i Háº­u", "Má»¹ Lá»™c", "Nam Trá»±c", "NghÄ©a HÆ°ng", "Trá»±c Ninh", "Vá»¥ Báº£n", "XuÃ¢n TrÆ°á»ng", "Ã YÃªn"],
        
        "Nghá»‡ An": ["TP. Vinh", "TX. Cá»­a LÃ²", "TX. ThÃ¡i HoÃ ", "TX. HoÃ ng Mai", "Anh SÆ¡n", "Con CuÃ´ng", "Diá»…n ChÃ¢u", "ÄÃ´ LÆ°Æ¡ng", "HÆ°ng NguyÃªn", "Ká»³ SÆ¡n", "Nam ÄÃ n", "NghÄ©a ÄÃ n", "Nghi Lá»™c", "Quáº¿ Phong", "Quá»³ ChÃ¢u", "Quá»³ Há»£p", "Quá»³nh LÆ°u", "TÃ¢n Ká»³", "Thanh ChÆ°Æ¡ng", "TÆ°Æ¡ng DÆ°Æ¡ng", "YÃªn ThÃ nh"],
        
        "Ninh BÃ¬nh": ["TP. Ninh BÃ¬nh", "TP. Tam Äiá»‡p", "Gia Viá»…n", "Hoa LÆ°", "Kim SÆ¡n", "Nho Quan", "YÃªn KhÃ¡nh", "YÃªn MÃ´"],
        
        "Ninh Thuáº­n": ["TP. Phan Rang-ThÃ¡p ChÃ m", "BÃ¡c Ãi", "Ninh Háº£i", "Ninh PhÆ°á»›c", "Ninh SÆ¡n", "Thuáº­n Báº¯c", "Thuáº­n Nam"],
        
        "PhÃº Thá»": ["TP. Viá»‡t TrÃ¬", "TX. PhÃº Thá»", "Cáº©m KhÃª", "Äoan HÃ¹ng", "Háº¡ HoÃ ", "LÃ¢m Thao", "PhÃ¹ Ninh", "Tam NÃ´ng", "TÃ¢n SÆ¡n", "Thanh Ba", "Thanh SÆ¡n", "Thanh Thuá»·", "YÃªn Láº­p"],
        
        "PhÃº YÃªn": ["TP. Tuy HÃ²a", "TX. SÃ´ng Cáº§u", "ÄÃ´ng HÃ²a", "Äá»“ng XuÃ¢n", "PhÃº HÃ²a", "SÆ¡n HÃ²a", "SÃ´ng Hinh", "TÃ¢y HÃ²a", "Tuy An"],
        
        "Quáº£ng BÃ¬nh": ["TP. Äá»“ng Há»›i", "TX. Ba Äá»“n", "Bá»‘ Tráº¡ch", "Lá»‡ Thuá»·", "Minh HÃ³a", "Quáº£ng Ninh", "Quáº£ng Tráº¡ch", "TuyÃªn HÃ³a"],
        
        "Quáº£ng Nam": ["TP. Tam Ká»³", "TP. Há»™i An", "TX. Äiá»‡n BÃ n", "Báº¯c TrÃ  My", "Äáº¡i Lá»™c", "Duy XuyÃªn", "Hiá»‡p Äá»©c", "Nam Giang", "Nam TrÃ  My", "NÃ´ng SÆ¡n", "NÃºi ThÃ nh", "PhÃº Ninh", "PhÆ°á»›c SÆ¡n", "Quáº¿ SÆ¡n", "TÃ¢y Giang", "ThÄƒng BÃ¬nh", "TiÃªn PhÆ°á»›c"],
        
        "Quáº£ng NgÃ£i": ["TP. Quáº£ng NgÃ£i", "BÃ¬nh SÆ¡n", "Äá»©c Phá»•", "Ba TÆ¡", "LÃ½ SÆ¡n", "Minh Long", "Má»™ Äá»©c", "NghÄ©a HÃ nh", "SÆ¡n HÃ ", "SÆ¡n TÃ¢y", "SÆ¡n Tá»‹nh", "TÃ¢y TrÃ ", "TrÃ  Bá»“ng", "TÆ° NghÄ©a"],
        
        "Quáº£ng Ninh": ["TP. Háº¡ Long", "TP. MÃ³ng CÃ¡i", "TP. Cáº©m Pháº£", "TP. UÃ´ng BÃ­", "TX. ÄÃ´ng Triá»u", "TX. Quáº£ng YÃªn", "Ba Cháº½", "BÃ¬nh LiÃªu", "CÃ´ TÃ´", "Äáº§m HÃ ", "Háº£i HÃ ", "HoÃ nh Bá»“", "TiÃªn YÃªn", "VÃ¢n Äá»“n"],
        
        "Quáº£ng Trá»‹": ["TP. ÄÃ´ng HÃ ", "TX. Quáº£ng Trá»‹", "Cam Lá»™", "Cá»“n Cá»", "Äa KrÃ´ng", "Gio Linh", "Háº£i LÄƒng", "HÆ°á»›ng HÃ³a", "Triá»‡u Phong", "VÄ©nh Linh"],
        
        "SÃ³c TrÄƒng": ["TP. SÃ³c TrÄƒng", "TX. VÄ©nh ChÃ¢u", "TX. NgÃ£ NÄƒm", "ChÃ¢u ThÃ nh", "CÃ¹ Lao Dung", "Káº¿ SÃ¡ch", "Long PhÃº", "Má»¹ TÃº", "Má»¹ XuyÃªn", "Tháº¡nh Trá»‹", "Tráº§n Äá»"],
        
        "SÆ¡n La": ["TP. SÆ¡n La", "Báº¯c YÃªn", "Mai SÆ¡n", "Má»™c ChÃ¢u", "MÆ°á»ng La", "PhÃ¹ YÃªn", "Quá»³nh Nhai", "SÃ´ng MÃ£", "Sá»‘p Cá»™p", "Thuáº­n ChÃ¢u", "VÃ¢n Há»“", "YÃªn ChÃ¢u"],
        
        "TÃ¢y Ninh": ["TP. TÃ¢y Ninh", "Báº¿n Cáº§u", "ChÃ¢u ThÃ nh", "DÆ°Æ¡ng Minh ChÃ¢u", "GÃ² Dáº§u", "HÃ²a ThÃ nh", "TÃ¢n BiÃªn", "TÃ¢n ChÃ¢u", "Tráº£ng BÃ ng"],
        
        "ThÃ¡i BÃ¬nh": ["TP. ThÃ¡i BÃ¬nh", "ÄÃ´ng HÆ°ng", "HÆ°ng HÃ ", "Kiáº¿n XÆ°Æ¡ng", "Quá»³nh Phá»¥", "ThÃ¡i Thuá»µ", "Tiá»n Háº£i", "VÅ© ThÆ°"],
        
        "ThÃ¡i NguyÃªn": ["TP. ThÃ¡i NguyÃªn", "TP. SÃ´ng CÃ´ng", "TX. Phá»• YÃªn", "Äá»‹nh HÃ³a", "Äáº¡i Tá»«", "Äá»“ng Há»·", "PhÃº BÃ¬nh", "PhÃº LÆ°Æ¡ng", "VÃµ Nhai"],
        
        "Thanh HÃ³a": ["TP. Thanh HÃ³a", "TP. Sáº§m SÆ¡n", "TX. Bá»‰m SÆ¡n", "BÃ¡ ThÆ°á»›c", "Cáº©m Thuá»·", "ÄÃ´ng SÆ¡n", "HÃ  Trung", "Háº­u Lá»™c", "Hoáº±ng HÃ³a", "Lang ChÃ¡nh", "MÆ°á»ng LÃ¡t", "Nga SÆ¡n", "Ngá»c Láº·c", "NhÆ° Thanh", "NhÆ° XuÃ¢n", "NÃ´ng Cá»‘ng", "Quan HÃ³a", "Quan SÆ¡n", "Quáº£ng XÆ°Æ¡ng", "Thiá»‡u HÃ³a", "Thá» XuÃ¢n", "ThÆ°á»ng XuÃ¢n", "TÄ©nh Gia", "Triá»‡u SÆ¡n", "VÄ©nh Lá»™c", "YÃªn Äá»‹nh"],
        
        "TP. Há»“ ChÃ­ Minh": ["Quáº­n 1", "Quáº­n 3", "Quáº­n 4", "Quáº­n 5", "Quáº­n 6", "Quáº­n 7", "Quáº­n 8", "Quáº­n 10", "Quáº­n 11", "Quáº­n 12", "GÃ² Váº¥p", "TÃ¢n BÃ¬nh", "TÃ¢n PhÃº", "BÃ¬nh Tháº¡nh", "PhÃº Nhuáº­n", "Thá»§ Äá»©c", "BÃ¬nh TÃ¢n", "BÃ¬nh ChÃ¡nh", "Cáº§n Giá»", "Cá»§ Chi", "HÃ³c MÃ´n", "NhÃ  BÃ¨"],
        
        "Thá»«a ThiÃªn Huáº¿": ["TP. Huáº¿", "TX. HÆ°Æ¡ng Thá»§y", "TX. HÆ°Æ¡ng TrÃ ", "A LÆ°á»›i", "Nam ÄÃ´ng", "Phong Äiá»n", "PhÃº Lá»™c", "PhÃº Vang", "Quáº£ng Äiá»n"],
        
        "Tiá»n Giang": ["TP. Má»¹ Tho", "TX. GÃ² CÃ´ng", "TX. Cai Láº­y", "CÃ¡i BÃ¨", "ChÃ¢u ThÃ nh", "Chá»£ Gáº¡o", "GÃ² CÃ´ng ÄÃ´ng", "GÃ² CÃ´ng TÃ¢y", "TÃ¢n PhÃº ÄÃ´ng", "TÃ¢n PhÆ°á»›c"],
        
        "TrÃ  Vinh": ["TP. TrÃ  Vinh", "CÃ ng Long", "Cáº§u KÃ¨", "Cáº§u Ngang", "ChÃ¢u ThÃ nh", "DuyÃªn Háº£i", "Tiá»ƒu Cáº§n", "TrÃ  CÃº"],
        
        "TuyÃªn Quang": ["TP. TuyÃªn Quang", "ChiÃªm HÃ³a", "HÃ m YÃªn", "LÃ¢m BÃ¬nh", "Na Hang", "SÆ¡n DÆ°Æ¡ng", "YÃªn SÆ¡n"],
        
        "VÄ©nh Long": ["TP. VÄ©nh Long", "BÃ¬nh Minh", "BÃ¬nh TÃ¢n", "Long Há»“", "Mang ThÃ­t", "Tam BÃ¬nh", "TrÃ  Ã”n", "VÅ©ng LiÃªm"],
        
        "VÄ©nh PhÃºc": ["TP. VÄ©nh YÃªn", "TP. PhÃºc YÃªn", "BÃ¬nh XuyÃªn", "Láº­p Tháº¡ch", "SÃ´ng LÃ´", "Tam Äáº£o", "Tam DÆ°Æ¡ng", "VÄ©nh TÆ°á»ng", "YÃªn Láº¡c"],
        
        "YÃªn BÃ¡i": ["TP. YÃªn BÃ¡i", "TX. NghÄ©a Lá»™", "Lá»¥c YÃªn", "MÃ¹ Cang Cháº£i", "Tráº¡m Táº¥u", "Tráº¥n YÃªn", "VÄƒn Cháº¥n", "VÄƒn YÃªn", "YÃªn BÃ¬nh"]
      };

      // Load cart items
      async function loadCart() {
        try {
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          if (user && user.user_id) {
            const res = await cartAPI.get(user.user_id);
            cart = res.data?.items || res.items || [];
          } else {
            const guestToken = localStorage.getItem('guest_token');
            if (guestToken) {
              const res = await cartAPI.get(guestToken);
              cart = res.data?.items || res.items || [];
            }
          }

          if (cart.length === 0) {
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
          }

          renderCart();
        } catch (error) {
          console.error('Error loading cart:', error);
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
          renderCart();
        }
      }

      function renderCart() {
        const container = document.getElementById('orderItems');
        
        if (cart.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Giá» hÃ ng trá»‘ng</div>';
          updateSummary();
          return;
        }

        container.innerHTML = cart.map(item => `
          <div class="order-item">
            <div class="item-info">
              <h4>${item.name}</h4>
              <p>Sá»‘ lÆ°á»£ng: ${item.quantity}</p>
            </div>
            <div class="item-price">${(item.price * item.quantity).toLocaleString()}â‚«</div>
          </div>
        `).join('');

        updateSummary();
      }

      function updateSummary() {
        subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal - discount + shippingFee;

        document.getElementById('subtotal').textContent = subtotal.toLocaleString() + 'â‚«';
        document.getElementById('totalAmount').textContent = total.toLocaleString() + 'â‚«';
        
        // Update QR amount and order ID
        document.getElementById('qrAmount').textContent = total.toLocaleString() + 'â‚«';
        
        // Generate temporary order ID for QR content
        const tempOrderId = `ORD${Date.now().toString().slice(-6)}`;
        document.getElementById('qrContent').textContent = tempOrderId;
        
        // Update QR code with amount and order info
        updateQRCode(total, tempOrderId);
      }

      // Update QR Code with VietQR API
      function updateQRCode(amount, orderId) {
        const qrUrl = `https://img.vietqr.io/image/${VIETQR_CONFIG.bankId}-${VIETQR_CONFIG.accountNo}-${VIETQR_CONFIG.template}.png?amount=${amount}&addInfo=${encodeURIComponent(orderId)}&accountName=${encodeURIComponent(VIETQR_CONFIG.accountName)}`;
        
        const qrImage = document.getElementById('qrImage');
        qrImage.src = qrUrl;
        
        console.log('âœ… QR Code updated:', qrUrl);
      }

      let appliedDiscount = null;

      window.applyCoupon = async () => {
        const codeInput = document.getElementById('couponCode');
        const code = codeInput.value.trim().toUpperCase();
        
        if (!code) {
          notification.error('Vui lÃ²ng nháº­p mÃ£ giáº£m giÃ¡');
          return;
        }

        // Show loading
        const applyBtn = event.target;
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = 'â³';
        applyBtn.disabled = true;

        try {
          // Validate discount code
          const response = await discountAPI.validateCode(code);
          
          if (!response.success) {
            notification.error(response.message || 'MÃ£ giáº£m giÃ¡ khÃ´ng há»£p lá»‡');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          const discountData = response.data;
          
          // Check if discount is active
          if (!discountData.is_active) {
            notification.error('MÃ£ giáº£m giÃ¡ Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Check usage limit
          if (discountData.usage_limit && discountData.used_count >= discountData.usage_limit) {
            notification.error('MÃ£ giáº£m giÃ¡ Ä‘Ã£ háº¿t lÆ°á»£t sá»­ dá»¥ng');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Check date range
          const now = new Date();
          const startDate = new Date(discountData.start_date);
          const endDate = new Date(discountData.end_date);
          
          if (now < startDate) {
            notification.error('MÃ£ giáº£m giÃ¡ chÆ°a cÃ³ hiá»‡u lá»±c');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }
          
          if (now > endDate) {
            notification.error('MÃ£ giáº£m giÃ¡ Ä‘Ã£ háº¿t háº¡n');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Apply discount
          appliedDiscount = discountData;
          discount = Math.round((subtotal * discountData.percentage) / 100);
          
          // Update UI
          document.getElementById('discountRow').style.display = 'flex';
          document.getElementById('discountAmount').textContent = `-${discount.toLocaleString()}â‚«`;
          
          // Disable input and button
          codeInput.value = code;
          codeInput.disabled = true;
          applyBtn.innerHTML = 'âœ“';
          applyBtn.style.background = '#10b981';
          applyBtn.style.cursor = 'not-allowed';
          
          // Add remove button
          if (!document.getElementById('removeCouponBtn')) {
            const removeBtn = document.createElement('button');
            removeBtn.id = 'removeCouponBtn';
            removeBtn.textContent = 'âœ•';
            removeBtn.className = 'remove-coupon-btn';
            removeBtn.style.cssText = 'margin-left: 8px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;';
            removeBtn.onmouseover = () => removeBtn.style.background = '#dc2626';
            removeBtn.onmouseout = () => removeBtn.style.background = '#ef4444';
            removeBtn.onclick = removeCoupon;
            applyBtn.parentElement.appendChild(removeBtn);
          }
          
          updateSummary();
          notification.success(`âœ¨ ÄÃ£ Ã¡p dá»¥ng mÃ£ giáº£m giÃ¡ ${discountData.percentage}%!`);
          
        } catch (error) {
          console.error('Apply coupon error:', error);
          notification.error(error.message || 'KhÃ´ng thá»ƒ kiá»ƒm tra mÃ£ giáº£m giÃ¡');
          applyBtn.innerHTML = originalText;
          applyBtn.disabled = false;
        }
      };

      function removeCoupon() {
        appliedDiscount = null;
        discount = 0;
        
        // Reset UI
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('couponCode').value = '';
        document.getElementById('couponCode').disabled = false;
        
        const applyBtn = document.querySelector('.apply-btn');
        applyBtn.innerHTML = 'Ãp dá»¥ng';
        applyBtn.disabled = false;
        applyBtn.style.background = '';
        applyBtn.style.cursor = 'pointer';
        
        const removeBtn = document.getElementById('removeCouponBtn');
        if (removeBtn) removeBtn.remove();
        
        updateSummary();
        notification.info('ÄÃ£ xÃ³a mÃ£ giáº£m giÃ¡');
      }

      window.completeCheckout = async () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
          alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ thanh toÃ¡n');
          window.location.href = '/Web/user/pages/login.html';
          return;
        }

        // Validate form
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const city = document.getElementById('city').value;
        const district = document.getElementById('district').value;
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        const notes = document.getElementById('notes').value.trim();

        if (!fullName || !phone || !address || !city || !district) {
          alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin giao hÃ ng');
          return;
        }

        // Validate card details if card payment
        if (paymentMethod === 'card') {
          const cardNumber = document.getElementById('cardNumber').value.trim();
          const cardHolder = document.getElementById('cardHolder').value.trim();
          const cardExpiry = document.getElementById('cardExpiry').value.trim();
          const cardCVV = document.getElementById('cardCVV').value.trim();

          if (!cardNumber || !cardHolder || !cardExpiry || !cardCVV) {
            alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin tháº»');
            return;
          }

          if (!/^\d{13,19}$/.test(cardNumber.replace(/\s/g, ''))) {
            alert('Sá»‘ tháº» khÃ´ng há»£p lá»‡');
            return;
          }

          if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
            alert('NgÃ y háº¿t háº¡n khÃ´ng há»£p lá»‡ (MM/YY)');
            return;
          }

          if (!/^\d{3,4}$/.test(cardCVV)) {
            alert('CVV khÃ´ng há»£p lá»‡');
            return;
          }
        }

        const shippingInfo = {
          fullName,
          phone,
          address: `${address}, ${district}, ${city}`,
          notes
        };

        // Show loading
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span>Äang xá»­ lÃ½...</span>';
        btn.disabled = true;

        try {
          const total = subtotal - discount + shippingFee;

          // Create order
          const orderRes = await orderAPI.create({
            customer_id: user.user_id,
            order_items: cart.map(item => ({
              drug_id: item.drug_id,
              drug_name: item.name,
              quantity: item.quantity,
              price: item.price
            })),
            total_amount: total,
            payment_method: paymentMethod,
            status: paymentMethod === 'online' ? 'Pending' : 'Pending',
            notes: JSON.stringify(shippingInfo)
          });

          const orderId = orderRes.data?.order_id || orderRes.order_id;

          // ğŸ Prepare invoice data vá»›i mÃ£ giáº£m giÃ¡
          const invoiceData = {
            order_id: orderId,
            customer_id: user.user_id,
            items: cart.map(item => ({
              medicine_id: item.drug_id,
              name: item.name,
              quantity: item.quantity,
              unit_price: item.price,
              total_price: item.price * item.quantity
            })),
            subtotal: subtotal,
            discount: discount,
            tax: 0,
            shipping_fee: shippingFee,
            total: total,
            payment_method: paymentMethod,
            status: 'pending'
          };

          // ğŸ ThÃªm mÃ£ giáº£m giÃ¡ náº¿u cÃ³
          if (appliedDiscount) {
            invoiceData.discount_code = appliedDiscount.code;
            console.log('ğŸ Gá»­i mÃ£ giáº£m giÃ¡:', appliedDiscount.code);
          }

          // Create invoice (stock sáº½ tá»± Ä‘á»™ng giáº£m á»Ÿ Ä‘Ã¢y)
          const invoiceRes = await invoiceAPI.create(invoiceData);

          // Clear cart
          try {
            const guestToken = localStorage.getItem('guest_token');
            if (user.user_id) {
              const res = await cartAPI.get(user.user_id);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            } else if (guestToken) {
              const res = await cartAPI.get(guestToken);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            }
          } catch (clearErr) {
            console.warn('Clear cart error:', clearErr);
          }

          localStorage.removeItem('cart');

          // Show success and redirect
          notification.success(
            appliedDiscount 
              ? `Äáº·t hÃ ng thÃ nh cÃ´ng vá»›i mÃ£ giáº£m giÃ¡ ${appliedDiscount.code}! ğŸ‰`
              : 'Äáº·t hÃ ng thÃ nh cÃ´ng! ğŸ‰'
          );

          // Store order info
          localStorage.setItem('lastOrder', JSON.stringify({
            orderId: `ORD-${orderId}`,
            shippingInfo,
            total,
            paymentMethod,
            items: cart,
            discount: appliedDiscount ? {
              code: appliedDiscount.code,
              amount: discount
            } : null
          }));

          setTimeout(() => {
            window.location.href = '/Web/user/pages/order-success.html';
          }, 1500);
        } catch (error) {
          console.error('Checkout error:', error);
          notification.error(error.message || 'CÃ³ lá»—i xáº£y ra khi Ä‘áº·t hÃ ng');
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      };

      // Initialize Vietnam location data
      function initLocationSelects() {
        const citySelect = document.getElementById('city');
        const districtSelect = document.getElementById('district');

        Object.keys(vietnamData).sort().forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });

        citySelect.addEventListener('change', function() {
          const selectedCity = this.value;
          districtSelect.innerHTML = '<option value="">-- Chá»n quáº­n/huyá»‡n --</option>';
          
          if (selectedCity && vietnamData[selectedCity]) {
            districtSelect.disabled = false;
            vietnamData[selectedCity].forEach(district => {
              const option = document.createElement('option');
              option.value = district;
              option.textContent = district;
              districtSelect.appendChild(option);
            });
          } else {
            districtSelect.disabled = true;
          }
        });
      }

      // Handle payment method selection
      document.querySelectorAll('.payment-method input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('active');
          });
          this.closest('.payment-method').classList.add('active');

          const cardDetails = document.getElementById('cardDetails');
          const qrDetails = document.getElementById('qrDetails');

          cardDetails.classList.remove('active');
          qrDetails.classList.remove('active');

          if (this.value === 'card') {
            cardDetails.classList.add('active');
          } else if (this.value === 'online') {
            qrDetails.classList.add('active');
            // Update QR when switching to online payment
            const total = subtotal - discount + shippingFee;
            const tempOrderId = document.getElementById('qrContent').textContent;
            updateQRCode(total, tempOrderId);
          }
        });
      });

      // Card number formatting
      document.getElementById('cardNumber')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });

      // Card expiry formatting
      document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });

      // CVV - numbers only
      document.getElementById('cardCVV')?.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Load user profile and addresses
      function loadUserProfile() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            
            // Auto-fill user info
            if (user.full_name) document.getElementById('fullName').value = user.full_name;
            if (user.phone) document.getElementById('phone').value = user.phone;
            if (user.email) document.getElementById('email').value = user.email;
            
            // Load saved addresses
            const savedAddresses = localStorage.getItem('user_addresses_' + user.user_id);
            if (savedAddresses) {
              const addresses = JSON.parse(savedAddresses);
              
              if (addresses.length > 0) {
                const savedAddressSelect = document.getElementById('savedAddress');
                const savedAddressGroup = document.getElementById('savedAddressGroup');
                
                // Show address dropdown
                savedAddressGroup.style.display = 'block';
                
                // Add options
                addresses.forEach(addr => {
                  const option = document.createElement('option');
                  option.value = addr.id;
                  option.textContent = `${addr.fullName} - ${addr.phone} - ${addr.district}, ${addr.city}`;
                  if (addr.isDefault) option.selected = true;
                  savedAddressSelect.appendChild(option);
                });
                
                // Auto-fill default address
                const defaultAddr = addresses.find(a => a.isDefault);
                if (defaultAddr) {
                  fillAddressForm(defaultAddr);
                }
                
                // Handle address change
                savedAddressSelect.addEventListener('change', (e) => {
                  const selectedId = e.target.value;
                  if (selectedId) {
                    const addr = addresses.find(a => a.id === selectedId);
                    if (addr) fillAddressForm(addr);
                  } else {
                    // Clear form when selecting "new address"
                    document.getElementById('address').value = '';
                    document.getElementById('city').value = '';
                    document.getElementById('district').innerHTML = '<option value="">-- Chá»n quáº­n/huyá»‡n --</option>';
                    document.getElementById('district').disabled = true;
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error loading user profile:', e);
          }
        }
      }

      function fillAddressForm(addr) {
        document.getElementById('fullName').value = addr.fullName || '';
        document.getElementById('phone').value = addr.phone || '';
        document.getElementById('address').value = addr.detail || '';
        
        // Set city
        const citySelect = document.getElementById('city');
        citySelect.value = addr.city || '';
        
        // Trigger city change to load districts
        if (addr.city && vietnamData[addr.city]) {
          const districtSelect = document.getElementById('district');
          districtSelect.innerHTML = '<option value="">-- Chá»n quáº­n/huyá»‡n --</option>';
          districtSelect.disabled = false;
          
          vietnamData[addr.city].forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            if (district === addr.district) option.selected = true;
            districtSelect.appendChild(option);
          });
        }
      }

      // Init
      document.addEventListener('DOMContentLoaded', () => {
        loadCart();
        initLocationSelects();
        loadUserProfile();
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/checkout.css" />
  </head>

  <body>
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <main class="content">
      <div class="checkout-container">
        <div class="checkout-header">
          <h2>üõí Thanh to√°n ƒë∆°n h√†ng</h2>
          <div class="checkout-steps">
            <div class="step active">
              <div class="step-number">1</div>
              <span>Gi·ªè h√†ng</span>
            </div>
            <div class="step-line"></div>
            <div class="step active">
              <div class="step-number">2</div>
              <span>Thanh to√°n</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-number">3</div>
              <span>Ho√†n t·∫•t</span>
            </div>
          </div>
        </div>

        <div class="checkout-content">
          <!-- Left: Form th√¥ng tin -->
          <div class="checkout-form">
            <div class="form-section">
              <h3>üìç Th√¥ng tin giao h√†ng</h3>
              
              <div class="form-group" id="savedAddressGroup" style="display: none; margin-bottom: 1.5rem;">
                <label for="savedAddress" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u</label>
                <select id="savedAddress" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                  <option value="">-- Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="fullName">H·ªç v√† t√™n <span class="required">*</span></label>
                <input type="text" id="fullName" placeholder="Nguy·ªÖn VƒÉn A" required />
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="phone">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                  <input type="tel" id="phone" placeholder="0123456789" required />
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" placeholder="email@example.com" />
                </div>
              </div>

              <div class="form-group">
                <label for="address">ƒê·ªãa ch·ªâ giao h√†ng <span class="required">*</span></label>
                <input type="text" id="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" required />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="city">T·ªânh/Th√†nh ph·ªë <span class="required">*</span></label>
                  <select id="city" required>
                    <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="district">Qu·∫≠n/Huy·ªán <span class="required">*</span></label>
                  <select id="district" required disabled>
                    <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="notes">Ghi ch√∫</label>
                <textarea id="notes" rows="3" placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
              <div class="payment-methods">
                <label class="payment-method active">
                  <input type="radio" name="payment" value="cash" checked />
                  <div class="payment-content">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-info">
                      <h4>Ti·ªÅn m·∫∑t (COD)</h4>
                      <p>Thanh to√°n khi nh·∫≠n h√†ng</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="card" />
                  <div class="payment-content">
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-info">
                      <h4>Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</h4>
                      <p>Visa, Mastercard, JCB</p>
                    </div>
                  </div>
                </label>

                <label class="payment-method">
                  <input type="radio" name="payment" value="online" />
                  <div class="payment-content">
                    <div class="payment-icon">üì±</div>
                    <div class="payment-info">
                      <h4>Chuy·ªÉn kho·∫£n QR</h4>
                      <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                    </div>
                  </div>
                </label>
              </div>

              <!-- Card Payment Details -->
              <div id="cardDetails" class="payment-details">
                <h4>üí≥ Th√¥ng tin th·∫ª</h4>
                
                <div class="card-form-group">
                  <label for="cardNumber">S·ªë th·∫ª <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="cardNumber" 
                    placeholder="1234 5678 9012 3456"
                    maxlength="19"
                    pattern="[0-9\s]*"
                  />
                  <div class="card-icons">
                    <div class="card-icon">VISA</div>
                    <div class="card-icon">MC</div>
                    <div class="card-icon">JCB</div>
                  </div>
                </div>

                <div class="card-form-group">
                  <label for="cardHolder">T√™n ch·ªß th·∫ª <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="cardHolder" 
                    placeholder="NGUYEN VAN A"
                    style="text-transform: uppercase;"
                  />
                </div>

                <div class="card-row">
                  <div class="card-form-group">
                    <label for="cardExpiry">Ng√†y h·∫øt h·∫°n <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="cardExpiry" 
                      placeholder="MM/YY"
                      maxlength="5"
                    />
                  </div>
                  <div class="card-form-group">
                    <label for="cardCVV">CVV <span class="required">*</span></label>
                    <input 
                      type="text" 
                      id="cardCVV" 
                      placeholder="123"
                      maxlength="4"
                      pattern="[0-9]*"
                    />
                  </div>
                </div>

                <div class="security-badge">
                  <span>üîí</span>
                  <span>Giao d·ªãch ƒë∆∞·ª£c m√£ h√≥a SSL 256-bit</span>
                </div>
              </div>

              <!-- QR Code Payment Details -->
              <div id="qrDetails" class="payment-details">
                <h4>üì± Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h4>
                
                <div class="qr-section">
                  <div class="qr-code">
                    <img id="qrImage" 
                         src="https://img.vietqr.io/image/BIDV-8897180034-compact.png" 
                         alt="QR Payment"
                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" />
                  </div>

                  <div class="qr-info">
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Ng√¢n h√†ng:</span>
                        <strong style="color: #1f2937;">BIDV</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">S·ªë t√†i kho·∫£n:</span>
                        <strong style="color: #1f2937;">8897180034</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280; font-size: 0.875rem;">Ch·ªß t√†i kho·∫£n:</span>
                        <strong style="color: #1f2937;">DRUGSTORE PHARMACY</strong>
                      </div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #6b7280; font-size: 0.875rem;">S·ªë ti·ªÅn:</span>
                        <strong id="qrAmount" style="color: #10b981; font-size: 1.25rem;">0‚Ç´</strong>
                      </div>
                    </div>

                    <div style="background: #fef3c7; padding: 0.875rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                      <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                        ‚ö†Ô∏è <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong> <span id="qrContent" style="font-weight: 700; color: #b45309;">ORD-XXXX</span>
                      </p>
                    </div>

                    <div style="background: #dbeafe; padding: 0.875rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                      <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">
                        üí° Qu√©t m√£ QR b·∫±ng app ng√¢n h√†ng c·ªßa b·∫°n ƒë·ªÉ thanh to√°n t·ª± ƒë·ªông v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin
                      </p>
                    </div>
                  </div>
                </div>

                <div class="security-badge" style="margin-top: 1rem;">
                  <span>üîí</span>
                  <span>Thanh to√°n an to√†n qua VietQR</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Order Summary -->
          <div class="order-summary">
            <div class="summary-card">
              <h3>üì¶ ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
              
              <div id="orderItems" class="order-items">
                <div style="text-align: center; padding: 20px; color: #999;">ƒêang t·∫£i...</div>
              </div>

              <div class="summary-row">
                <span>T·∫°m t√≠nh</span>
                <span id="subtotal">0‚Ç´</span>
              </div>

              <div class="summary-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span id="shippingFee">Mi·ªÖn ph√≠</span>
              </div>

              <div class="summary-row discount-row">
                <input type="text" id="couponCode" placeholder="M√£ gi·∫£m gi√°" />
                <button onclick="window.applyCoupon()" class="apply-btn">√Åp d·ª•ng</button>
              </div>

              <div class="summary-row discount-applied" id="discountRow" style="display: none;">
                <span>Gi·∫£m gi√°</span>
                <span id="discountAmount" style="color: #10b981;">-0‚Ç´</span>
              </div>

              <div class="summary-divider"></div>

              <div class="summary-row total">
                <span>T·ªïng thanh to√°n</span>
                <span id="totalAmount">0‚Ç´</span>
              </div>

              <button onclick="window.completeCheckout()" class="checkout-btn">
                <span>ƒê·∫∑t h√†ng</span>
                <span>‚Üí</span>
              </button>

              <div class="security-note">
                üîí Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c b·∫£o m·∫≠t
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { orderAPI, invoiceAPI, discountAPI } from "../../shared/api.js";
      import { cartAPI } from "../../shared/cartApi.js";

      let cart = [];
      let subtotal = 0;
      let discount = 0;
      let shippingFee = 0;

      // VietQR Configuration
      const VIETQR_CONFIG = {
        bankId: 'BIDV',
        accountNo: '8897180034',
        accountName: 'NGUYEN NGUYEN PHUC',
        template: 'compact'
      };

      // D·ªØ li·ªáu 63 t·ªânh/th√†nh ph·ªë Vi·ªát Nam v√† qu·∫≠n/huy·ªán
      const vietnamData = {
        "An Giang": ["TP. Long Xuy√™n", "TP. Ch√¢u ƒê·ªëc", "TX. T√¢n Ch√¢u", "An Ph√∫", "Ch√¢u Ph√∫", "Ch√¢u Th√†nh", "Ch·ª£ M·ªõi", "Ph√∫ T√¢n", "Tho·∫°i S∆°n", "T·ªãnh Bi√™n", "Tri T√¥n"],
        
        "B√† R·ªãa - V≈©ng T√†u": ["TP. V≈©ng T√†u", "TP. B√† R·ªãa", "TX. Ph√∫ M·ªπ", "Ch√¢u ƒê·ª©c", "C√¥n ƒê·∫£o", "ƒê·∫•t ƒê·ªè", "Long ƒêi·ªÅn", "T√¢n Th√†nh", "Xuy√™n M·ªôc"],
        
        "B·∫°c Li√™u": ["TP. B·∫°c Li√™u", "TX. Gi√° Rai", "ƒê√¥ng H·∫£i", "H√≤a B√¨nh", "H·ªìng D√¢n", "Ph∆∞·ªõc Long", "Vƒ©nh L·ª£i"],
        
        "B·∫Øc Giang": ["TP. B·∫Øc Giang", "Hi·ªáp H√≤a", "L·∫°ng Giang", "L·ª•c Nam", "L·ª•c Ng·∫°n", "S∆°n ƒê·ªông", "T√¢n Y√™n", "Vi·ªát Y√™n", "Y√™n D≈©ng", "Y√™n Th·∫ø"],
        
        "B·∫Øc K·∫°n": ["TP. B·∫Øc K·∫°n", "Ba B·ªÉ", "B·∫°ch Th√¥ng", "Ch·ª£ ƒê·ªìn", "Ch·ª£ M·ªõi", "Na R√¨", "Ng√¢n S∆°n", "P√°c N·∫∑m"],
        
        "B·∫Øc Ninh": ["TP. B·∫Øc Ninh", "TX. T·ª´ S∆°n", "Gia B√¨nh", "L∆∞∆°ng T√†i", "Qu·∫ø V√µ", "Thu·∫≠n Th√†nh", "Ti√™n Du", "Y√™n Phong"],
        
        "B·∫øn Tre": ["TP. B·∫øn Tre", "Ba Tri", "B√¨nh ƒê·∫°i", "Ch√¢u Th√†nh", "Ch·ª£ L√°ch", "Gi·ªìng Tr√¥m", "M·ªè C√†y B·∫Øc", "M·ªè C√†y Nam", "Th·∫°nh Ph√∫"],
        
        "B√¨nh D∆∞∆°ng": ["TP. Th·ªß D·∫ßu M·ªôt", "TP. Thu·∫≠n An", "TP. Dƒ© An", "TX. T√¢n Uy√™n", "TX. B·∫øn C√°t", "B√†u B√†ng", "D·∫ßu Ti·∫øng", "Ph√∫ Gi√°o"],
        
        "B√¨nh ƒê·ªãnh": ["TP. Quy Nh∆°n", "TX. An Nh∆°n", "TX. Ho√†i Nh∆°n", "An L√£o", "Ho√†i √Çn", "Ph√∫ C√°t", "Ph√∫ M·ªπ", "T√¢y S∆°n", "Tuy Ph∆∞·ªõc", "V√¢n Canh", "Vƒ©nh Th·∫°nh"],
        
        "B√¨nh Ph∆∞·ªõc": ["TP. ƒê·ªìng Xo√†i", "TX. B√¨nh Long", "TX. Ph∆∞·ªõc Long", "B√π ƒêƒÉng", "B√π ƒê·ªëp", "B√π Gia M·∫≠p", "Ch∆°n Th√†nh", "ƒê·ªìng Ph√∫", "H·ªõn Qu·∫£n", "L·ªôc Ninh", "Ph√∫ Ri·ªÅng"],
        
        "B√¨nh Thu·∫≠n": ["TP. Phan Thi·∫øt", "TX. La Gi", "B·∫Øc B√¨nh", "ƒê·ª©c Linh", "H√†m Thu·∫≠n B·∫Øc", "H√†m Thu·∫≠n Nam", "H√†m T√¢n", "Ph√∫ Qu√≠", "T√°nh Linh", "Tuy Phong"],
        
        "C√† Mau": ["TP. C√† Mau", "C√°i N∆∞·ªõc", "ƒê·∫ßm D∆°i", "NƒÉm CƒÉn", "Ng·ªçc Hi·ªÉn", "Ph√∫ T√¢n", "Th·ªõi B√¨nh", "Tr·∫ßn VƒÉn Th·ªùi", "U Minh"],
        
        "C·∫ßn Th∆°": ["Ninh Ki·ªÅu", "√î M√¥n", "B√¨nh Thu·ª∑", "C√°i RƒÉng", "Th·ªët N·ªët", "Vƒ©nh Th·∫°nh", "C·ªù ƒê·ªè", "Phong ƒêi·ªÅn", "Th·ªõi Lai"],
        
        "Cao B·∫±ng": ["TP. Cao B·∫±ng", "B·∫£o L·∫°c", "B·∫£o L√¢m", "H√† Qu·∫£ng", "H·∫° Lang", "H√≤a An", "Nguy√™n B√¨nh", "Ph·ª•c H√≤a", "Qu·∫£ng Uy√™n", "Th·∫°ch An", "Th√¥ng N√¥ng", "Tr√† Lƒ©nh", "Tr√πng Kh√°nh"],
        
        "ƒê√† N·∫µng": ["H·∫£i Ch√¢u", "Thanh Kh√™", "S∆°n Tr√†", "Ng≈© H√†nh S∆°n", "Li√™n Chi·ªÉu", "C·∫©m L·ªá", "H√≤a Vang", "Ho√†ng Sa"],
        
        "ƒê·∫Øk L·∫Øk": ["TP. Bu√¥n Ma Thu·ªôt", "TX. Bu√¥n H·ªì", "Bu√¥n ƒê√¥n", "C∆∞ Kuin", "C∆∞ M'gar", "Ea H'leo", "Ea Kar", "Ea S√∫p", "Kr√¥ng Ana", "Kr√¥ng B√¥ng", "Kr√¥ng Buk", "Kr√¥ng NƒÉng", "Kr√¥ng P·∫Øc", "L·∫Øk", "M'ƒêr·∫Øk"],
        
        "ƒê·∫Øk N√¥ng": ["TP. Gia Nghƒ©a", "C√∫ J√∫t", "ƒê·∫Øk Glong", "ƒê·∫Øk Mil", "ƒê·∫Øk R'L·∫•p", "ƒê·∫Øk Song", "Kr√¥ng N√¥", "Tuy ƒê·ª©c"],
        
        "ƒêi·ªán Bi√™n": ["TP. ƒêi·ªán Bi√™n Ph·ªß", "TX. M∆∞·ªùng Lay", "ƒêi·ªán Bi√™n", "ƒêi·ªán Bi√™n ƒê√¥ng", "M∆∞·ªùng ·∫¢ng", "M∆∞·ªùng Ch√†", "M∆∞·ªùng Nh√©", "N·∫≠m P·ªì", "T·ªßa Ch√πa", "Tu·∫ßn Gi√°o"],
        
        "ƒê·ªìng Nai": ["TP. Bi√™n H√≤a", "TP. Long Kh√°nh", "C·∫©m M·ªπ", "ƒê·ªãnh Qu√°n", "Long Th√†nh", "Nh∆°n Tr·∫°ch", "T√¢n Ph√∫", "Th·ªëng Nh·∫•t", "Tr·∫£ng Bom", "Vƒ©nh C·ª≠u", "Xu√¢n L·ªôc"],
        
        "ƒê·ªìng Th√°p": ["TP. Cao L√£nh", "TP. Sa ƒê√©c", "TX. H·ªìng Ng·ª±", "Cao L√£nh", "Ch√¢u Th√†nh", "H·ªìng Ng·ª±", "Lai Vung", "L·∫•p V√≤", "Tam N√¥ng", "T√¢n H·ªìng", "Thanh B√¨nh", "Th√°p M∆∞·ªùi"],
        
        "Gia Lai": ["TP. Pleiku", "TX. An Kh√™", "TX. Ayun Pa", "Ch∆∞ PƒÉh", "Ch∆∞ Pr√¥ng", "Ch∆∞ P∆∞h", "Ch∆∞ S√™", "ƒê·∫Øk ƒêoa", "ƒê·∫Øk P∆°", "ƒê·ª©c C∆°", "Ia Grai", "Ia Pa", "K'Bang", "K√¥ng Chro", "Kr√¥ng Pa", "Mang Yang", "Ph√∫ Thi·ªán"],
        
        "H√† Giang": ["TP. H√† Giang", "B·∫Øc M√™", "B·∫Øc Quang", "ƒê·ªìng VƒÉn", "Ho√†ng Su Ph√¨", "M√®o V·∫°c", "Qu·∫£n B·∫°", "Qu·∫£ng B√¨nh", "V·ªã Xuy√™n", "X√≠n M·∫ßn", "Y√™n Minh"],
        
        "H√† Nam": ["TP. Ph·ªß L√Ω", "TX. Duy Ti√™n", "B√¨nh L·ª•c", "Kim B·∫£ng", "L√Ω Nh√¢n", "Thanh Li√™m"],
        
        "H√† N·ªôi": ["Ba ƒê√¨nh", "Ho√†n Ki·∫øm", "Hai B√† Tr∆∞ng", "ƒê·ªëng ƒêa", "T√¢y H·ªì", "C·∫ßu Gi·∫•y", "Thanh Xu√¢n", "Ho√†ng Mai", "Long Bi√™n", "Nam T·ª´ Li√™m", "B·∫Øc T·ª´ Li√™m", "H√† ƒê√¥ng", "TX. S∆°n T√¢y", "Ba V√¨", "Ch∆∞∆°ng M·ªπ", "ƒêan Ph∆∞·ª£ng", "ƒê√¥ng Anh", "Gia L√¢m", "Ho√†i ƒê·ª©c", "M√™ Linh", "M·ªπ ƒê·ª©c", "Ph√∫ Xuy√™n", "Ph√∫c Th·ªç", "Qu·ªëc Oai", "S√≥c S∆°n", "Th·∫°ch Th·∫•t", "Thanh Oai", "Thanh Tr√¨", "Th∆∞·ªùng T√≠n", "·ª®ng H√≤a"],
        
        "H√† Tƒ©nh": ["TP. H√† Tƒ©nh", "TX. H·ªìng Lƒ©nh", "TX. K·ª≥ Anh", "C·∫©m Xuy√™n", "Can L·ªôc", "ƒê·ª©c Th·ªç", "H∆∞∆°ng Kh√™", "H∆∞∆°ng S∆°n", "K·ª≥ Anh", "L·ªôc H√†", "Nghi Xu√¢n", "Th·∫°ch H√†", "V≈© Quang"],
        
        "H·∫£i D∆∞∆°ng": ["TP. H·∫£i D∆∞∆°ng", "TP. Ch√≠ Linh", "TX. Kinh M√¥n", "B√¨nh Giang", "C·∫©m Gi√†ng", "Gia L·ªôc", "Kim Th√†nh", "Nam S√°ch", "Ninh Giang", "Thanh H√†", "Thanh Mi·ªán", "T·ª© K·ª≥"],
        
        "H·∫£i Ph√≤ng": ["H·ªìng B√†ng", "Ng√¥ Quy·ªÅn", "L√™ Ch√¢n", "H·∫£i An", "Ki·∫øn An", "ƒê·ªì S∆°n", "D∆∞∆°ng Kinh", "An D∆∞∆°ng", "An L√£o", "Ki·∫øn Thu·ªµ", "Ti√™n L√£ng", "Vƒ©nh B·∫£o", "C√°t H·∫£i", "B·∫°ch Long Vƒ©"],
        
        "H·∫≠u Giang": ["TP. V·ªã Thanh", "TP. Ng√£ B·∫£y", "TX. Long M·ªπ", "Ch√¢u Th√†nh", "Ch√¢u Th√†nh A", "Long M·ªπ", "Ph·ª•ng Hi·ªáp", "V·ªã Thu·ª∑"],
        
        "H√≤a B√¨nh": ["TP. H√≤a B√¨nh", "Cao Phong", "ƒê√† B·∫Øc", "Kim B√¥i", "K·ª≥ S∆°n", "L·∫°c S∆°n", "L·∫°c Thu·ª∑", "L∆∞∆°ng S∆°n", "Mai Ch√¢u", "T√¢n L·∫°c", "Y√™n Thu·ª∑"],
        
        "H∆∞ng Y√™n": ["TP. H∆∞ng Y√™n", "√Çn Thi", "Kho√°i Ch√¢u", "Kim ƒê·ªông", "M·ªπ H√†o", "Ph√π C·ª´", "Ti√™n L·ªØ", "VƒÉn Giang", "VƒÉn L√¢m", "Y√™n M·ªπ"],
        
        "Kh√°nh H√≤a": ["TP. Nha Trang", "TP. Cam Ranh", "TX. Ninh H√≤a", "Cam L√¢m", "Di√™n Kh√°nh", "Kh√°nh S∆°n", "Kh√°nh Vƒ©nh", "Tr∆∞·ªùng Sa", "V·∫°n Ninh"],
        
        "Ki√™n Giang": ["TP. R·∫°ch Gi√°", "TP. H√† Ti√™n", "TX. Ki√™n L∆∞∆°ng", "An Bi√™n", "An Minh", "Ch√¢u Th√†nh", "Giang Th√†nh", "Gi·ªìng Ri·ªÅng", "G√≤ Quao", "H√≤n ƒê·∫•t", "Ki√™n H·∫£i", "Ph√∫ Qu·ªëc", "T√¢n Hi·ªáp", "U Minh Th∆∞·ª£ng", "Vƒ©nh Thu·∫≠n"],
        
        "Kon Tum": ["TP. Kon Tum", "ƒê·∫Øk Glei", "ƒê·∫Øk H√†", "ƒê·∫Øk T√¥", "Ia H' Drai", "Kon Pl√¥ng", "Kon R·∫´y", "Ng·ªçc H·ªìi", "Sa Th·∫ßy", "Tu M∆° R√¥ng"],
        
        "Lai Ch√¢u": ["TP. Lai Ch√¢u", "M∆∞·ªùng T√®", "N·∫≠m Nh√πn", "Phong Th·ªï", "S√¨n H·ªì", "Tam ƒê∆∞·ªùng", "T√¢n Uy√™n", "Than Uy√™n"],
        
        "L√¢m ƒê·ªìng": ["TP. ƒê√† L·∫°t", "TP. B·∫£o L·ªôc", "B·∫£o L√¢m", "C√°t Ti√™n", "ƒê·∫° Huoai", "ƒê·∫° T·∫ªh", "ƒêam R√¥ng", "Di Linh", "ƒê∆°n D∆∞∆°ng", "ƒê·ª©c Tr·ªçng", "L·∫°c D∆∞∆°ng", "L√¢m H√†"],
        
        "L·∫°ng S∆°n": ["TP. L·∫°ng S∆°n", "B·∫Øc S∆°n", "B√¨nh Gia", "Cao L·ªôc", "Chi LƒÉng", "ƒê√¨nh L·∫≠p", "H·ªØu L≈©ng", "L·ªôc B√¨nh", "Trang ƒê·ªãnh", "VƒÉn L√£ng", "VƒÉn Quan"],
        
        "L√†o Cai": ["TP. L√†o Cai", "B·∫Øc H√†", "B·∫£o Th·∫Øng", "B·∫£o Y√™n", "B√°t X√°t", "M∆∞·ªùng Kh∆∞∆°ng", "Sa Pa", "Si Ma Cai", "VƒÉn B√†n"],
        
        "Long An": ["TP. T√¢n An", "TX. Ki·∫øn T∆∞·ªùng", "B·∫øn L·ª©c", "C·∫ßn ƒê∆∞·ªõc", "C·∫ßn Giu·ªôc", "Ch√¢u Th√†nh", "ƒê·ª©c H√≤a", "ƒê·ª©c Hu·ªá", "M·ªôc H√≥a", "T√¢n H∆∞ng", "T√¢n Th·∫°nh", "T√¢n Tr·ª•", "Th·∫°nh H√≥a", "Th·ªß Th·ª´a", "Vƒ©nh H∆∞ng"],
        
        "Nam ƒê·ªãnh": ["TP. Nam ƒê·ªãnh", "Giao Thu·ª∑", "H·∫£i H·∫≠u", "M·ªπ L·ªôc", "Nam Tr·ª±c", "Nghƒ©a H∆∞ng", "Tr·ª±c Ninh", "V·ª• B·∫£n", "Xu√¢n Tr∆∞·ªùng", "√ù Y√™n"],
        
        "Ngh·ªá An": ["TP. Vinh", "TX. C·ª≠a L√≤", "TX. Th√°i Ho√†", "TX. Ho√†ng Mai", "Anh S∆°n", "Con Cu√¥ng", "Di·ªÖn Ch√¢u", "ƒê√¥ L∆∞∆°ng", "H∆∞ng Nguy√™n", "K·ª≥ S∆°n", "Nam ƒê√†n", "Nghƒ©a ƒê√†n", "Nghi L·ªôc", "Qu·∫ø Phong", "Qu·ª≥ Ch√¢u", "Qu·ª≥ H·ª£p", "Qu·ª≥nh L∆∞u", "T√¢n K·ª≥", "Thanh Ch∆∞∆°ng", "T∆∞∆°ng D∆∞∆°ng", "Y√™n Th√†nh"],
        
        "Ninh B√¨nh": ["TP. Ninh B√¨nh", "TP. Tam ƒêi·ªáp", "Gia Vi·ªÖn", "Hoa L∆∞", "Kim S∆°n", "Nho Quan", "Y√™n Kh√°nh", "Y√™n M√¥"],
        
        "Ninh Thu·∫≠n": ["TP. Phan Rang-Th√°p Ch√†m", "B√°c √Åi", "Ninh H·∫£i", "Ninh Ph∆∞·ªõc", "Ninh S∆°n", "Thu·∫≠n B·∫Øc", "Thu·∫≠n Nam"],
        
        "Ph√∫ Th·ªç": ["TP. Vi·ªát Tr√¨", "TX. Ph√∫ Th·ªç", "C·∫©m Kh√™", "ƒêoan H√πng", "H·∫° Ho√†", "L√¢m Thao", "Ph√π Ninh", "Tam N√¥ng", "T√¢n S∆°n", "Thanh Ba", "Thanh S∆°n", "Thanh Thu·ª∑", "Y√™n L·∫≠p"],
        
        "Ph√∫ Y√™n": ["TP. Tuy H√≤a", "TX. S√¥ng C·∫ßu", "ƒê√¥ng H√≤a", "ƒê·ªìng Xu√¢n", "Ph√∫ H√≤a", "S∆°n H√≤a", "S√¥ng Hinh", "T√¢y H√≤a", "Tuy An"],
        
        "Qu·∫£ng B√¨nh": ["TP. ƒê·ªìng H·ªõi", "TX. Ba ƒê·ªìn", "B·ªë Tr·∫°ch", "L·ªá Thu·ª∑", "Minh H√≥a", "Qu·∫£ng Ninh", "Qu·∫£ng Tr·∫°ch", "Tuy√™n H√≥a"],
        
        "Qu·∫£ng Nam": ["TP. Tam K·ª≥", "TP. H·ªôi An", "TX. ƒêi·ªán B√†n", "B·∫Øc Tr√† My", "ƒê·∫°i L·ªôc", "Duy Xuy√™n", "Hi·ªáp ƒê·ª©c", "Nam Giang", "Nam Tr√† My", "N√¥ng S∆°n", "N√∫i Th√†nh", "Ph√∫ Ninh", "Ph∆∞·ªõc S∆°n", "Qu·∫ø S∆°n", "T√¢y Giang", "ThƒÉng B√¨nh", "Ti√™n Ph∆∞·ªõc"],
        
        "Qu·∫£ng Ng√£i": ["TP. Qu·∫£ng Ng√£i", "B√¨nh S∆°n", "ƒê·ª©c Ph·ªï", "Ba T∆°", "L√Ω S∆°n", "Minh Long", "M·ªô ƒê·ª©c", "Nghƒ©a H√†nh", "S∆°n H√†", "S∆°n T√¢y", "S∆°n T·ªãnh", "T√¢y Tr√†", "Tr√† B·ªìng", "T∆∞ Nghƒ©a"],
        
        "Qu·∫£ng Ninh": ["TP. H·∫° Long", "TP. M√≥ng C√°i", "TP. C·∫©m Ph·∫£", "TP. U√¥ng B√≠", "TX. ƒê√¥ng Tri·ªÅu", "TX. Qu·∫£ng Y√™n", "Ba Ch·∫Ω", "B√¨nh Li√™u", "C√¥ T√¥", "ƒê·∫ßm H√†", "H·∫£i H√†", "Ho√†nh B·ªì", "Ti√™n Y√™n", "V√¢n ƒê·ªìn"],
        
        "Qu·∫£ng Tr·ªã": ["TP. ƒê√¥ng H√†", "TX. Qu·∫£ng Tr·ªã", "Cam L·ªô", "C·ªìn C·ªè", "ƒêa Kr√¥ng", "Gio Linh", "H·∫£i LƒÉng", "H∆∞·ªõng H√≥a", "Tri·ªáu Phong", "Vƒ©nh Linh"],
        
        "S√≥c TrƒÉng": ["TP. S√≥c TrƒÉng", "TX. Vƒ©nh Ch√¢u", "TX. Ng√£ NƒÉm", "Ch√¢u Th√†nh", "C√π Lao Dung", "K·∫ø S√°ch", "Long Ph√∫", "M·ªπ T√∫", "M·ªπ Xuy√™n", "Th·∫°nh Tr·ªã", "Tr·∫ßn ƒê·ªÅ"],
        
        "S∆°n La": ["TP. S∆°n La", "B·∫Øc Y√™n", "Mai S∆°n", "M·ªôc Ch√¢u", "M∆∞·ªùng La", "Ph√π Y√™n", "Qu·ª≥nh Nhai", "S√¥ng M√£", "S·ªëp C·ªôp", "Thu·∫≠n Ch√¢u", "V√¢n H·ªì", "Y√™n Ch√¢u"],
        
        "T√¢y Ninh": ["TP. T√¢y Ninh", "B·∫øn C·∫ßu", "Ch√¢u Th√†nh", "D∆∞∆°ng Minh Ch√¢u", "G√≤ D·∫ßu", "H√≤a Th√†nh", "T√¢n Bi√™n", "T√¢n Ch√¢u", "Tr·∫£ng B√†ng"],
        
        "Th√°i B√¨nh": ["TP. Th√°i B√¨nh", "ƒê√¥ng H∆∞ng", "H∆∞ng H√†", "Ki·∫øn X∆∞∆°ng", "Qu·ª≥nh Ph·ª•", "Th√°i Thu·ªµ", "Ti·ªÅn H·∫£i", "V≈© Th∆∞"],
        
        "Th√°i Nguy√™n": ["TP. Th√°i Nguy√™n", "TP. S√¥ng C√¥ng", "TX. Ph·ªï Y√™n", "ƒê·ªãnh H√≥a", "ƒê·∫°i T·ª´", "ƒê·ªìng H·ª∑", "Ph√∫ B√¨nh", "Ph√∫ L∆∞∆°ng", "V√µ Nhai"],
        
        "Thanh H√≥a": ["TP. Thanh H√≥a", "TP. S·∫ßm S∆°n", "TX. B·ªâm S∆°n", "B√° Th∆∞·ªõc", "C·∫©m Thu·ª∑", "ƒê√¥ng S∆°n", "H√† Trung", "H·∫≠u L·ªôc", "Ho·∫±ng H√≥a", "Lang Ch√°nh", "M∆∞·ªùng L√°t", "Nga S∆°n", "Ng·ªçc L·∫∑c", "Nh∆∞ Thanh", "Nh∆∞ Xu√¢n", "N√¥ng C·ªëng", "Quan H√≥a", "Quan S∆°n", "Qu·∫£ng X∆∞∆°ng", "Thi·ªáu H√≥a", "Th·ªç Xu√¢n", "Th∆∞·ªùng Xu√¢n", "Tƒ©nh Gia", "Tri·ªáu S∆°n", "Vƒ©nh L·ªôc", "Y√™n ƒê·ªãnh"],
        
        "TP. H·ªì Ch√≠ Minh": ["Qu·∫≠n 1", "Qu·∫≠n 3", "Qu·∫≠n 4", "Qu·∫≠n 5", "Qu·∫≠n 6", "Qu·∫≠n 7", "Qu·∫≠n 8", "Qu·∫≠n 10", "Qu·∫≠n 11", "Qu·∫≠n 12", "G√≤ V·∫•p", "T√¢n B√¨nh", "T√¢n Ph√∫", "B√¨nh Th·∫°nh", "Ph√∫ Nhu·∫≠n", "Th·ªß ƒê·ª©c", "B√¨nh T√¢n", "B√¨nh Ch√°nh", "C·∫ßn Gi·ªù", "C·ªß Chi", "H√≥c M√¥n", "Nh√† B√®"],
        
        "Th·ª´a Thi√™n Hu·∫ø": ["TP. Hu·∫ø", "TX. H∆∞∆°ng Th·ªßy", "TX. H∆∞∆°ng Tr√†", "A L∆∞·ªõi", "Nam ƒê√¥ng", "Phong ƒêi·ªÅn", "Ph√∫ L·ªôc", "Ph√∫ Vang", "Qu·∫£ng ƒêi·ªÅn"],
        
        "Ti·ªÅn Giang": ["TP. M·ªπ Tho", "TX. G√≤ C√¥ng", "TX. Cai L·∫≠y", "C√°i B√®", "Ch√¢u Th√†nh", "Ch·ª£ G·∫°o", "G√≤ C√¥ng ƒê√¥ng", "G√≤ C√¥ng T√¢y", "T√¢n Ph√∫ ƒê√¥ng", "T√¢n Ph∆∞·ªõc"],
        
        "Tr√† Vinh": ["TP. Tr√† Vinh", "C√†ng Long", "C·∫ßu K√®", "C·∫ßu Ngang", "Ch√¢u Th√†nh", "Duy√™n H·∫£i", "Ti·ªÉu C·∫ßn", "Tr√† C√∫"],
        
        "Tuy√™n Quang": ["TP. Tuy√™n Quang", "Chi√™m H√≥a", "H√†m Y√™n", "L√¢m B√¨nh", "Na Hang", "S∆°n D∆∞∆°ng", "Y√™n S∆°n"],
        
        "Vƒ©nh Long": ["TP. Vƒ©nh Long", "B√¨nh Minh", "B√¨nh T√¢n", "Long H·ªì", "Mang Th√≠t", "Tam B√¨nh", "Tr√† √în", "V≈©ng Li√™m"],
        
        "Vƒ©nh Ph√∫c": ["TP. Vƒ©nh Y√™n", "TP. Ph√∫c Y√™n", "B√¨nh Xuy√™n", "L·∫≠p Th·∫°ch", "S√¥ng L√¥", "Tam ƒê·∫£o", "Tam D∆∞∆°ng", "Vƒ©nh T∆∞·ªùng", "Y√™n L·∫°c"],
        
        "Y√™n B√°i": ["TP. Y√™n B√°i", "TX. Nghƒ©a L·ªô", "L·ª•c Y√™n", "M√π Cang Ch·∫£i", "Tr·∫°m T·∫•u", "Tr·∫•n Y√™n", "VƒÉn Ch·∫•n", "VƒÉn Y√™n", "Y√™n B√¨nh"]
      };

      // Load cart items
      async function loadCart() {
        try {
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          if (user && user.user_id) {
            const res = await cartAPI.get(user.user_id);
            cart = res.data?.items || res.items || [];
          } else {
            const guestToken = localStorage.getItem('guest_token');
            if (guestToken) {
              const res = await cartAPI.get(guestToken);
              cart = res.data?.items || res.items || [];
            }
          }

          if (cart.length === 0) {
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
          }

          renderCart();
        } catch (error) {
          console.error('Error loading cart:', error);
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
          renderCart();
        }
      }

      function renderCart() {
        const container = document.getElementById('orderItems');
        
        if (cart.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Gi·ªè h√†ng tr·ªëng</div>';
          updateSummary();
          return;
        }

        container.innerHTML = cart.map(item => `
          <div class="order-item">
            <div class="item-info">
              <h4>${item.name}</h4>
              <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
            </div>
            <div class="item-price">${(item.price * item.quantity).toLocaleString()}‚Ç´</div>
          </div>
        `).join('');

        updateSummary();
      }

      function updateSummary() {
        subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal - discount + shippingFee;

        document.getElementById('subtotal').textContent = subtotal.toLocaleString() + '‚Ç´';
        document.getElementById('totalAmount').textContent = total.toLocaleString() + '‚Ç´';
        
        // Update QR amount and order ID
        document.getElementById('qrAmount').textContent = total.toLocaleString() + '‚Ç´';
        
        // Generate temporary order ID for QR content
        const tempOrderId = `ORD${Date.now().toString().slice(-6)}`;
        document.getElementById('qrContent').textContent = tempOrderId;
        
        // Update QR code with amount and order info
        updateQRCode(total, tempOrderId);
      }

      // Update QR Code with VietQR API
      function updateQRCode(amount, orderId) {
        const qrUrl = `https://img.vietqr.io/image/${VIETQR_CONFIG.bankId}-${VIETQR_CONFIG.accountNo}-${VIETQR_CONFIG.template}.png?amount=${amount}&addInfo=${encodeURIComponent(orderId)}&accountName=${encodeURIComponent(VIETQR_CONFIG.accountName)}`;
        
        const qrImage = document.getElementById('qrImage');
        qrImage.src = qrUrl;
        
        console.log('‚úÖ QR Code updated:', qrUrl);
      }

      let appliedDiscount = null;

      window.applyCoupon = async () => {
        const codeInput = document.getElementById('couponCode');
        const code = codeInput.value.trim().toUpperCase();
        
        if (!code) {
          notification.error('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°');
          return;
        }

        // Show loading
        const applyBtn = event.target;
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = '‚è≥';
        applyBtn.disabled = true;

        try {
          // Validate discount code
          const response = await discountAPI.validateCode(code);
          
          if (!response.success) {
            notification.error(response.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          const discountData = response.data;
          
          // Check if discount is active
          if (!discountData.is_active) {
            notification.error('M√£ gi·∫£m gi√° ƒë√£ b·ªã v√¥ hi·ªáu h√≥a');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Check usage limit
          if (discountData.usage_limit && discountData.used_count >= discountData.usage_limit) {
            notification.error('M√£ gi·∫£m gi√° ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Check date range
          const now = new Date();
          const startDate = new Date(discountData.start_date);
          const endDate = new Date(discountData.end_date);
          
          if (now < startDate) {
            notification.error('M√£ gi·∫£m gi√° ch∆∞a c√≥ hi·ªáu l·ª±c');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }
          
          if (now > endDate) {
            notification.error('M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n');
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
            return;
          }

          // Apply discount
          appliedDiscount = discountData;
          discount = Math.round((subtotal * discountData.percentage) / 100);
          
          // Update UI
          document.getElementById('discountRow').style.display = 'flex';
          document.getElementById('discountAmount').textContent = `-${discount.toLocaleString()}‚Ç´`;
          
          // Disable input and button
          codeInput.value = code;
          codeInput.disabled = true;
          applyBtn.innerHTML = '‚úì';
          applyBtn.style.background = '#10b981';
          applyBtn.style.cursor = 'not-allowed';
          
          // Add remove button
          if (!document.getElementById('removeCouponBtn')) {
            const removeBtn = document.createElement('button');
            removeBtn.id = 'removeCouponBtn';
            removeBtn.textContent = '‚úï';
            removeBtn.className = 'remove-coupon-btn';
            removeBtn.style.cssText = 'margin-left: 8px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;';
            removeBtn.onmouseover = () => removeBtn.style.background = '#dc2626';
            removeBtn.onmouseout = () => removeBtn.style.background = '#ef4444';
            removeBtn.onclick = removeCoupon;
            applyBtn.parentElement.appendChild(removeBtn);
          }
          
          updateSummary();
          notification.success(`‚ú® ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${discountData.percentage}%!`);
          
        } catch (error) {
          console.error('Apply coupon error:', error);
          notification.error(error.message || 'Kh√¥ng th·ªÉ ki·ªÉm tra m√£ gi·∫£m gi√°');
          applyBtn.innerHTML = originalText;
          applyBtn.disabled = false;
        }
      };

      function removeCoupon() {
        appliedDiscount = null;
        discount = 0;
        
        // Reset UI
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('couponCode').value = '';
        document.getElementById('couponCode').disabled = false;
        
        const applyBtn = document.querySelector('.apply-btn');
        applyBtn.innerHTML = '√Åp d·ª•ng';
        applyBtn.disabled = false;
        applyBtn.style.background = '';
        applyBtn.style.cursor = 'pointer';
        
        const removeBtn = document.getElementById('removeCouponBtn');
        if (removeBtn) removeBtn.remove();
        
        updateSummary();
        notification.info('ƒê√£ x√≥a m√£ gi·∫£m gi√°');
      }

      window.completeCheckout = async () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n');
          window.location.href = '/Web/user/pages/login.html';
          return;
        }

        // Validate form
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const city = document.getElementById('city').value;
        const district = document.getElementById('district').value;
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        const notes = document.getElementById('notes').value.trim();

        if (!fullName || !phone || !address || !city || !district) {
          alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng');
          return;
        }

        // Validate card details if card payment
        if (paymentMethod === 'card') {
          const cardNumber = document.getElementById('cardNumber').value.trim();
          const cardHolder = document.getElementById('cardHolder').value.trim();
          const cardExpiry = document.getElementById('cardExpiry').value.trim();
          const cardCVV = document.getElementById('cardCVV').value.trim();

          if (!cardNumber || !cardHolder || !cardExpiry || !cardCVV) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin th·∫ª');
            return;
          }

          if (!/^\d{13,19}$/.test(cardNumber.replace(/\s/g, ''))) {
            alert('S·ªë th·∫ª kh√¥ng h·ª£p l·ªá');
            return;
          }

          if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
            alert('Ng√†y h·∫øt h·∫°n kh√¥ng h·ª£p l·ªá (MM/YY)');
            return;
          }

          if (!/^\d{3,4}$/.test(cardCVV)) {
            alert('CVV kh√¥ng h·ª£p l·ªá');
            return;
          }
        }

        const shippingInfo = {
          fullName,
          phone,
          address: `${address}, ${district}, ${city}`,
          notes
        };

        // Show loading
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span>ƒêang x·ª≠ l√Ω...</span>';
        btn.disabled = true;

        try {
          const total = subtotal - discount + shippingFee;

          // Create order
          const orderRes = await orderAPI.create({
            customer_id: user.user_id,
            order_items: cart.map(item => ({
              drug_id: item.drug_id,
              drug_name: item.name,
              quantity: item.quantity,
              price: item.price
            })),
            total_amount: total,
            payment_method: paymentMethod,
            status: paymentMethod === 'online' ? 'Pending' : 'Pending',
            notes: JSON.stringify(shippingInfo)
          });

          const orderId = orderRes.data?.order_id || orderRes.order_id;

          // Create invoice
          const invoiceRes = await invoiceAPI.create({
            order_id: orderId,
            customer_id: user.user_id,
            items: cart.map(item => ({
              medicine_id: item.drug_id,
              name: item.name,
              quantity: item.quantity,
              unit_price: item.price,
              total_price: item.price * item.quantity
            })),
            subtotal: subtotal,
            discount: discount,
            tax: 0,
            shipping_fee: shippingFee,
            total: total,
            payment_method: paymentMethod,
            status: 'pending'
          });

          // Clear cart
          try {
            const guestToken = localStorage.getItem('guest_token');
            if (user.user_id) {
              const res = await cartAPI.get(user.user_id);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            } else if (guestToken) {
              const res = await cartAPI.get(guestToken);
              if (res.data?._id || res._id) {
                await cartAPI.clear(res.data?._id || res._id);
              }
            }
          } catch (clearErr) {
            console.warn('Clear cart error:', clearErr);
          }

          localStorage.removeItem('cart');

          // Store order info and redirect
          localStorage.setItem('lastOrder', JSON.stringify({
            orderId: `ORD-${orderId}`,
            shippingInfo,
            total,
            paymentMethod,
            items: cart
          }));

          window.location.href = '/Web/user/pages/order-success.html';
        } catch (error) {
          console.error('Checkout error:', error);
          alert('‚ùå L·ªói khi ƒë·∫∑t h√†ng: ' + error.message);
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      };

      // Initialize Vietnam location data
      function initLocationSelects() {
        const citySelect = document.getElementById('city');
        const districtSelect = document.getElementById('district');

        Object.keys(vietnamData).sort().forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });

        citySelect.addEventListener('change', function() {
          const selectedCity = this.value;
          districtSelect.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
          
          if (selectedCity && vietnamData[selectedCity]) {
            districtSelect.disabled = false;
            vietnamData[selectedCity].forEach(district => {
              const option = document.createElement('option');
              option.value = district;
              option.textContent = district;
              districtSelect.appendChild(option);
            });
          } else {
            districtSelect.disabled = true;
          }
        });
      }

      // Handle payment method selection
      document.querySelectorAll('.payment-method input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('active');
          });
          this.closest('.payment-method').classList.add('active');

          const cardDetails = document.getElementById('cardDetails');
          const qrDetails = document.getElementById('qrDetails');

          cardDetails.classList.remove('active');
          qrDetails.classList.remove('active');

          if (this.value === 'card') {
            cardDetails.classList.add('active');
          } else if (this.value === 'online') {
            qrDetails.classList.add('active');
            // Update QR when switching to online payment
            const total = subtotal - discount + shippingFee;
            const tempOrderId = document.getElementById('qrContent').textContent;
            updateQRCode(total, tempOrderId);
          }
        });
      });

      // Card number formatting
      document.getElementById('cardNumber')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });

      // Card expiry formatting
      document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });

      // CVV - numbers only
      document.getElementById('cardCVV')?.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Load user profile and addresses
      function loadUserProfile() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            
            // Auto-fill user info
            if (user.full_name) document.getElementById('fullName').value = user.full_name;
            if (user.phone) document.getElementById('phone').value = user.phone;
            if (user.email) document.getElementById('email').value = user.email;
            
            // Load saved addresses
            const savedAddresses = localStorage.getItem('user_addresses_' + user.user_id);
            if (savedAddresses) {
              const addresses = JSON.parse(savedAddresses);
              
              if (addresses.length > 0) {
                const savedAddressSelect = document.getElementById('savedAddress');
                const savedAddressGroup = document.getElementById('savedAddressGroup');
                
                // Show address dropdown
                savedAddressGroup.style.display = 'block';
                
                // Add options
                addresses.forEach(addr => {
                  const option = document.createElement('option');
                  option.value = addr.id;
                  option.textContent = `${addr.fullName} - ${addr.phone} - ${addr.district}, ${addr.city}`;
                  if (addr.isDefault) option.selected = true;
                  savedAddressSelect.appendChild(option);
                });
                
                // Auto-fill default address
                const defaultAddr = addresses.find(a => a.isDefault);
                if (defaultAddr) {
                  fillAddressForm(defaultAddr);
                }
                
                // Handle address change
                savedAddressSelect.addEventListener('change', (e) => {
                  const selectedId = e.target.value;
                  if (selectedId) {
                    const addr = addresses.find(a => a.id === selectedId);
                    if (addr) fillAddressForm(addr);
                  } else {
                    // Clear form when selecting "new address"
                    document.getElementById('address').value = '';
                    document.getElementById('city').value = '';
                    document.getElementById('district').innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
                    document.getElementById('district').disabled = true;
                  }
                });
              }
            }
          } catch (e) {
            console.error('Error loading user profile:', e);
          }
        }
      }

      function fillAddressForm(addr) {
        document.getElementById('fullName').value = addr.fullName || '';
        document.getElementById('phone').value = addr.phone || '';
        document.getElementById('address').value = addr.detail || '';
        
        // Set city
        const citySelect = document.getElementById('city');
        citySelect.value = addr.city || '';
        
        // Trigger city change to load districts
        if (addr.city && vietnamData[addr.city]) {
          const districtSelect = document.getElementById('district');
          districtSelect.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
          districtSelect.disabled = false;
          
          vietnamData[addr.city].forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            if (district === addr.district) option.selected = true;
            districtSelect.appendChild(option);
          });
        }
      }

      // Init
      document.addEventListener('DOMContentLoaded', () => {
        loadCart();
        initLocationSelects();
        loadUserProfile();
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi·ªè h√†ng - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
  </head>

  <body>
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <main class="content">
      <section class="drugs-header">
        <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>
        <p>Ki·ªÉm tra s·∫£n ph·∫©m, ƒëi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng v√† ti·∫øn h√†nh thanh to√°n.</p>
      </section>

      <section class="cart-section" style="padding: 30px 10%; display: flex; gap: 30px;">
        <div style="flex: 1;">
          <div id="cartItems" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
            <div style="text-align: center; padding: 40px; color: #666;">ƒêang t·∫£i gi·ªè h√†ng...</div>
          </div>
        </div>

        <aside style="width: 350px;">
          <div style="background: #fff; border: 1px solid #c5e8c8; padding: 20px; border-radius: 10px;">
            <h4 style="margin: 0 0 15px; color: #155724;">T√≥m t·∫Øt ƒë∆°n h√†ng</h4>
            
            <div style="display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              <span>T·∫°m t√≠nh</span>
              <span style="font-weight: 700; color: #1b5e20;" id="subtotal">0‚Ç´</span>
            </div>

            <div style="display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
              <span>Mi·ªÖn ph√≠</span>
            </div>

            <div style="display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
              <span>M√£ gi·∫£m gi√°</span>
              <input type="text" id="discountCode" placeholder="Nh·∫≠p m√£" style="width: 120px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;" />
            </div>

            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 15px 0;">
              <span style="font-size: 1.1rem; font-weight: 800; color: #155724;">T·ªïng thanh to√°n</span>
              <span style="font-size: 1.2rem; font-weight: 800; color: #d32f2f;" id="total">0‚Ç´</span>
            </div>

            <button onclick="window.checkout()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">üí≥ Ti·∫øn h√†nh thanh to√°n</button>
            <a href="/Web/user/pages/drugs.html" style="display: block; width: 100%; padding: 10px; text-align: center; margin-top: 10px; color: #155724; text-decoration: none; border: 1px solid #155724; border-radius: 6px;">Ti·∫øp t·ª•c mua s·∫Øm</a>
          </div>
        </aside>
      </section>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { orderAPI, invoiceAPI } from "../../shared/api.js";
      import { cartAPI } from "../../shared/cartApi.js";

      let serverCart = null; // when using server-side cart, store the cart object here

      async function renderCart() {
        const container = document.getElementById('cartItems');

        // prefer server cart if available
        let cart = [];
        if (serverCart && Array.isArray(serverCart.items)) {
          cart = serverCart.items.map(i => ({ ...i, _id: serverCart._id }));
        } else {
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
        }

        if (cart.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: #666; margin: 0 0 20px;">Gi·ªè h√†ng tr·ªëng</p>
              <a href="/Web/user/pages/drugs.html" class="btn-primary" style="display: inline-block; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 6px;">Mua s·∫Øm ngay</a>
            </div>
          `;
          document.getElementById('subtotal').textContent = '0‚Ç´';
          document.getElementById('total').textContent = '0‚Ç´';
          return;
        }

        let subtotal = 0;
        container.innerHTML = cart.map((item, idx) => {
          const total = (item.price || 0) * (item.quantity || 0);
          subtotal += total;
          return `
            <div style="display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee; align-items: center;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 5px;">${item.name}</h4>
                <p style="margin: 0; color: #666; font-size: 14px;">Gi√°: ${item.price.toLocaleString()}‚Ç´</p>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="window.changeQty(${idx}, -1)" style="width: 30px; height: 30px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px;">‚àí</button>
                <input type="number" value="${item.quantity}" min="1" style="width: 50px; text-align: center; border: 1px solid #ccc; padding: 5px; border-radius: 4px;" readonly />
                <button onclick="window.changeQty(${idx}, 1)" style="width: 30px; height: 30px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px;">+</button>
              </div>
              <span style="font-weight: 700; min-width: 100px; text-align: right;">${total.toLocaleString()}‚Ç´</span>
              <button onclick="window.removeFromCart(${idx})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">X√≥a</button>
            </div>
          `;
        }).join('');

        document.getElementById('subtotal').textContent = subtotal.toLocaleString() + '‚Ç´';
        document.getElementById('total').textContent = subtotal.toLocaleString() + '‚Ç´';
      }

      window.changeQty = async (idx, delta) => {
        // if using server cart, call API to update
        if (serverCart && serverCart._id) {
          try {
            const item = serverCart.items[idx];
            const newQty = Math.max(1, Number(item.quantity) + delta);
            await cartAPI.updateItem(serverCart._id, { drug_id: item.drug_id, quantity: newQty });
            // reload server cart
            const res = await cartAPI.get(serverCart.user_id ? serverCart.user_id : serverCart.guest_token);
            serverCart = res.data || res;
            renderCart();
            return;
          } catch (err) {
            console.warn('Update server cart failed, falling back', err);
          }
        }
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart[idx].quantity = Math.max(1, cart[idx].quantity + delta);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      };

      window.removeFromCart = async (idx) => {
        if (serverCart && serverCart._id) {
          try {
            const item = serverCart.items[idx];
            await cartAPI.removeItem(serverCart._id, { drug_id: item.drug_id });
            const res = await cartAPI.get(serverCart.user_id ? serverCart.user_id : serverCart.guest_token);
            serverCart = res.data || res;
            renderCart();
            return;
          } catch (err) {
            console.warn('Remove server cart item failed, falling back', err);
          }
        }
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(idx, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      };

      window.checkout = async () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n');
          window.location.href = '/Web/user/pages/login.html';
          return;
        }

        // prefer server cart
        let cart = [];
        if (serverCart && Array.isArray(serverCart.items)) {
          cart = serverCart.items;
        } else {
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
        }

        if (cart.length === 0) {
          alert('Gi·ªè h√†ng tr·ªëng');
          return;
        }

        // Redirect to checkout page
        window.location.href = '/Web/user/pages/checkout.html';
      };

      // load server cart first if possible
      document.addEventListener('DOMContentLoaded', async () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        // Try to load from server
        let serverSuccess = false;
        try {
          if (user && user.user_id) {
            const res = await cartAPI.get(user.user_id);
            serverCart = res.data || res;
            serverSuccess = true;
          } else {
            const guest = localStorage.getItem('guest_token');
            if (guest) {
              const res = await cartAPI.get(guest);
              serverCart = res.data || res;
              serverSuccess = true;
            }
          }
        } catch (err) {
          console.warn('Load server cart failed, using localStorage', err);
          serverCart = null;
        }
        
        // If server cart is empty but localStorage has items, use localStorage
        const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
        if ((!serverCart || !serverCart.items || serverCart.items.length === 0) && localCart.length > 0) {
          console.log('Server cart empty, using localStorage cart');
          serverCart = null;
        }
        
        await renderCart();
      });
    </script>
  </body>
</html>

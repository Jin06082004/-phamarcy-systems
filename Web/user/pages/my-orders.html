<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê∆°n h√†ng c·ªßa t√¥i - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <style>
      .orders-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 2rem;
      }

      .orders-header {
        text-align: center;
        margin-bottom: 50px;
      }

      .orders-header h2 {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--text-dark);
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-green), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .orders-header p {
        font-size: 1.125rem;
        color: var(--text-muted);
      }

      .filter-tabs {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 3rem;
        flex-wrap: wrap;
      }

      .filter-tab {
        padding: 0.75rem 2rem;
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        transition: var(--transition);
      }

      .filter-tab:hover {
        border-color: var(--primary-green);
        color: var(--primary-green);
      }

      .filter-tab.active {
        background: linear-gradient(135deg, var(--primary-green), var(--primary-dark));
        color: white;
        border-color: var(--primary-green);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      .orders-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .order-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid var(--border);
        transition: var(--transition);
      }

      .order-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border);
        margin-bottom: 1.5rem;
      }

      .order-id {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--text-dark);
      }

      .order-date {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      .order-status {
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .status-processing {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-completed {
        background: #d1fae5;
        color: #065f46;
      }

      .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
      }

      .order-items {
        margin: 1.5rem 0;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 12px;
        margin-bottom: 0.75rem;
      }

      .item-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
      }

      .item-info p {
        font-size: 0.875rem;
        color: var(--text-muted);
      }

      .item-price {
        font-weight: 700;
        color: var(--primary-green);
        font-size: 1rem;
      }

      .order-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
      }

      .order-total {
        font-size: 1.5rem;
        font-weight: 800;
        color: #ef4444;
      }

      .order-actions {
        display: flex;
        gap: 1rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        font-size: 0.95rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-green), var(--primary-dark));
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      }

      .btn-secondary {
        background: white;
        color: var(--primary-green);
        border: 2px solid var(--primary-green);
      }

      .btn-secondary:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #fca5a5;
      }

      .btn-danger:hover {
        background: #fca5a5;
        color: white;
        transform: translateY(-2px);
      }

      .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      }

      .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
      }

      .empty-state p {
        font-size: 1rem;
        color: var(--text-muted);
        margin-bottom: 2rem;
      }

      .loading {
        text-align: center;
        padding: 60px;
        font-size: 1.25rem;
        color: var(--text-muted);
      }

      .order-timeline {
        display: flex;
        justify-content: space-between;
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: #f9fafb;
        border-radius: 12px;
        position: relative;
      }

      .order-timeline::before {
        content: '';
        position: absolute;
        top: 35px;
        left: 10%;
        right: 10%;
        height: 3px;
        background: var(--border);
        z-index: 0;
      }

      .timeline-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
      }

      .timeline-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .timeline-step.completed .timeline-icon {
        background: var(--primary-green);
        border-color: var(--primary-green);
        color: white;
      }

      .timeline-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 600;
        text-align: center;
      }

      .timeline-step.completed .timeline-label {
        color: var(--primary-green);
      }

      @media (max-width: 768px) {
        .order-header,
        .order-footer {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }

        .order-actions {
          width: 100%;
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .order-timeline {
          flex-direction: column;
          gap: 1rem;
        }

        .order-timeline::before {
          display: none;
        }

        .filter-tabs {
          width: 100%;
        }

        .filter-tab {
          flex: 1;
          text-align: center;
        }
      }
    </style>
  </head>

  <body>
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <main class="content">
      <div class="orders-container">
        <div class="orders-header">
          <h2>üì¶ ƒê∆°n h√†ng c·ªßa t√¥i</h2>
          <p>Theo d√µi v√† qu·∫£n l√Ω c√°c ƒë∆°n h√†ng c·ªßa b·∫°n</p>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" data-status="all">T·∫•t c·∫£</button>
          <button class="filter-tab" data-status="Pending">Ch·ªù x·ª≠ l√Ω</button>
          <button class="filter-tab" data-status="Processing">ƒêang x·ª≠ l√Ω</button>
          <button class="filter-tab" data-status="Completed">Ho√†n th√†nh</button>
          <button class="filter-tab" data-status="Cancelled">ƒê√£ h·ªßy</button>
        </div>

        <div id="ordersList" class="orders-list">
          <div class="loading">‚è≥ ƒêang t·∫£i ƒë∆°n h√†ng...</div>
        </div>
      </div>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { orderAPI } from "../../shared/api.js";
      import { initAdminSecretButton } from "../../shared/adminButton.js";

      // üîí Kh·ªüi t·∫°o n√∫t admin ·∫©n
      initAdminSecretButton('/Web/admin/orders.html');

      let allOrders = [];
      let currentFilter = 'all';

      // Load user's orders
      async function loadOrders() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
          window.location.href = '/Web/user/pages/login.html';
          return;
        }

        try {
          const response = await orderAPI.getMyOrders();
          const orders = response.data || response;
          
          allOrders = Array.isArray(orders) ? orders : [];
          allOrders.sort((a, b) => new Date(b.order_date) - new Date(a.order_date));
          
          renderOrders(allOrders);
        } catch (error) {
          console.error('Load orders error:', error);
          document.getElementById('ordersList').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ùå</div>
              <h3>L·ªói t·∫£i d·ªØ li·ªáu</h3>
              <p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
            </div>
          `;
        }
      }

      function renderOrders(orders) {
        const container = document.getElementById('ordersList');

        if (orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì¶</div>
              <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
              <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y b·∫Øt ƒë·∫ßu mua s·∫Øm ngay!</p>
              <a href="/Web/user/pages/drugs.html" class="btn btn-primary">Kh√°m ph√° s·∫£n ph·∫©m</a>
            </div>
          `;
          return;
        }

        container.innerHTML = orders.map(order => {
          const statusClass = `status-${order.status.toLowerCase()}`;
          const statusText = {
            'Pending': 'Ch·ªù x·ª≠ l√Ω',
            'Processing': 'ƒêang x·ª≠ l√Ω',
            'Completed': 'Ho√†n th√†nh',
            'Cancelled': 'ƒê√£ h·ªßy'
          }[order.status] || order.status;

          const orderDate = new Date(order.order_date).toLocaleString('vi-VN');
          const total = order.total_amount || order.order_items.reduce((sum, item) => sum + item.price * item.quantity, 0);

          return `
            <div class="order-card">
              <div class="order-header">
                <div>
                  <div class="order-id">üõí ƒê∆°n h√†ng #ORD-${order.order_id}</div>
                  <div class="order-date">üìÖ ${orderDate}</div>
                </div>
                <div class="order-status ${statusClass}">${statusText}</div>
              </div>

              <div class="order-timeline">
                <div class="timeline-step ${['Pending', 'Processing', 'Completed'].includes(order.status) ? 'completed' : ''}">
                  <div class="timeline-icon">üìù</div>
                  <span class="timeline-label">ƒê√£ ƒë·∫∑t</span>
                </div>
                <div class="timeline-step ${['Processing', 'Completed'].includes(order.status) ? 'completed' : ''}">
                  <div class="timeline-icon">üì¶</div>
                  <span class="timeline-label">ƒêang chu·∫©n b·ªã</span>
                </div>
                <div class="timeline-step ${order.status === 'Completed' ? 'completed' : ''}">
                  <div class="timeline-icon">üöö</div>
                  <span class="timeline-label">ƒêang giao</span>
                </div>
                <div class="timeline-step ${order.status === 'Completed' ? 'completed' : ''}">
                  <div class="timeline-icon">‚úì</div>
                  <span class="timeline-label">Ho√†n th√†nh</span>
                </div>
              </div>

              <div class="order-items">
                ${order.order_items.map(item => `
                  <div class="order-item">
                    <div class="item-info">
                      <h4>${item.drug_name}</h4>
                      <p>S·ªë l∆∞·ª£ng: ${item.quantity} √ó ${item.price.toLocaleString()}‚Ç´</p>
                    </div>
                    <div class="item-price">${(item.price * item.quantity).toLocaleString()}‚Ç´</div>
                  </div>
                `).join('')}
              </div>

              <div class="order-footer">
                <div>
                  <div style="color: var(--text-muted); margin-bottom: 0.25rem;">T·ªïng thanh to√°n</div>
                  <div class="order-total">${total.toLocaleString()}‚Ç´</div>
                </div>
                <div class="order-actions">
                  ${order.status === 'Pending' ? `
                    <button class="btn btn-danger" onclick="window.cancelOrder(${order.order_id})">H·ªßy ƒë∆°n</button>
                  ` : ''}
                  <button class="btn btn-secondary" onclick="window.viewOrderDetail(${order.order_id})">Chi ti·∫øt</button>
                  ${order.status === 'Completed' ? `
                    <button class="btn btn-primary" onclick="window.reorder(${order.order_id})">Mua l·∫°i</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Filter orders
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          currentFilter = this.dataset.status;
          const filtered = currentFilter === 'all' 
            ? allOrders 
            : allOrders.filter(order => order.status === currentFilter);
          
          renderOrders(filtered);
        });
      });

      // Cancel order - v·ªõi th√¥ng b√°o ho√†n tr·∫£ stock
      window.cancelOrder = async (orderId) => {
        const order = allOrders.find(o => o.order_id === orderId);
        if (!order) return;

        // Hi·ªÉn th·ªã th√¥ng tin ƒë∆°n h√†ng s·∫Ω b·ªã h·ªßy
        const itemsList = order.order_items.map(item => 
          `‚Ä¢ ${item.drug_name} x${item.quantity}`
        ).join('\n');

        const confirmMessage = `B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?\n\n` +
          `M√£ ƒë∆°n: ORD-${orderId}\n` +
          `T·ªïng ti·ªÅn: ${order.total_amount.toLocaleString()}‚Ç´\n\n` +
          `S·∫£n ph·∫©m:\n${itemsList}\n\n` +
          `‚úÖ S·ªë l∆∞·ª£ng thu·ªëc s·∫Ω ƒë∆∞·ª£c ho√†n tr·∫£ v√†o kho`;

        if (!confirm(confirmMessage)) return;

        try {
          const response = await orderAPI.updateStatus(orderId, 'Cancelled');
          
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
          showNotification('success', '‚úÖ ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng! S·ªë l∆∞·ª£ng thu·ªëc ƒë√£ ƒë∆∞·ª£c ho√†n tr·∫£.');
          
          // Reload orders
          await loadOrders();
        } catch (error) {
          console.error('Cancel order error:', error);
          showNotification('error', '‚ùå Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng: ' + (error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
        }
      };

      // Helper function ƒë·ªÉ hi·ªÉn th·ªã notification
      function showNotification(type, message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 16px 24px;
          background: ${type === 'success' ? '#10b981' : '#ef4444'};
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
          max-width: 400px;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // View order detail
      window.viewOrderDetail = (orderId) => {
        const order = allOrders.find(o => o.order_id === orderId);
        if (!order) return;

        // Parse shipping info from notes
        let shippingInfo = {};
        try {
          shippingInfo = JSON.parse(order.notes || '{}');
        } catch (e) {
          shippingInfo = { fullName: 'N/A', phone: 'N/A', address: 'N/A' };
        }

        const statusText = {
          'Pending': 'Ch·ªù x·ª≠ l√Ω',
          'Processing': 'ƒêang x·ª≠ l√Ω',
          'Completed': 'Ho√†n th√†nh',
          'Cancelled': 'ƒê√£ h·ªßy'
        }[order.status] || order.status;

        const paymentText = {
          'cash': 'üíµ Ti·ªÅn m·∫∑t (COD)',
          'card': 'üí≥ Th·∫ª t√≠n d·ª•ng',
          'online': 'üì± V√≠ ƒëi·ªán t·ª≠'
        }[order.payment_method] || order.payment_method;

        const itemsHTML = order.order_items.map(item => `
          <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px;">
            <div>
              <strong style="color: #1f2937;">${item.drug_name}</strong>
              <div style="font-size: 0.875rem; color: #6b7280;">S·ªë l∆∞·ª£ng: ${item.quantity} √ó ${item.price.toLocaleString()}‚Ç´</div>
            </div>
            <div style="font-weight: 700; color: #10b981;">${(item.price * item.quantity).toLocaleString()}‚Ç´</div>
          </div>
        `).join('');

        const detailHTML = `
          <div style="text-align: left;">
            <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
              <div style="font-size: 1.5rem; font-weight: 800; margin-bottom: 8px;">ƒê∆°n h√†ng #ORD-${order.order_id}</div>
              <div style="font-size: 0.95rem; opacity: 0.9;">üìÖ ${new Date(order.order_date).toLocaleString('vi-VN')}</div>
            </div>

            <div style="margin-bottom: 20px;">
              <h4 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 12px;">üì¶ S·∫£n ph·∫©m</h4>
              ${itemsHTML}
            </div>

            <div style="margin-bottom: 20px;">
              <h4 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 12px;">üìç Th√¥ng tin giao h√†ng</h4>
              <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                <div style="margin-bottom: 8px;"><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${shippingInfo.fullName || 'N/A'}</div>
                <div style="margin-bottom: 8px;"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${shippingInfo.phone || 'N/A'}</div>
                <div style="margin-bottom: 8px;"><strong>ƒê·ªãa ch·ªâ:</strong> ${shippingInfo.address || 'N/A'}</div>
                ${shippingInfo.notes ? `<div><strong>Ghi ch√∫:</strong> ${shippingInfo.notes}</div>` : ''}
              </div>
            </div>

            <div style="margin-bottom: 20px;">
              <h4 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 12px;">üí∞ Thanh to√°n</h4>
              <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Tr·∫°ng th√°i:</span>
                  <strong style="color: #10b981;">${statusText}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Ph∆∞∆°ng th·ª©c:</span>
                  <strong>${paymentText}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid #e5e7eb;">
                  <span style="font-size: 1.125rem; font-weight: 700;">T·ªïng c·ªông:</span>
                  <strong style="font-size: 1.5rem; color: #ef4444;">${order.total_amount.toLocaleString()}‚Ç´</strong>
                </div>
              </div>
            </div>
          </div>
        `;

        notification.show({
          type: 'info',
          title: 'üìã Chi ti·∫øt ƒë∆°n h√†ng',
          message: detailHTML,
          confirmText: 'ƒê√≥ng'
        });
      };

      // Reorder
      window.reorder = async (orderId) => {
        const order = allOrders.find(o => o.order_id === orderId);
        if (!order) return;

        // Add items to cart
        const cart = order.order_items.map(item => ({
          drug_id: item.drug_id,
          name: item.drug_name,
          price: item.price,
          quantity: item.quantity
        }));

        localStorage.setItem('cart', JSON.stringify(cart));
        alert('‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng');
        window.location.href = '/Web/user/pages/cart.html';
      };

      document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
  </body>
</html>

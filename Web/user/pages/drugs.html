<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh s√°ch thu·ªëc - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <!-- Import components -->
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="content">
      <section class="drugs-header">
        <h2>Danh s√°ch thu·ªëc</h2>
        <p>T√¨m ki·∫øm, xem th√¥ng tin v√† ch·ªçn mua thu·ªëc m·ªôt c√°ch d·ªÖ d√†ng.</p>
      </section>

      <section class="drugs-section" style="padding: 30px 10%;">
        <div class="filter-bar" style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm thu·ªëc..." style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;" />
          <select id="categorySelect" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; min-width: 150px;">
            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
          </select>
        </div>

        <div class="drug-list" id="drugList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;">
          <div style="grid-column: 1/-1; text-align: center; padding: 40px;">ƒêang t·∫£i thu·ªëc...</div>
        </div>
      </section>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { drugAPI, categoryAPI } from "../../shared/api.js";

      let allDrugs = [];
      let allCategories = [];

      async function loadDrugs() {
        try {
          const res = await drugAPI.getAll();
          allDrugs = Array.isArray(res) ? res : (res.data || []);
          renderDrugs(allDrugs);
        } catch (error) {
          console.error("L·ªói t·∫£i thu·ªëc:", error);
          document.getElementById('drugList').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
        }
      }

      async function loadCategories() {
        try {
          const res = await categoryAPI.getAll();
          allCategories = Array.isArray(res) ? res : (res.data || []);
          
          const select = document.getElementById('categorySelect');
          allCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.category_id;
            opt.textContent = cat.name;
            select.appendChild(opt);
          });
        } catch (error) {
          console.error("L·ªói t·∫£i danh m·ª•c:", error);
        }
      }

      function renderDrugs(drugs) {
        const list = document.getElementById('drugList');
        if (!drugs || drugs.length === 0) {
          list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Kh√¥ng t√¨m th·∫•y thu·ªëc</div>';
          return;
        }
    
        list.innerHTML = drugs.map(drug => {
          let imgTag = "";
          if (drug.image) {
            const isAbsolute = drug.image.startsWith("http") || drug.image.startsWith("/");
            const src = isAbsolute ? drug.image : ("/shared/" + drug.image.replace(/^(\.\/|\/)+/, ""));
            imgTag = `<img src="${src}" alt="${drug.name}" style="width:100%; height:180px; object-fit:cover;" />`;
          }
          return `
            <div class="drug-card" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.3s;">
              ${imgTag}
              <div style="padding: 15px;">
                <h3 style="margin: 0 0 8px; font-size: 16px; color: #155724;">${drug.name}</h3>
                <p style="margin: 0 0 10px; font-size: 13px; color: #666;">${drug.description || 'Thu·ªëc ch·∫•t l∆∞·ª£ng cao'}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                  <span style="font-size: 18px; font-weight: bold; color: #d32f2f;">${drug.price ? drug.price.toLocaleString() : '0'}‚Ç´</span>
                  <span style="font-size: 12px; color: ${drug.stock > 0 ? '#4CAF50' : '#f44336'};">${drug.stock > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}</span>
                </div>
                <button onclick="window.addToCart(${drug.drug_id}, '${drug.name}', ${drug.price})" ${drug.stock <= 0 ? 'disabled' : ''} style="width: 100%; padding: 10px; background: ${drug.stock > 0 ? '#4CAF50' : '#ccc'}; color: white; border: none; border-radius: 4px; cursor: ${drug.stock > 0 ? 'pointer' : 'not-allowed'}; font-weight: 600; margin-top: 10px;">
                  ${drug.stock > 0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng'}
                </button>
              </div>
            </div>
          `;
        }).join('');
      }

      window.addToCart = (drugId, name, price) => {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const existing = cart.find(item => item.drug_id === drugId);
        
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ drug_id: drugId, name, price, quantity: 1 });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        alert(`‚úÖ ƒê√£ th√™m "${name}" v√†o gi·ªè h√†ng`);
      };

      document.getElementById('searchInput').addEventListener('keyup', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDrugs.filter(drug => 
          drug.name.toLowerCase().includes(keyword) || 
          (drug.description && drug.description.toLowerCase().includes(keyword))
        );
        renderDrugs(filtered);
      });

      document.getElementById('categorySelect').addEventListener('change', (e) => {
        const categoryId = e.target.value;
        if (!categoryId) {
          renderDrugs(allDrugs);
        } else {
          const filtered = allDrugs.filter(drug => drug.category_id == categoryId);
          renderDrugs(filtered);
        }
      });

      loadDrugs();
      loadCategories();
    </script>
  </body>
</html>

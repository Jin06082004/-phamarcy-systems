<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh s√°ch thu·ªëc - DrugStore</title>
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <!-- Import components -->
    <div data-include="../../shared/components/topbar.html"></div>
    <div data-include="../../shared/components/navbar.html"></div>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="content">
      <section class="drugs-header">
        <h2>Danh s√°ch thu·ªëc</h2>
        <p>T√¨m ki·∫øm, xem th√¥ng tin v√† ch·ªçn mua thu·ªëc m·ªôt c√°ch d·ªÖ d√†ng.</p>
      </section>

      <section class="drugs-section" style="padding: 30px 10%;">
        <div class="filter-bar" style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm thu·ªëc..." style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;" />
          <select id="categorySelect" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; min-width: 150px;">
            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
          </select>
        </div>

        <div class="drug-list" id="drugList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;">
          <div style="grid-column: 1/-1; text-align: center; padding: 40px;">ƒêang t·∫£i thu·ªëc...</div>
        </div>
      </section>
    </main>

    <div data-include="../../shared/components/footer.html"></div>

    <script src="../../shared/include.js"></script>
    <script src="../../shared/notification.js"></script>
    <script type="module">
      import { drugAPI, categoryAPI } from "../../shared/api.js";
      import { initAdminSecretButton } from "../../shared/adminButton.js";

      initAdminSecretButton('/Web/admin/drugs.html');

      let allDrugs = [];
      let categories = [];

      async function loadCategories() {
        try {
          const res = await categoryAPI.getAll();
          categories = Array.isArray(res) ? res : (res.data || []);
          const categorySelect = document.getElementById('categorySelect');
          categorySelect.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>' +
            categories.map(cat => `<option value="${cat.category_id}">${cat.name}</option>`).join('');
        } catch (error) {
          console.error('L·ªói khi t·∫£i danh m·ª•c:', error);
        }
      }

      async function loadDrugs() {
        try {
          const res = await drugAPI.getAll();
          allDrugs = Array.isArray(res) ? res : (res.data || []);
          
          // Ki·ªÉm tra xem c√≥ t·ª´ kh√≥a t√¨m ki·∫øm t·ª´ URL kh√¥ng
          const urlParams = new URLSearchParams(window.location.search);
          const searchKeyword = urlParams.get('search');
          
          if (searchKeyword) {
            // T·ª± ƒë·ªông ƒëi·ªÅn t·ª´ kh√≥a v√†o √¥ t√¨m ki·∫øm
            document.getElementById('searchInput').value = searchKeyword;
            // L·ªçc k·∫øt qu·∫£ theo t·ª´ kh√≥a
            const filtered = allDrugs.filter(drug => 
              drug.name.toLowerCase().includes(searchKeyword.toLowerCase()) || 
              (drug.description && drug.description.toLowerCase().includes(searchKeyword.toLowerCase()))
            );
            renderDrugs(filtered);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o k·∫øt qu·∫£ t√¨m ki·∫øm
            const header = document.querySelector('.drugs-header p');
            if (filtered.length === 0) {
              header.textContent = `Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${searchKeyword}"`;
              header.style.color = '#ef4444';
            } else {
              header.textContent = `T√¨m th·∫•y ${filtered.length} k·∫øt qu·∫£ cho "${searchKeyword}"`;
              header.style.color = '#10b981';
            }
          } else {
            renderDrugs(allDrugs);
          }
        } catch (error) {
          console.error('L·ªói khi t·∫£i thu·ªëc:', error);
          document.getElementById('drugList').innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: red; padding: 40px;">
              <p style="font-size: 1.2rem; margin-bottom: 10px;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</p>
              <p style="font-size: 0.9rem; color: #666;">${error.message}</p>
              <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üîÑ Th·ª≠ l·∫°i
              </button>
            </div>
          `;
        }
      }

      function renderDrugs(drugs) {
        const drugList = document.getElementById('drugList');
        
        if (!drugs || drugs.length === 0) {
          drugList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Kh√¥ng t√¨m th·∫•y thu·ªëc n√†o</div>';
          return;
        }

        drugList.innerHTML = drugs.map(drug => {
          const escapedName = (drug.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const escapedDesc = (drug.description || 'Thu·ªëc ch·∫•t l∆∞·ª£ng cao').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          
          let imgTag = '<div style="width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;">üíä<div style="font-size:0.875rem;margin-top:0.5rem;color:#666;">Ch∆∞a c√≥ ·∫£nh</div></div>';
          
          if (drug.image) {
            const isAbsolute = drug.image.startsWith('http') || drug.image.startsWith('/');
            const src = isAbsolute ? drug.image : ('/shared/' + drug.image.replace(/^(\.\/|\/)+/, ''));
            imgTag = `<img src="${src}" alt="${escapedName}" style="width:100%;height:180px;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
              <div style="display:none;width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;position:absolute;top:0;left:0;">üíä<div style="font-size:0.875rem;margin-top:0.5rem;color:#666;">·∫¢nh l·ªói</div></div>`;
          }
          
          return `
            <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
              <div style="position: relative; width: 100%; height: 180px;">
                ${imgTag}
              </div>
              <div style="padding: 15px;">
                <h4 style="margin: 0 0 8px; color: #155724;">${escapedName}</h4>
                <p style="margin: 0 0 10px; font-size: 13px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapedDesc}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: bold; color: #d32f2f; font-size: 1.1rem;">${(drug.price || 0).toLocaleString()}‚Ç´</span>
                  <button onclick="window.addToCart(${drug.drug_id})" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                    üõí Th√™m
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      window.addToCart = (drugId) => {
        const drug = allDrugs.find(d => d.drug_id === drugId);
        if (!drug) {
          showNotification('Kh√¥ng t√¨m th·∫•y thu·ªëc', 'error');
          return;
        }
        
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const existing = cart.find(item => item.drug_id === drugId);
        
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ 
            drug_id: drug.drug_id, 
            name: drug.name, 
            price: drug.price, 
            quantity: 1 
          });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        showNotification(`‚úÖ ƒê√£ th√™m "${drug.name}" v√†o gi·ªè h√†ng`, 'success');
      };

      document.getElementById('searchInput').addEventListener('keyup', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDrugs.filter(drug => 
          drug.name.toLowerCase().includes(keyword) || 
          (drug.description && drug.description.toLowerCase().includes(keyword))
        );
        renderDrugs(filtered);
      });

      document.getElementById('categorySelect').addEventListener('change', (e) => {
        const categoryId = e.target.value;
        // Clear search input when filtering by category
        document.getElementById('searchInput').value = '';
        // Clear URL search parameter
        window.history.replaceState({}, '', '/Web/user/pages/drugs.html');
        
        if (!categoryId) {
          renderDrugs(allDrugs);
        } else {
          const filtered = allDrugs.filter(drug => drug.category_id == categoryId);
          renderDrugs(filtered);
        }
      });

      loadDrugs();
      loadCategories();
    </script>
  </body>
</html>

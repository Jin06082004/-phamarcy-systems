<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drug-Store ‚Äî Nh√† thu·ªëc tr·ª±c tuy·∫øn</title>
    <link rel="stylesheet" href="css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  </head>

  <body>
  <!-- Import components -->
  <div data-include="../shared/components/topbar.html"></div>
  <div data-include="../shared/components/navbar.html"></div>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="content">
      <section class="hero">
        <div class="hero-text">
          <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi <span>DrugStore</span>!</h2>
          <p>
            N∆°i b·∫°n c√≥ th·ªÉ mua thu·ªëc, vitamin, th·ª±c ph·∫©m ch·ª©c nƒÉng v√† s·∫£n ph·∫©m chƒÉm s√≥c s·ª©c kh·ªèe uy t√≠n, an to√†n, ti·ªán l·ª£i.
          </p>
          <button class="btn-primary">Kh√°m ph√° ngay</button>
        </div>
        <div class="hero-image">
          <img src="../../shared/images/hero-banner.png" alt="S·∫£n ph·∫©m thu·ªëc" onerror="this.style.display='none'" />
        </div>
      </section>

      <section class="featured">
        <h3>S·∫£n ph·∫©m n·ªïi b·∫≠t</h3>
        <div class="product-grid" id="featured-products">
          <div style="grid-column:1/-1;text-align:center;padding:40px;">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
        </div>
      </section>
    </main>

  <div data-include="../shared/components/footer.html"></div>

    <script src="../shared/include.js"></script>
    <script src="../shared/notification.js"></script>
    <script type="module">
      import { drugAPI } from '../shared/api.js';
      import { cartAPI } from '../shared/cartApi.js';

      // ensure there's a guest token for anonymous carts
      function ensureGuestToken() {
        let t = localStorage.getItem('guest_token');
        if (!t) {
          t = 'guest_' + Math.random().toString(36).slice(2, 12);
          localStorage.setItem('guest_token', t);
        }
        return t;
      }

      async function loadFeatured() {
        try {
          const res = await drugAPI.getAll();
          const products = Array.isArray(res) ? res : (res.data || []);
          const container = document.getElementById('featured-products');
          if (!products.length) {
            container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;">Ch∆∞a c√≥ s·∫£n ph·∫©m</div>';
            return;
          }

          container.innerHTML = products.slice(0, 9).map(p => {
              let imgTag = '<div style="width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;">üíä<div style="font-size:0.875rem;margin-top:0.5rem;color:#666;">Ch∆∞a c√≥ ·∫£nh</div></div>';
              if (p.image) {
                const isAbsolute = p.image.startsWith('http') || p.image.startsWith('/');
                const src = isAbsolute ? p.image : ('/shared/' + p.image.replace(/^(\.\/|\/)+/, ''));
                imgTag = `<img src="${src}" alt="${p.name}" style="width:100%;height:180px;object-fit:cover;background:#f5f5f5;" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\"width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;\\">üíä<div style=\\"font-size:0.875rem;margin-top:0.5rem;color:#666;\\">·∫¢nh l·ªói</div></div>';" />`;
              }
              return `
              <div class="product-card">
                ${imgTag}
                <h4>${p.name}</h4>
                <p>${p.description || ''}</p>
                <div>
                  <div style="text-align:center;margin:12px 0;font-weight:800;font-size:1.4rem;color:#d32f2f;">${(p.price||0).toLocaleString()}‚Ç´</div>
                  <button data-id="${p.drug_id}" data-name="${p.name}" data-price="${p.price||0}">üõí Th√™m v√†o gi·ªè</button>
                </div>
              </div>
            `;
          }).join('');

           // attach handlers
           container.querySelectorAll('button[data-id]').forEach(btn => {
             btn.addEventListener('click', async (e) => {
               const id = Number(btn.dataset.id);
               const name = btn.dataset.name;
               const price = Number(btn.dataset.price || 0);
               
               // Always add to localStorage for immediate availability
               fallbackAdd(id, name, price);
               
               // Also try server cart in background
               try {
                 const guestToken = ensureGuestToken();
                 await cartAPI.add({ guest_token: guestToken, item: { drug_id: id, name, price, quantity: 1 } });
               } catch (err) {
                 console.warn('Server cart add failed, using localStorage only', err);
               }
             });
           });
         } catch (error) {
           document.getElementById('featured-products').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
         }
       }

      function fallbackAdd(id, name, price) {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const idx = cart.findIndex(i => Number(i.drug_id) === Number(id));
        if (idx >= 0) cart[idx].quantity = Number(cart[idx].quantity) + 1;
        else cart.push({ drug_id: id, name, price, quantity: 1 });
        localStorage.setItem('cart', JSON.stringify(cart));
        // ensure guest token exists for later merge
        ensureGuestToken();
        alert(`ƒê√£ th√™m ${name} v√†o gi·ªè`);
      }

      document.addEventListener('DOMContentLoaded', loadFeatured);
    </script>
  </body>
</html>

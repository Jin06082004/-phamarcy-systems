<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drug-Store ‚Äî Nh√† thu·ªëc tr·ª±c tuy·∫øn</title>
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="../shared/css/chatbox.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>

  <body>
  <!-- Import components -->
  <div data-include="../shared/components/topbar.html"></div>
  <div data-include="../shared/components/navbar.html"></div>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="content">
      <section class="hero">
        <div class="hero-text">
          <h2 style="font-family: 'Montserrat', sans-serif;">üéÅ <span>M√£ Gi·∫£m Gi√° Hot</span> - ƒê·ª´ng B·ªè L·ª°!</h2>
          <p style="margin-bottom: 20px; font-family: 'Montserrat', sans-serif;">
            C√°c ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i ƒë·∫∑c bi·ªát ƒëang di·ªÖn ra - √Åp d·ª•ng ngay ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i!
          </p>
          <div id="promotions-container" style="display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 100%; margin: 0 auto;">
            <div style="text-align: center; color: #666; font-family: 'Montserrat', sans-serif;">ƒêang t·∫£i khuy·∫øn m√£i...</div>
          </div>
          <button class="btn-primary" style="margin-top: 25px; font-family: 'Montserrat', sans-serif;" onclick="window.location.href='pages/promotions.html'">
            üéâ Kh√°m ph√° c√°c khuy·∫øn m√£i kh√°c
          </button>
        </div>
      </section>

      <section class="featured">
        <h3>S·∫£n ph·∫©m n·ªïi b·∫≠t</h3>
        <div class="product-grid" id="featured-products">
          <div style="grid-column:1/-1;text-align:center;padding:40px;">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
        </div>
      </section>
    </main>

  <div data-include="../shared/components/footer.html"></div>

    <script src="../shared/include.js"></script>
    <script src="../shared/notification.js"></script>
    <script type="module">
      import { drugAPI } from '../shared/api.js';
      import { cartAPI } from '../shared/cartApi.js';
      import { couponAPI } from '../shared/couponApi.js';
      import { initAdminSecretButton } from '../shared/adminButton.js';

      // üîí Kh·ªüi t·∫°o n√∫t admin ·∫©n - ch·ªâ hi·ªÉn th·ªã v·ªõi admin
      initAdminSecretButton('/Web/admin/index.html');

      // Load active promotions
      async function loadPromotions() {
        try {
          const res = await couponAPI.getActivePromotions();
          const promotions = res.data || [];
          const container = document.getElementById('promotions-container');
          
          if (!promotions.length) {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 12px; font-family: \'Montserrat\', sans-serif;">Hi·ªán kh√¥ng c√≥ khuy·∫øn m√£i ƒë·∫∑c bi·ªát</div>';
            return;
          }

          container.innerHTML = promotions.map(promo => {
            const badge = promo.isExpiringSoon 
              ? `<span style="background: #ff5252; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; font-family: 'Montserrat', sans-serif;">‚è∞ S·∫Øp h·∫øt h·∫°n</span>`
              : `<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; font-family: 'Montserrat', sans-serif;">‚ö° Hot</span>`;
            
            const remaining = promo.usage_limit > 0 
              ? `<span style="font-size: 0.85rem; color: #666; font-family: 'Montserrat', sans-serif;">C√≤n ${promo.usage_limit - promo.used_count}/${promo.usage_limit} l∆∞·ª£t</span>`
              : `<span style="font-size: 0.85rem; color: #4caf50; font-family: 'Montserrat', sans-serif;">‚ôæÔ∏è Kh√¥ng gi·ªõi h·∫°n</span>`;

            return `
              <div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,248,255,0.95) 100%); 
                          border-radius: 16px; 
                          padding: 20px; 
                          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                          border-left: 5px solid #26a69a;
                          display: flex;
                          align-items: center;
                          gap: 20px;
                          transition: transform 0.2s, box-shadow 0.2s;
                          cursor: pointer;
                          font-family: 'Montserrat', sans-serif;"
                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(0,0,0,0.15)';"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.1)';">
                
                <div style="flex-shrink: 0; background: linear-gradient(135deg, #26a69a 0%, #1e8a7f 100%); 
                            color: white; 
                            padding: 20px; 
                            border-radius: 12px; 
                            text-align: center;
                            min-width: 120px;
                            font-family: 'Montserrat', sans-serif;">
                  <div style="font-size: 2.5rem; font-weight: 800; line-height: 1;">${promo.percentage}%</div>
                  <div style="font-size: 0.75rem; margin-top: 5px; opacity: 0.9;">GI·∫¢M GI√Å</div>
                </div>
                
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    ${badge}
                    <span style="font-size: 0.85rem; color: #ff6b6b; font-family: 'Montserrat', sans-serif;">C√≤n ${promo.daysLeft} ng√†y</span>
                  </div>
                  <div style="font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 6px; font-family: 'Montserrat', sans-serif;">
                    ${promo.description}
                  </div>
                  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <code style="background: #fff; 
                                 padding: 8px 16px; 
                                 border-radius: 8px; 
                                 font-size: 1.05rem; 
                                 font-weight: 700; 
                                 color: #26a69a;
                                 border: 2px dashed #26a69a;
                                 letter-spacing: 1px;
                                 font-family: 'Courier New', monospace;">${promo.code}</code>
                    ${remaining}
                  </div>
                </div>
                
                <button onclick="navigator.clipboard.writeText('${promo.code}'); alert('ƒê√£ copy m√£: ${promo.code}');"
                        style="background: #26a69a; 
                               color: white; 
                               border: none; 
                               padding: 12px 24px; 
                               border-radius: 8px; 
                               font-weight: 600; 
                               cursor: pointer;
                               white-space: nowrap;
                               transition: background 0.2s;
                               font-family: 'Montserrat', sans-serif;"
                        onmouseover="this.style.background='#1e8a7f';"
                        onmouseout="this.style.background='#26a69a';">
                  üìã Copy m√£
                </button>
              </div>
            `;
          }).join('');
          
        } catch (error) {
          console.error('Load promotions error:', error);
          document.getElementById('promotions-container').innerHTML = 
            '<div style="text-align: center; color: #ff5252; padding: 20px; font-family: \'Montserrat\', sans-serif;">Kh√¥ng th·ªÉ t·∫£i khuy·∫øn m√£i</div>';
        }
      }

      // ensure there's a guest token for anonymous carts
      function ensureGuestToken() {
        let t = localStorage.getItem('guest_token');
        if (!t) {
          t = 'guest_' + Math.random().toString(36).slice(2, 12);
          localStorage.setItem('guest_token', t);
        }
        return t;
      }

      async function loadFeatured() {
        try {
          const res = await drugAPI.getAll();
          const products = Array.isArray(res) ? res : (res.data || []);
          const container = document.getElementById('featured-products');
          if (!products.length) {
            container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;">Ch∆∞a c√≥ s·∫£n ph·∫©m</div>';
            return;
          }

          container.innerHTML = products.slice(0, 9).map(p => {
              const escapedName = (p.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              const escapedDesc = (p.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              
              let imgTag = '<div style="width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;">üíä<div style="font-size:0.875rem;margin-top:0.5rem;color:#666;">Ch∆∞a c√≥ ·∫£nh</div></div>';
              
              if (p.image) {
                const isAbsolute = p.image.startsWith('http') || p.image.startsWith('/');
                const src = isAbsolute ? p.image : ('/shared/' + p.image.replace(/^(\.\/|\/)+/, ''));
                imgTag = `<div style="position:relative;width:100%;height:180px;">
                  <img src="${src}" alt="${escapedName}" style="width:100%;height:180px;object-fit:cover;background:#f5f5f5;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                  <div style="display:none;width:100%;height:180px;background:linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);align-items:center;justify-content:center;flex-direction:column;color:#999;font-size:3rem;position:absolute;top:0;left:0;">üíä<div style="font-size:0.875rem;margin-top:0.5rem;color:#666;">·∫¢nh l·ªói</div></div>
                </div>`;
              }
              
              return `
              <div class="product-card">
                ${imgTag}
                <h4>${p.name}</h4>
                <p>${escapedDesc}</p>
                <div>
                  <div style="text-align:center;margin:12px 0;font-weight:800;font-size:1.4rem;color:#d32f2f;">${(p.price||0).toLocaleString()}‚Ç´</div>
                  <button data-id="${p.drug_id}" data-name="${p.name}" data-price="${p.price||0}">üõí Th√™m v√†o gi·ªè</button>
                </div>
              </div>
            `;
          }).join('');

           // attach handlers
           container.querySelectorAll('button[data-id]').forEach(btn => {
             btn.addEventListener('click', async (e) => {
               const id = Number(btn.dataset.id);
               const name = btn.dataset.name;
               const price = Number(btn.dataset.price || 0);
               
               // Always add to localStorage for immediate availability
               fallbackAdd(id, name, price);
               
               // Also try server cart in background
               try {
                 const guestToken = ensureGuestToken();
                 await cartAPI.add({ guest_token: guestToken, item: { drug_id: id, name, price, quantity: 1 } });
               } catch (err) {
                 console.warn('Server cart add failed, using localStorage only', err);
               }
             });
           });
         } catch (error) {
           document.getElementById('featured-products').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
         }
       }

      function fallbackAdd(id, name, price) {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const idx = cart.findIndex(i => Number(i.drug_id) === Number(id));
        if (idx >= 0) cart[idx].quantity = Number(cart[idx].quantity) + 1;
        else cart.push({ drug_id: id, name, price, quantity: 1 });
        localStorage.setItem('cart', JSON.stringify(cart));
        // ensure guest token exists for later merge
        ensureGuestToken();
        alert(`ƒê√£ th√™m ${name} v√†o gi·ªè`);
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadPromotions();
        loadFeatured();
      });
    </script>
    <script src="../shared/chatbox.js"></script>
  </body>
</html>

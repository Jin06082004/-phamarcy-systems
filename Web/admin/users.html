<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li class="active"><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·ªÖn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-user-btn"><i class="bx bx-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi</button>
          <input type="text" id="user-search" class="search-input" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ ng∆∞·ªùi d√πng</th>
                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                <th>H·ªç v√† t√™n</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Vai tr√≤</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT USER ========== -->
    <div id="user-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 700px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; border: none;">
          <h2 id="user-modal-title" style="color: white; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px; margin: 0;">
            <i class='bx bx-user-plus' style="font-size: 28px;"></i>
            Th√™m ng∆∞·ªùi d√πng m·ªõi
          </h2>
          <button class="modal-close" id="user-close" style="background: rgba(255,255,255,0.2); color: white; border: none; font-size: 28px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
        </div>
        
        <form id="user-form" style="padding: 32px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-user' style="font-size: 20px; color: #06b6d4;"></i>
                T√™n ƒëƒÉng nh·∫≠p
              </label>
              <input 
                type="text" 
                id="user-username" 
                required 
                placeholder="VD: nguyenvana" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-lock-alt' style="font-size: 20px; color: #06b6d4;"></i>
                M·∫≠t kh·∫©u
              </label>
              <input 
                type="password" 
                id="user-password" 
                placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-id-card' style="font-size: 20px; color: #06b6d4;"></i>
                H·ªç v√† t√™n
              </label>
              <input 
                type="text" 
                id="user-fullname" 
                placeholder="VD: Nguy·ªÖn VƒÉn A" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-envelope' style="font-size: 20px; color: #06b6d4;"></i>
                Email
              </label>
              <input 
                type="email" 
                id="user-email" 
                placeholder="VD: vana@gmail.com" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
              <i class='bx bx-phone' style="font-size: 20px; color: #06b6d4;"></i>
              S·ªë ƒëi·ªán tho·∫°i
            </label>
            <input 
              type="tel" 
              id="user-phone" 
              placeholder="VD: 0912345678" 
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
              onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            />
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
              <i class='bx bx-map' style="font-size: 20px; color: #06b6d4;"></i>
              ƒê·ªãa ch·ªâ
            </label>
            <textarea 
              id="user-address" 
              placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß..." 
              rows="3"
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; transition: all 0.3s ease; box-sizing: border-box;"
              onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            ></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-shield' style="font-size: 20px; color: #06b6d4;"></i>
                Vai tr√≤
              </label>
              <select 
                id="user-role"
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; cursor: pointer;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              >
                <option value="user">Ng∆∞·ªùi d√πng (User)</option>
                <option value="pharmacist">D∆∞·ª£c sƒ© (Pharmacist)</option>
                <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
              </select>
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-check-circle' style="font-size: 20px; color: #06b6d4;"></i>
                Tr·∫°ng th√°i
              </label>
              <select 
                id="user-status"
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; cursor: pointer;"
                onfocus="this.style.borderColor='#06b6d4'; this.style.boxShadow='0 0 0 3px rgba(6,182,212,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              >
                <option value="false">Ch∆∞a k√≠ch ho·∫°t</option>
                <option value="true">ƒê√£ k√≠ch ho·∫°t</option>
              </select>
            </div>
          </div>

          <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
            <button 
              type="button" 
              class="btn-gray" 
              id="user-cancel"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e5e7eb; background: white; color: #6b7280;"
              onmouseover="this.style.background='#f3f4f6'"
              onmouseout="this.style.background='white'"
            >
              H·ªßy
            </button>
            <button 
              type="submit" 
              class="btn-green"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: none; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; box-shadow: 0 4px 12px rgba(6,182,212,0.3);"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(6,182,212,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(6,182,212,0.3)'"
            >
              <i class='bx bx-save' style="margin-right: 8px;"></i>L∆∞u
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { userAPI } from "../shared/api.js";
      import { initUserBackButton } from "../shared/userBackButton.js";

      // üè† Kh·ªüi t·∫°o n√∫t quay l·∫°i trang user
      initUserBackButton('/Web/user/pages/profile.html');

      // ========== STATE ==========
      let users = [];
      let editingUserId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("user-modal");
      const modalTitle = document.getElementById("user-modal-title");
      const closeBtn = document.getElementById("user-close");
      const cancelBtn = document.getElementById("user-cancel");
      const addBtn = document.getElementById("add-user-btn");
      const form = document.getElementById("user-form");
      const searchInput = document.getElementById("user-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m ng∆∞·ªùi d√πng m·ªõi", userId = null) {
        modalTitle.textContent = title;
        editingUserId = userId;

        if (userId) {
          // Edit mode
          const user = users.find(u => u.user_id === userId);
          if (user) {
            document.getElementById("user-username").value = user.username || "";
            document.getElementById("user-username").disabled = true;
            document.getElementById("user-password").value = "";
            document.getElementById("user-fullname").value = user.full_name || "";
            document.getElementById("user-email").value = user.email || "";
            document.getElementById("user-phone").value = user.phone || "";
            document.getElementById("user-address").value = user.address || "";
            document.getElementById("user-role").value = user.role || "pharmacist";
            document.getElementById("user-status").value = String(user.is_active) || "false";
          }
        } else {
          // Add mode
          document.getElementById("user-username").disabled = false;
          form.reset();
          document.getElementById("user-role").value = "pharmacist";
          document.getElementById("user-status").value = "false";
        }

        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingUserId = null;
        form.reset();
        document.getElementById("user-username").disabled = false;
      }

      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

      // ========== LOAD USERS ==========
      async function loadUsers() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...");
          
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          console.log('üìã Token:', token ? `${token.substring(0, 20)}...` : 'KH√îNG C√ì');
          console.log('üë§ User:', user);
          
          if (!token || !user || user.role !== 'admin') {
            console.warn('‚ö†Ô∏è Kh√¥ng c√≥ token ho·∫∑c kh√¥ng ph·∫£i admin');
            showError('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i v·ªõi t√†i kho·∫£n admin');
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/Web/user/pages/login.html';
            }, 2000);
            return;
          }
          
          const res = await userAPI.getAll();
          console.log("üì¶ Response:", res);

          if (res.success && res.data) {
            users = res.data;
          } else if (Array.isArray(res)) {
            users = res;
          } else {
            console.error('Unexpected response format:', res);
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng");
            return;
          }

          renderTable(users);
          console.log(`‚úÖ ƒê√£ load ${users.length} ng∆∞·ªùi d√πng`);
          
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i ng∆∞·ªùi d√πng:", error);
          
          // Auto clear invalid token
          if (error.status === 401 || error.status === 403) {
            showError("Token kh√¥ng h·ª£p l·ªá. ƒêang ƒëƒÉng xu·∫•t...");
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/Web/user/pages/login.html';
            }, 2000);
          } else {
            showError("L·ªói k·∫øt n·ªëi server: " + error.message);
            // Show retry button
            const tbody = document.querySelector("table tbody");
            tbody.innerHTML = `
              <tr style="text-align: center;">
                <td colspan="8" style="padding: 40px;">
                  <div style="font-size: 1.2rem; margin-bottom: 10px; color: #ef4444;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</div>
                  <div style="font-size: 0.9rem; margin-bottom: 20px; color: #666;">${error.message}</div>
                  <button onclick="location.reload()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    üîÑ Th·ª≠ l·∫°i
                  </button>
                </td>
              </tr>
            `;
          }
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = users) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(user => `
          <tr>
            <td><strong>${user.user_id || "N/A"}</strong></td>
            <td>${user.username || "N/A"}</td>
            <td>${user.full_name || "‚Äî"}</td>
            <td>${user.email || "‚Äî"}</td>
            <td>${user.phone || "‚Äî"}</td>
            <td>
              <span style="background-color: ${user.role === 'admin' ? '#ffd700' : user.role === 'pharmacist' ? '#cfe9cf' : '#e3f2fd'}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                ${user.role === 'admin' ? 'Admin' : user.role === 'pharmacist' ? 'D∆∞·ª£c sƒ©' : 'Ng∆∞·ªùi d√πng'}
              </span>
            </td>
            <td>
              <span style="background-color: ${user.is_active ? '#d4fcd7' : '#ffd6d6'}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                ${user.is_active ? 'Ho·∫°t ƒë·ªông' : 'Ch∆∞a k√≠ch ho·∫°t'}
              </span>
            </td>
            <td>
              <button class="btn-edit" onclick="window.editUser(${user.user_id})" title="S·ª≠a"><i class="bx bx-edit"></i></button>
              <button class="btn-delete" onclick="window.deleteUser(${user.user_id})" title="X√≥a"><i class="bx bx-trash"></i></button>
            </td>
          </tr>
        `).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = users.filter(user =>
          (user.username && user.username.toLowerCase().includes(keyword)) ||
          (user.full_name && user.full_name.toLowerCase().includes(keyword)) ||
          (user.email && user.email.toLowerCase().includes(keyword)) ||
          String(user.user_id).includes(keyword)
        );
        renderTable(filtered);
      });

      // Notification helpers
      function showSuccess(message) {
        notification.success(message);
      }

      function showError(message) {
        notification.error(message);
      }

      // ========== FORM SUBMIT ==========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const username = document.getElementById("user-username").value.trim();
        const password = document.getElementById("user-password").value.trim();
        const full_name = document.getElementById("user-fullname").value.trim();
        const email = document.getElementById("user-email").value.trim();
        const phone = document.getElementById("user-phone").value.trim();
        const address = document.getElementById("user-address").value.trim();
        const role = document.getElementById("user-role").value;
        const is_active = document.getElementById("user-status").value === "true";

        const payload = {
          username,
          full_name,
          email,
          phone,
          address,
          role,
          is_active
        };

        if (password) payload.password = password;

        if (!payload.username || !payload.full_name) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc");
          return;
        }

        try {
          let res;
          if (editingUserId) {
            res = await userAPI.update(editingUserId, payload);
          } else {
            if (!password) {
              showError("M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc khi t·∫°o ng∆∞·ªùi d√πng m·ªõi");
              return;
            }
            res = await userAPI.register(payload);
          }

          console.log("Response:", res);
          closeModal();
          await loadUsers();
        } catch (error) {
          console.error("Error:", error);
          showError("L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.editUser = (id) => {
        openModal("S·ª≠a th√¥ng tin ng∆∞·ªùi d√πng", id);
      };

      // ========== DELETE USER ==========
      window.deleteUser = async (id) => {
        const user = users.find(u => u.user_id === id);
        if (!user) return;

        const confirmed = await notification.confirm(
          `
          <div style="text-align: left;">
            <div style="background: #fef2f2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
              <div style="font-weight: 700; color: #dc2626; margin-bottom: 8px;">X√≥a ng∆∞·ªùi d√πng</div>
              <div style="font-size: 0.875rem; color: #991b1b;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</div>
            </div>
            
            <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
              <div style="margin-bottom: 8px;"><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${user.username}</div>
              <div style="margin-bottom: 8px;"><strong>H·ªç t√™n:</strong> ${user.full_name || 'N/A'}</div>
              <div style="margin-bottom: 8px;"><strong>Email:</strong> ${user.email || 'N/A'}</div>
              <div><strong>Vai tr√≤:</strong> <span style="background: ${user.role === 'admin' ? '#ffd700' : '#e3f2fd'}; padding: 4px 12px; border-radius: 4px; font-weight: 600;">${user.role === 'admin' ? 'Admin' : user.role === 'pharmacist' ? 'D∆∞·ª£c sƒ©' : 'Ng∆∞·ªùi d√πng'}</span></div>
            </div>
            
            <div style="font-weight: 600; color: #1f2937;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?</div>
          </div>
          `,
          'üóëÔ∏è X√°c nh·∫≠n x√≥a'
        );

        if (!confirmed) return;

        try {
          const res = await userAPI.delete(id);
          await loadUsers();
        } catch (error) {
          showError("L·ªói khi x√≥a: " + error.message);
        }
      };

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", async (e) => {
        e.preventDefault();
        
        const confirmed = await notification.confirm(
          'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?',
          'üö™ X√°c nh·∫≠n ƒëƒÉng xu·∫•t'
        );
        
        if (confirmed) {
          localStorage.removeItem("user");
          localStorage.removeItem("token");
          notification.info('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
          setTimeout(() => {
            window.location.href = "/Web/user/pages/login.html";
          }, 1000);
        }
      });

      // ========== INITIALIZATION ==========
      (async function init() {
        try {
          console.log("üöÄ Kh·ªüi t·∫°o trang Qu·∫£n l√Ω ng∆∞·ªùi d√πng...");
          
          // Check authentication
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          if (!token || !user) {
            console.warn('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p');
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c');
            window.location.href = '/Web/user/pages/login.html';
            return;
          }
          
          if (user.role !== 'admin') {
            console.warn('‚ö†Ô∏è Kh√¥ng ph·∫£i admin');
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
            window.location.href = '/Web/user/index.html';
            return;
          }
          
          console.log('‚úÖ User authenticated:', user.username);
          
          // Load data
          await loadUsers();
          
          console.log("‚úÖ Kh·ªüi t·∫°o th√†nh c√¥ng!");
          
        } catch (error) {
          console.error("‚ùå L·ªói kh·ªüi t·∫°o:", error);
          const tbody = document.querySelector("table tbody");
          tbody.innerHTML = `
            <tr style="text-align: center;">
              <td colspan="8" style="padding: 40px;">
                <div style="font-size: 1.2rem; margin-bottom: 10px; color: #ef4444;">‚ùå L·ªói kh·ªüi t·∫°o trang</div>
                <div style="font-size: 0.9rem; margin-bottom: 20px; color: #666;">${error.message}</div>
                <button onclick="localStorage.clear(); location.reload();" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                  üîÑ ƒêƒÉng nh·∫≠p l·∫°i
                </button>
              </td>
            </tr>
          `;
        }
      })();
    </script>

    <script src="../shared/notification.js"></script>
    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </body>
</html>

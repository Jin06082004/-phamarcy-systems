<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li class="active"><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·ªÖn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-user-btn"><i class="bx bx-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi</button>
          <input type="text" id="user-search" class="search-input" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ ng∆∞·ªùi d√πng</th>
                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                <th>H·ªç v√† t√™n</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Vai tr√≤</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT USER ========== -->
    <div id="user-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="user-modal-title">Th√™m ng∆∞·ªùi d√πng m·ªõi</h2>
          <button class="modal-close" id="user-close">&times;</button>
        </div>
        <form id="user-form">
          <div class="form-group">
            <label>T√™n ƒëƒÉng nh·∫≠p:</label>
            <input type="text" id="user-username" required placeholder="VD: nguyenvana" />
          </div>

          <div class="form-group">
            <label>M·∫≠t kh·∫©u:</label>
            <input type="password" id="user-password" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi" />
          </div>

          <div class="form-group">
            <label>H·ªç v√† t√™n:</label>
            <input type="text" id="user-fullname" placeholder="VD: Nguy·ªÖn VƒÉn A" />
          </div>

          <div class="form-group">
            <label>Email:</label>
            <input type="email" id="user-email" placeholder="VD: vana@gmail.com" />
          </div>

          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="user-phone" placeholder="VD: 0912345678" />
          </div>

          <div class="form-group">
            <label>ƒê·ªãa ch·ªâ:</label>
            <textarea id="user-address" placeholder="ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß..."></textarea>
          </div>

          <div class="form-group">
            <label>Vai tr√≤:</label>
            <select id="user-role">
              <option value="user">Ng∆∞·ªùi d√πng (User)</option>
              <option value="pharmacist">D∆∞·ª£c sƒ© (Pharmacist)</option>
              <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Tr·∫°ng th√°i:</label>
            <select id="user-status">
              <option value="false">Ch∆∞a k√≠ch ho·∫°t</option>
              <option value="true">ƒê√£ k√≠ch ho·∫°t</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-green">L∆∞u</button>
            <button type="button" class="btn-gray" id="user-cancel">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { userAPI } from "../shared/api.js";

      // ========== STATE ==========
      let users = [];
      let editingUserId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("user-modal");
      const modalTitle = document.getElementById("user-modal-title");
      const closeBtn = document.getElementById("user-close");
      const cancelBtn = document.getElementById("user-cancel");
      const addBtn = document.getElementById("add-user-btn");
      const form = document.getElementById("user-form");
      const searchInput = document.getElementById("user-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m ng∆∞·ªùi d√πng m·ªõi", userId = null) {
        modalTitle.textContent = title;
        editingUserId = userId;

        if (userId) {
          // Edit mode
          const user = users.find(u => u.user_id === userId);
          if (user) {
            document.getElementById("user-username").value = user.username || "";
            document.getElementById("user-username").disabled = true;
            document.getElementById("user-password").value = "";
            document.getElementById("user-fullname").value = user.full_name || "";
            document.getElementById("user-email").value = user.email || "";
            document.getElementById("user-phone").value = user.phone || "";
            document.getElementById("user-address").value = user.address || "";
            document.getElementById("user-role").value = user.role || "pharmacist";
            document.getElementById("user-status").value = String(user.is_active) || "false";
          }
        } else {
          // Add mode
          document.getElementById("user-username").disabled = false;
          form.reset();
          document.getElementById("user-role").value = "pharmacist";
          document.getElementById("user-status").value = "false";
        }

        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingUserId = null;
        form.reset();
        document.getElementById("user-username").disabled = false;
      }

      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

      // ========== LOAD USERS ==========
      async function loadUsers() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...");
          const res = await userAPI.getAll();
          console.log("üì¶ Response:", res);

          if (res.success && res.data) {
            users = res.data;
            renderTable(users);
          } else if (Array.isArray(res)) {
            users = res;
            renderTable(users);
          } else {
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng");
          }
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i ng∆∞·ªùi d√πng:", error);
          showError("L·ªói k·∫øt n·ªëi server: " + error.message);
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = users) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(user => `
          <tr>
            <td><strong>${user.user_id || "N/A"}</strong></td>
            <td>${user.username || "N/A"}</td>
            <td>${user.full_name || "‚Äî"}</td>
            <td>${user.email || "‚Äî"}</td>
            <td>${user.phone || "‚Äî"}</td>
            <td>
              <span style="background-color: ${user.role === 'admin' ? '#ffd700' : user.role === 'pharmacist' ? '#cfe9cf' : '#e3f2fd'}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                ${user.role === 'admin' ? 'Admin' : user.role === 'pharmacist' ? 'D∆∞·ª£c sƒ©' : 'Ng∆∞·ªùi d√πng'}
              </span>
            </td>
            <td>
              <span style="background-color: ${user.is_active ? '#d4fcd7' : '#ffd6d6'}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                ${user.is_active ? 'Ho·∫°t ƒë·ªông' : 'Ch∆∞a k√≠ch ho·∫°t'}
              </span>
            </td>
            <td>
              <button class="btn-edit" onclick="window.editUser(${user.user_id})" title="S·ª≠a"><i class="bx bx-edit"></i></button>
              <button class="btn-delete" onclick="window.deleteUser(${user.user_id})" title="X√≥a"><i class="bx bx-trash"></i></button>
            </td>
          </tr>
        `).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = users.filter(user =>
          (user.username && user.username.toLowerCase().includes(keyword)) ||
          (user.full_name && user.full_name.toLowerCase().includes(keyword)) ||
          (user.email && user.email.toLowerCase().includes(keyword)) ||
          String(user.user_id).includes(keyword)
        );
        renderTable(filtered);
      });

      // ========== FORM SUBMIT ==========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          username: document.getElementById("user-username").value.trim(),
          full_name: document.getElementById("user-fullname").value.trim(),
          email: document.getElementById("user-email").value.trim(),
          phone: document.getElementById("user-phone").value.trim(),
          address: document.getElementById("user-address").value.trim(),
          role: document.getElementById("user-role").value,
          is_active: document.getElementById("user-status").value === "true",
        };

        const password = document.getElementById("user-password").value.trim();
        if (password) {
          payload.password = password;
        }

        // Validate
        if (!payload.username || !payload.full_name) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc");
          return;
        }

        try {
          let res;
          if (editingUserId) {
            // Update
            res = await userAPI.update(editingUserId, payload);
            showSuccess("‚úÖ C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng");
          } else {
            // Create (need password for new user)
            if (!password) {
              showError("M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc khi t·∫°o ng∆∞·ªùi d√πng m·ªõi");
              return;
            }
            res = await userAPI.register(payload);
            showSuccess("‚úÖ Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng");
          }

          console.log("Response:", res);
          closeModal();
          await loadUsers();
        } catch (error) {
          console.error("Error:", error);
          showError("‚ùå L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.editUser = (id) => {
        openModal("S·ª≠a th√¥ng tin ng∆∞·ªùi d√πng", id);
      };

      window.deleteUser = async (id) => {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?")) {
          try {
            const res = await userAPI.delete(id);
            showSuccess("‚úÖ X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng");
            await loadUsers();
          } catch (error) {
            showError("‚ùå L·ªói khi x√≥a: " + error.message);
          }
        }
      };

      // ========== NOTIFICATIONS ==========
      function showError(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f44336;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      function showSuccess(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      // ========== INIT ==========
      document.addEventListener("DOMContentLoaded", loadUsers);

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
          localStorage.removeItem("user");
          window.location.href = "/Web/user/pages/login.html";
        }
      });
    </script>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </body>
</html>

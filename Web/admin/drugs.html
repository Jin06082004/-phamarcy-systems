<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω thu·ªëc - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <!-- Boxicons & CSS -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="index.html">
            <i class="bx bx-home"></i>
            <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
          </a>
        </li>
        <li class="active">
          <a href="drugs.html">
            <i class="bx bx-plus-medical"></i>
            <span>Thu·ªëc</span>
          </a>
        </li>
        <li>
          <a href="categories.html">
            <i class="bx bx-category"></i>
            <span>Danh m·ª•c</span>
          </a>
        </li>
        <li>
          <a href="orders.html">
            <i class="bx bx-cart-alt"></i>
            <span>ƒê∆°n h√†ng</span>
          </a>
        </li>
        <li>
          <a href="users.html">
            <i class="bx bx-user"></i>
            <span>Ng∆∞·ªùi d√πng</span>
          </a>
        </li>
        <li>
          <a href="statistics.html">
            <i class="bx bx-line-chart"></i>
            <span>Th·ªëng k√™</span>
          </a>
        </li>
        <li>
          <a href="discount.html">
            <i class="bx bx-tag"></i>
            <span>Khuy·ªÖn m√£i</span>
          </a>
        </li>
        <li class="logout">
          <a href="#">
            <i class="bx bx-log-out"></i>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar">
        <i class="bx bx-chevron-left"></i>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω thu·ªëc</h1>
        <div class="user-info">
          <i class="bx bx-user-circle"></i>
          <span>Admin</span>
        </div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-drug-btn">
            <i class="bx bx-plus"></i> Th√™m thu·ªëc m·ªõi
          </button>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="T√¨m ki·∫øm thu·ªëc..."
          />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ thu·ªëc</th>
                <th>T√™n thu·ªëc</th>
                <th>Danh m·ª•c</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>M√¥ t·∫£</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align: center;">
                <td colspan="7">ƒêang t·∫£i d·ªØ li·ªáu...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL TH√äMC/S·ª¨A THU·ªêC ========== -->
    <div id="drug-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Th√™m thu·ªëc m·ªõi</h2>
          <button class="modal-close" id="close-modal">&times;</button>
        </div>
        <form id="drug-form">
          <div class="form-group">
            <label>M√£ thu·ªëc:</label>
            <input type="text" id="drug-code" required placeholder="VD: DRG001" />
          </div>

          <div class="form-group">
            <label>T√™n thu·ªëc:</label>
            <input type="text" id="drug-name" required placeholder="VD: Paracetamol 500mg" />
          </div>

          <div class="form-group">
            <label>Danh m·ª•c:</label>
            <select id="drug-category" required>
              <option value="">-- Ch·ªçn danh m·ª•c --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Gi√° (‚Ç´):</label>
            <input type="number" id="drug-price" required min="0" placeholder="50000" />
          </div>

          <div class="form-group">
            <label>S·ªë l∆∞·ª£ng:</label>
            <input type="number" id="drug-stock" required min="0" placeholder="100" />
          </div>

          <div class="form-group">
            <label>M√¥ t·∫£:</label>
            <textarea id="drug-description" placeholder="M√¥ t·∫£ chi ti·∫øt thu·ªëc..."></textarea>
          </div>

          <div class="form-group">
            <label>H√¨nh ·∫£nh:</label>
            <input type="file" id="drug-image-file" accept="image/*" />
            <div id="image-preview" style="margin-top: 10px; display: none;">
              <img id="preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;" />
              <button type="button" id="remove-image-btn" style="display: block; margin-top: 5px; padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">X√≥a ·∫£nh</button>
            </div>
            <input type="hidden" id="drug-image" />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-green">L∆∞u</button>
            <button type="button" class="btn-gray" id="cancel-btn">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { drugAPI, categoryAPI } from "../shared/api.js";

      // ========== STATE ==========
      let allDrugs = [];
      let allCategories = [];
      let editingDrugId = null;

      // ========== DOM ELEMENTS ==========
      const modal = document.getElementById("drug-modal");
      const modalTitle = document.getElementById("modal-title");
      const drugForm = document.getElementById("drug-form");
      const closeModalBtn = document.getElementById("close-modal");
      const cancelBtn = document.getElementById("cancel-btn");
      const addDrugBtn = document.getElementById("add-drug-btn");
      const searchInput = document.getElementById("search-input");

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m thu·ªëc m·ªõi", drugId = null) {
        modalTitle.textContent = title;
        editingDrugId = drugId;
        
        if (drugId) {
          // Edit mode
          const drug = allDrugs.find(d => d.drug_id === drugId);
          if (drug) {
            document.getElementById("drug-code").value = drug.drug_code || "";
            document.getElementById("drug-name").value = drug.name || "";
            document.getElementById("drug-category").value = drug.category_id || "";
            document.getElementById("drug-price").value = drug.price || "";
            document.getElementById("drug-stock").value = drug.stock || "";
            document.getElementById("drug-description").value = drug.description || "";
            hiddenImageInput.value = drug.image || "";
            // Show preview if image exists
            if (drug.image) {
              previewImg.src = drug.image;
              imagePreview.style.display = "block";
            }
          }
        } else {
          // Add mode
          drugForm.reset();
          imagePreview.style.display = "none";
          previewImg.src = "";
          hiddenImageInput.value = "";
        }
        
        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingDrugId = null;
        drugForm.reset();
      }

      addDrugBtn.addEventListener("click", () => openModal());
      closeModalBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      // ========== IMAGE UPLOAD HANDLING ==========
      const imageFileInput = document.getElementById("drug-image-file");
      const imagePreview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      const removeImageBtn = document.getElementById("remove-image-btn");
      const hiddenImageInput = document.getElementById("drug-image");

      imageFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const base64 = ev.target.result;
            previewImg.src = base64;
            imagePreview.style.display = "block";
            hiddenImageInput.value = base64;
          };
          reader.readAsDataURL(file);
        }
      });

      removeImageBtn.addEventListener("click", () => {
        imageFileInput.value = "";
        hiddenImageInput.value = "";
        previewImg.src = "";
        imagePreview.style.display = "none";
      });

      // ========== LOAD DATA ==========
      async function loadCategories() {
        try {
          const response = await categoryAPI.getAll();
          if (response.success && response.data) {
            allCategories = response.data;
            updateCategorySelect();
          }
        } catch (error) {
          console.error("L·ªói t·∫£i danh m·ª•c:", error);
        }
      }

      function updateCategorySelect() {
        const select = document.getElementById("drug-category");
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
        allCategories.forEach(cat => {
          const option = document.createElement("option");
          // Use numeric category_id to match server schema
          option.value = cat.category_id ?? "";
          option.textContent = cat.name || cat.category_name || "Kh√¥ng x√°c ƒë·ªãnh";
          select.appendChild(option);
        });
        
        select.value = currentValue;
      }

      async function loadDrugs() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch thu·ªëc...");
          const response = await drugAPI.getAll();
          console.log("üì¶ Response:", response);
          
          if (response.success && response.data) {
            allDrugs = response.data;
            renderDrugs(allDrugs);
          } else {
            console.error("‚ùå L·ªói: Response kh√¥ng h·ª£p l·ªá", response);
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch thu·ªëc");
          }
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i thu·ªëc:", error);
          showError("L·ªói k·∫øt n·ªëi server: " + error.message);
        }
      }

      // ========== RENDER TABLE ==========
      function renderDrugs(drugs = allDrugs) {
        const tbody = document.querySelector("table tbody");
        
        if (!drugs || drugs.length === 0) {
          tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding: 20px;'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
          return;
        }

        tbody.innerHTML = drugs.map(drug => {
          const categoryName = allCategories.find(c =>
            Number(c.category_id) === Number(drug.category_id)
          )?.name || `ID: ${drug.category_id}`;

          return `
            <tr>
              <td><strong>${drug.drug_code || "N/A"}</strong></td>
              <td>${drug.name || "N/A"}</td>
              <td>${categoryName}</td>
              <td>${drug.price ? drug.price.toLocaleString() : "N/A"}‚Ç´</td>
              <td>
                <span style="background-color: ${drug.stock < 50 ? '#fff3cd' : '#d4edda'}; padding: 5px 10px; border-radius: 4px;">
                  ${drug.stock || 0}
                </span>
              </td>
              <td>${drug.description || "-"}</td>
              <td>
                <button class="btn-edit" onclick="window.editDrug(${drug.drug_id})" title="S·ª≠a">
                  <i class="bx bx-edit"></i>
                </button>
                <button class="btn-delete" onclick="window.deleteDrug(${drug.drug_id})" title="X√≥a">
                  <i class="bx bx-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = allDrugs.filter(drug =>
          drug.name.toLowerCase().includes(keyword) ||
          drug.drug_code.toLowerCase().includes(keyword)
        );
        renderDrugs(filtered);
      });

      // ========== FORM SUBMIT ==========
      drugForm.addEventListener("submit", async (e) => {
        e.preventDefault();

          const formData = {
          drug_code: document.getElementById("drug-code").value.trim(),
          name: document.getElementById("drug-name").value.trim(),
          category_id: parseInt(document.getElementById("drug-category").value),
          price: parseFloat(document.getElementById("drug-price").value),
          stock: parseInt(document.getElementById("drug-stock").value),
          description: document.getElementById("drug-description").value.trim(),
          image: document.getElementById("drug-image").value.trim(),
        };

        // Validate
        if (!formData.drug_code || !formData.name || !formData.category_id || !formData.price || !formData.stock) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc");
          return;
        }

        try {
          let response;
          if (editingDrugId) {
            // Update
            response = await drugAPI.update(editingDrugId, formData);
            showSuccess("‚úÖ C·∫≠p nh·∫≠t thu·ªëc th√†nh c√¥ng");
          } else {
            // Create
            response = await drugAPI.create(formData);
            showSuccess("‚úÖ Th√™m thu·ªëc th√†nh c√¥ng");
          }

          closeModal();
          await loadDrugs();
        } catch (error) {
          showError("‚ùå L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.editDrug = (id) => {
        openModal("S·ª≠a th√¥ng tin thu·ªëc", id);
      };

      window.deleteDrug = async (id) => {
        if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a thu·ªëc n√†y?")) {
          try {
            await drugAPI.delete(id);
            showSuccess("‚úÖ X√≥a thu·ªëc th√†nh c√¥ng");
            await loadDrugs();
          } catch (error) {
            showError("‚ùå L·ªói khi x√≥a: " + error.message);
          }
        }
      };

      // ========== NOTIFICATIONS ==========
      function showError(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #f44336;
          color: white;
          padding: 15px 20px;
          border-radius: 6px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
          z-index: 2000;
          max-width: 400px;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 4000);
      }

      function showSuccess(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #4CAF50;
          color: white;
          padding: 15px 20px;
          border-radius: 6px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.3);
          z-index: 2000;
          max-width: 400px;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      // ========== INIT ==========
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("üöÄ Kh·ªüi t·∫°o trang...");
        await loadCategories();
        await loadDrugs();
      });
    </script>
  </body>
</html>

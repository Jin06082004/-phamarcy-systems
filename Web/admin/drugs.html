<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω thu·ªëc - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <!-- Boxicons & CSS -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="index.html">
            <i class="bx bx-home"></i>
            <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
          </a>
        </li>
        <li class="active">
          <a href="drugs.html">
            <i class="bx bx-plus-medical"></i>
            <span>Thu·ªëc</span>
          </a>
        </li>
        <li>
          <a href="categories.html">
            <i class="bx bx-category"></i>
            <span>Danh m·ª•c</span>
          </a>
        </li>
        <li>
          <a href="orders.html">
            <i class="bx bx-cart-alt"></i>
            <span>ƒê∆°n h√†ng</span>
          </a>
        </li>
        <li>
          <a href="users.html">
            <i class="bx bx-user"></i>
            <span>Ng∆∞·ªùi d√πng</span>
          </a>
        </li>
        <li>
          <a href="statistics.html">
            <i class="bx bx-line-chart"></i>
            <span>Th·ªëng k√™</span>
          </a>
        </li>
        <li>
          <a href="discount.html">
            <i class="bx bx-tag"></i>
            <span>Khuy·∫øn m√£i</span>
          </a>
        </li>
        <li class="logout">
          <a href="#" id="logout-link">
            <i class="bx bx-log-out"></i>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar">
        <i class="bx bx-chevron-left"></i>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω thu·ªëc</h1>
        <div class="user-info">
          <i class="bx bx-user-circle"></i>
          <span>Admin</span>
        </div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-drug-btn">
            <i class="bx bx-plus"></i> Th√™m thu·ªëc m·ªõi
          </button>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="T√¨m ki·∫øm thu·ªëc..."
          />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ thu·ªëc</th>
                <th>T√™n thu·ªëc</th>
                <th>Danh m·ª•c</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>M√¥ t·∫£</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align: center;">
                <td colspan="7">ƒêang t·∫£i d·ªØ li·ªáu...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL TH√äM/S·ª¨A THU·ªêC ========== -->
    <div id="drug-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; border-bottom: none;">
          <h2 id="modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px;">
            <i class='bx bx-plus-medical' style="font-size: 1.8rem;"></i>
            <span>S·ª≠a th√¥ng tin thu·ªëc</span>
          </h2>
          <button class="modal-close" id="close-modal" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0deg)'">&times;</button>
        </div>
        <form id="drug-form" style="padding: 32px;">
          <!-- M√£ thu·ªëc -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-barcode' style="font-size: 1.2rem; color: #10b981;"></i>
              M√£ thu·ªëc:
            </label>
            <input type="text" id="drug-code" required placeholder="VD: DRG004" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s; font-family: monospace; font-weight: 600;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'" />
          </div>

          <!-- T√™n thu·ªëc -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-capsule' style="font-size: 1.2rem; color: #10b981;"></i>
              T√™n thu·ªëc:
            </label>
            <input type="text" id="drug-name" required placeholder="VD: Omeprazole 20mg" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'" />
          </div>

          <!-- Danh m·ª•c -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-category' style="font-size: 1.2rem; color: #10b981;"></i>
              Danh m·ª•c:
            </label>
            <select id="drug-category" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; background: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
              <option value="">-- Ch·ªçn danh m·ª•c --</option>
            </select>
          </div>

          <!-- Gi√° v√† S·ªë l∆∞·ª£ng theo ƒë∆°n v·ªã -->
          <div style="margin-bottom: 24px;">
            <h4 style="color: #10b981; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem;">
              <i class='bx bx-purchase-tag' style="font-size: 1.3rem;"></i>
              Gi√° & T·ªìn kho theo ƒë∆°n v·ªã
            </h4>
            
            <!-- VI√äN -->
            <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
              <h5 style="color: #065f46; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-weight: 700;">
                <i class='bx bxs-circle' style="color: #10b981; font-size: 0.7rem;"></i>
                üíä Vi√™n (ƒê∆°n v·ªã c∆° b·∫£n)
              </h5>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">Gi√° (‚Ç´/vi√™n)</label>
                  <input type="number" id="price-pill" min="0" placeholder="5000" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">T·ªìn kho (vi√™n)</label>
                  <input type="number" id="stock-pill" min="0" placeholder="1000" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
              </div>
            </div>
            
            <!-- V·ªà -->
            <div style="background: #eff6ff; border: 2px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
              <h5 style="color: #1e3a8a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-weight: 700;">
                <i class='bx bxs-grid' style="color: #3b82f6; font-size: 0.9rem;"></i>
                üì¶ V·ªâ
              </h5>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">Gi√° (‚Ç´/v·ªâ)</label>
                  <input type="number" id="price-blister" min="0" placeholder="45000" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">S·ªë vi√™n/v·ªâ</label>
                  <input type="number" id="qty-blister" min="1" placeholder="10" value="10" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">T·ªìn kho (v·ªâ)</label>
                  <input type="number" id="stock-blister" min="0" placeholder="50" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
              </div>
            </div>
            
            <!-- H·ªòP -->
            <div style="background: #fef3c7; border: 2px solid #fcd34d; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
              <h5 style="color: #78350f; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-weight: 700;">
                <i class='bx bxs-box' style="color: #f59e0b; font-size: 1rem;"></i>
                üì¶ H·ªôp
              </h5>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">Gi√° (‚Ç´/h·ªôp)</label>
                  <input type="number" id="price-box" min="0" placeholder="400000" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">S·ªë vi√™n/h·ªôp</label>
                  <input type="number" id="qty-box" min="1" placeholder="100" value="100" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
                <div>
                  <label style="font-size: 0.875rem; color: #374151; margin-bottom: 4px; display: block; font-weight: 600;">T·ªìn kho (h·ªôp)</label>
                  <input type="number" id="stock-box" min="0" placeholder="10" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; font-weight: 600;" />
                </div>
              </div>
            </div>
            
            <!-- ƒê∆°n v·ªã m·∫∑c ƒë·ªãnh -->
            <div style="margin-top: 16px;">
              <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block; font-size: 0.95rem;">
                <i class='bx bx-check-circle' style="color: #10b981;"></i>
                ƒê∆°n v·ªã hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh
              </label>
              <select id="default-unit" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; cursor: pointer;">
                <option value="pill">üíä Vi√™n</option>
                <option value="blister">üì¶ V·ªâ</option>
                <option value="box">üì¶ H·ªôp</option>
              </select>
            </div>
          </div>

          <!-- Gi√° v√† S·ªë l∆∞·ª£ng (Grid 2 c·ªôt) - DEPRECATED -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; display: none;">
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
                <i class='bx bx-money' style="font-size: 1.2rem; color: #10b981;"></i>
                Gi√° (‚Ç´):
              </label>
              <input type="number" id="drug-price" min="0" placeholder="150000" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s; font-weight: 600;" />
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
                <i class='bx bx-package' style="font-size: 1.2rem; color: #10b981;"></i>
                S·ªë l∆∞·ª£ng:
              </label>
              <input type="number" id="drug-stock" min="0" placeholder="58" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s; font-weight: 600;" />
            </div>
          </div>

          <!-- M√¥ t·∫£ -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-note' style="font-size: 1.2rem; color: #10b981;"></i>
              M√¥ t·∫£:
            </label>
            <textarea id="drug-description" rows="4" placeholder="Thu·ªëc ƒëi·ªÅu tr·ªã lo√©t d·∫° d√†y; tr√°o ng∆∞·ª£c d·∫° d√†y th·ª±c qu·∫£n..." style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; background: #f9fafb; transition: all 0.3s; resize: vertical; line-height: 1.6;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'; this.style.background='#ffffff'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.background='#f9fafb'"></textarea>
          </div>

          <!-- H√¨nh ·∫£nh -->
          <div class="form-group" style="margin-bottom: 32px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-image-add' style="font-size: 1.2rem; color: #10b981;"></i>
              H√¨nh ·∫£nh:
            </label>
            <div style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 20px; text-align: center; background: #f9fafb; transition: all 0.3s;" onmouseover="this.style.borderColor='#10b981'; this.style.background='#f0fdf4'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'">
              <input type="file" id="drug-image-file" accept="image/*" style="display: none;" />
              <label for="drug-image-file" style="cursor: pointer; display: inline-block;">
                <div style="font-size: 3rem; color: #9ca3af; margin-bottom: 8px;">üì∑</div>
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Click ƒë·ªÉ ch·ªçn ·∫£nh</div>
                <div style="font-size: 0.875rem; color: #6b7280;">ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</div>
              </label>
            </div>
            
            <div id="image-preview" style="margin-top: 16px; display: none;">
              <div style="position: relative; display: inline-block;">
                <img id="preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border: 3px solid #10b981; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
                <button type="button" id="remove-image-btn" style="position: absolute; top: -10px; right: -10px; width: 36px; height: 36px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(239,68,68,0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'; this.style.background='#dc2626'" onmouseout="this.style.transform='scale(1)'; this.style.background='#ef4444'">
                  ‚úï
                </button>
              </div>
            </div>
            
            <input type="hidden" id="drug-image" />
            <small style="color: #6b7280; display: block; margin-top: 8px; font-size: 0.875rem;">
              üí° Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh (t·ªëi ƒëa 5MB, ƒë·ªãnh d·∫°ng: JPG, PNG, GIF, WebP)
            </small>
          </div>

          <!-- Actions -->
          <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #f3f4f6;">
            <button type="button" class="btn-gray" id="cancel-btn" style="padding: 12px 28px; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#9ca3af'" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db'">
              ‚úñÔ∏è H·ªßy
            </button>
            <button type="submit" class="btn-green" style="padding: 12px 32px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
              üíæ L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script src="../shared/notification.js"></script>
    <script type="module">
      import { drugAPI, categoryAPI, uploadAPI } from "../shared/api.js";
      import { initUserBackButton } from "../shared/userBackButton.js";

      // üè† Kh·ªüi t·∫°o n√∫t quay l·∫°i trang user
      initUserBackButton('/Web/user/pages/drugs.html');

      // ========== STATE ==========
      let allDrugs = [];
      let allCategories = [];
      let editingDrugId = null;
      let uploadedImageFilename = null;

      // ========== NOTIFICATION HELPERS ==========
      function showSuccess(message) {
        notification.success(message);
      }

      function showError(message) {
        notification.error(message);
      }

      function showInfo(message) {
        notification.info(message);
      }

      // ========== KH·ªûI T·∫†O ==========
      (async function init() {
        try {
          console.log("üöÄ ƒêang kh·ªüi t·∫°o trang Qu·∫£n l√Ω thu·ªëc...");
          
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          if (!user || user.role !== 'admin') {
            await notification.error('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y', 'üîí T·ª´ ch·ªëi truy c·∫≠p');
            window.location.href = '/Web/user/pages/login.html';
            return;
          }

          setupEventListeners();
          await loadCategories();
          await loadDrugs();
          
          console.log("‚úÖ Kh·ªüi t·∫°o trang th√†nh c√¥ng!");
        } catch (error) {
          console.error("‚ùå L·ªói kh·ªüi t·∫°o:", error);
          showError("L·ªói kh·ªüi t·∫°o trang: " + error.message);
        }
      })();

      // ========== SETUP EVENT LISTENERS ==========
      function setupEventListeners() {
        // Sidebar toggle
        document.getElementById("toggleSidebar").addEventListener("click", () => {
          document.querySelector(".sidebar").classList.toggle("collapsed");
          document.querySelector("#toggleSidebar i").classList.toggle("bx-chevron-right");
        });

        // Modal controls
        document.getElementById("add-drug-btn").addEventListener("click", () => openModal());
        document.getElementById("close-modal").addEventListener("click", closeModal);
        document.getElementById("cancel-btn").addEventListener("click", closeModal);
        document.getElementById("drug-modal").addEventListener("click", (e) => {
          if (e.target.id === "drug-modal") closeModal();
        });

        // Search
        document.getElementById("search-input").addEventListener("input", handleSearch);

        // Form submit
        document.getElementById("drug-form").addEventListener("submit", handleFormSubmit);

        // Image upload
        document.getElementById("drug-image-file").addEventListener("change", handleImageUpload);
        document.getElementById("remove-image-btn").addEventListener("click", handleRemoveImage);

        // Logout
        document.getElementById("logout-link").addEventListener("click", async (e) => {
          e.preventDefault();
          
          const confirmed = await notification.confirm(
            'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?',
            'üö™ X√°c nh·∫≠n ƒëƒÉng xu·∫•t'
          );
          
          if (confirmed) {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            showInfo('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
            setTimeout(() => {
              window.location.href = '/Web/user/pages/login.html';
            }, 1000);
          }
        });
      }

      // ========== LOAD CATEGORIES ==========
      async function loadCategories() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh m·ª•c...");
          const response = await categoryAPI.getAll();
          
          if (response.success && response.data) {
            allCategories = response.data;
          } else if (Array.isArray(response)) {
            allCategories = response;
          } else {
            console.warn("Unexpected categories response:", response);
            allCategories = [];
          }
          
          console.log(`‚úÖ ƒê√£ t·∫£i ${allCategories.length} danh m·ª•c`);
          updateCategorySelect();
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i danh m·ª•c:", error);
          showError("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c: " + error.message);
        }
      }

      function updateCategorySelect() {
        const select = document.getElementById("drug-category");
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
        
        allCategories.forEach(cat => {
          const option = document.createElement("option");
          option.value = cat.category_id || "";
          option.textContent = cat.name || cat.category_name || "Kh√¥ng x√°c ƒë·ªãnh";
          select.appendChild(option);
        });
        
        if (currentValue) {
          select.value = currentValue;
        }
      }

      // ========== LOAD DRUGS ==========
      async function loadDrugs() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch thu·ªëc...");
          const response = await drugAPI.getAll();
          
          if (response.success && response.data) {
            allDrugs = response.data;
          } else if (Array.isArray(response)) {
            allDrugs = response;
          } else {
            console.warn("Unexpected drugs response:", response);
            allDrugs = [];
          }
          
          console.log(`‚úÖ ƒê√£ t·∫£i ${allDrugs.length} thu·ªëc`);
          renderDrugs();
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i thu·ªëc:", error);
          const tbody = document.querySelector("table tbody");
          tbody.innerHTML = `
            <tr style="text-align: center;">
              <td colspan="7" style="padding: 30px; color: #ef4444;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</div>
                <div style="font-size: 0.9rem;">${error.message}</div>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  Th·ª≠ l·∫°i
                </button>
              </td>
            </tr>
          `;
        }
      }

      // ========== RENDER DRUGS ==========
      function renderDrugs(drugsToRender = allDrugs) {
        const tbody = document.querySelector("table tbody");
        
        if (!drugsToRender || drugsToRender.length === 0) {
          tbody.innerHTML = `
            <tr style="text-align: center;">
              <td colspan="7" style="padding: 30px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
                <div style="font-size: 1.1rem;">Ch∆∞a c√≥ thu·ªëc n√†o</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">Nh·∫•n "Th√™m thu·ªëc m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = drugsToRender.map(drug => {
          const categoryName = allCategories.find(c =>
            Number(c.category_id) === Number(drug.category_id)
          )?.name || `ID: ${drug.category_id}`;

          const stockColor = drug.stock < 20 ? '#fef2f2' : drug.stock < 50 ? '#fff3cd' : '#d4edda';
          const stockTextColor = drug.stock < 20 ? '#dc2626' : drug.stock < 50 ? '#92400e' : '#065f46';

          return `
            <tr>
              <td><strong>${drug.drug_code || "N/A"}</strong></td>
              <td>${drug.name || "N/A"}</td>
              <td>${categoryName}</td>
              <td><strong>${drug.price ? drug.price.toLocaleString('vi-VN') : "0"}‚Ç´</strong></td>
              <td>
                <span style="background-color: ${stockColor}; color: ${stockTextColor}; padding: 5px 10px; border-radius: 4px; font-weight: 600;">
                  ${drug.stock || 0}
                </span>
              </td>
              <td>${drug.description || "‚Äî"}</td>
              <td>
                <button class="btn-edit" onclick="window.editDrug(${drug.drug_id})" title="S·ª≠a">
                  <i class="bx bx-edit"></i>
                </button>
                <button class="btn-delete" onclick="window.deleteDrug(${drug.drug_id})" title="X√≥a">
                  <i class="bx bx-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      function handleSearch(e) {
        const keyword = e.target.value.toLowerCase().trim();
        
        if (!keyword) {
          renderDrugs(allDrugs);
          return;
        }

        const filtered = allDrugs.filter(drug =>
          (drug.drug_code && drug.drug_code.toLowerCase().includes(keyword)) ||
          (drug.name && drug.name.toLowerCase().includes(keyword)) ||
          (drug.description && drug.description.toLowerCase().includes(keyword))
        );
        
        renderDrugs(filtered);
      }

      // ========== MODAL CONTROL ==========
      function openModal(drugId = null) {
        const modal = document.getElementById("drug-modal");
        const modalTitle = document.getElementById("modal-title");
        const form = document.getElementById("drug-form");
        
        editingDrugId = drugId;
        
        if (drugId) {
          modalTitle.innerHTML = '<i class="bx bx-edit"></i><span>S·ª≠a th√¥ng tin thu·ªëc</span>';
          const drug = allDrugs.find(d => d.drug_id === drugId);
          
          if (drug) {
            document.getElementById("drug-code").value = drug.drug_code || "";
            document.getElementById("drug-name").value = drug.name || "";
            document.getElementById("drug-category").value = drug.category_id || "";
            document.getElementById("drug-description").value = drug.description || "";
            document.getElementById("drug-image").value = drug.image || "";
            
            // ‚ú® Load pricing data
            if (drug.pricing) {
              document.getElementById("price-pill").value = drug.pricing.pill?.price || 0;
              document.getElementById("stock-pill").value = drug.pricing.pill?.stock || 0;
              
              document.getElementById("price-blister").value = drug.pricing.blister?.price || 0;
              document.getElementById("qty-blister").value = drug.pricing.blister?.quantity_per_unit || 10;
              document.getElementById("stock-blister").value = drug.pricing.blister?.stock || 0;
              
              document.getElementById("price-box").value = drug.pricing.box?.price || 0;
              document.getElementById("qty-box").value = drug.pricing.box?.quantity_per_unit || 100;
              document.getElementById("stock-box").value = drug.pricing.box?.stock || 0;
              
              document.getElementById("default-unit").value = drug.default_unit || 'pill';
            } else {
              // Fallback to old format
              document.getElementById("price-pill").value = drug.price || 0;
              document.getElementById("stock-pill").value = drug.stock || 0;
              document.getElementById("default-unit").value = 'pill';
            }
            
            // Preview existing image
            if (drug.image) {
              const previewImg = document.getElementById("preview-img");
              const imagePreview = document.getElementById("image-preview");
              previewImg.src = drug.image.startsWith('http') ? drug.image : `http://localhost:5000${drug.image}`;
              imagePreview.style.display = "block";
              
              const match = drug.image.match(/\/drugs\/(.+)$/);
              if (match) {
                uploadedImageFilename = match[1];
              }
            }
          }
        } else {
          modalTitle.innerHTML = '<i class="bx bx-plus-medical"></i><span>Th√™m thu·ªëc m·ªõi</span>';
          form.reset();
          document.getElementById("image-preview").style.display = "none";
          document.getElementById("preview-img").src = "";
          document.getElementById("drug-image").value = "";
          document.getElementById("default-unit").value = "pill";
          document.getElementById("qty-blister").value = "10";
          document.getElementById("qty-box").value = "100";
          uploadedImageFilename = null;
        }
        
        modal.style.display = "flex";
      }

      function closeModal() {
        const modal = document.getElementById("drug-modal");
        const form = document.getElementById("drug-form");
        
        modal.style.display = "none";
        form.reset();
        document.getElementById("image-preview").style.display = "none";
        editingDrugId = null;
        uploadedImageFilename = null;
      }

      // ========== IMAGE UPLOAD ==========
      async function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate
        if (file.size > 5 * 1024 * 1024) {
          showError("File qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB");
          e.target.value = '';
          return;
        }

        if (!file.type.startsWith('image/')) {
          showError("Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá");
          e.target.value = '';
          return;
        }

        try {
          // Show preview immediately
          const reader = new FileReader();
          reader.onload = (ev) => {
            document.getElementById("preview-img").src = ev.target.result;
            document.getElementById("image-preview").style.display = "block";
          };
          reader.readAsDataURL(file);

          // Upload to server
          console.log("‚è≥ ƒêang upload ·∫£nh...");
          const response = await uploadAPI.drugImage(file);

          if (response.success) {
            uploadedImageFilename = response.data.filename;
            document.getElementById("drug-image").value = response.data.url;
          } else {
            throw new Error(response.message || 'Upload failed');
          }
        } catch (error) {
          console.error('‚ùå Upload error:', error);
          showError("L·ªói upload: " + error.message);
          e.target.value = '';
          document.getElementById("image-preview").style.display = "none";
          document.getElementById("drug-image").value = '';
        }
      }

      async function handleRemoveImage() {
        if (uploadedImageFilename) {
          try {
            await uploadAPI.deleteDrugImage(uploadedImageFilename);
          } catch (error) {
            console.warn('Delete image error:', error);
          }
        }

        document.getElementById("drug-image-file").value = "";
        document.getElementById("drug-image").value = "";
        document.getElementById("preview-img").src = "";
        document.getElementById("image-preview").style.display = "none";
        uploadedImageFilename = null;
      }

      // ========== FORM SUBMIT ==========
      async function handleFormSubmit(e) {
        e.preventDefault();

        const formData = {
          drug_code: document.getElementById("drug-code").value.trim().toUpperCase(),
          name: document.getElementById("drug-name").value.trim(),
          category_id: Number(document.getElementById("drug-category").value),
          description: document.getElementById("drug-description").value.trim(),
          image: document.getElementById("drug-image").value.trim(),
          
          // ‚ú® Pricing structure
          pricing: {
            pill: {
              price: Number(document.getElementById("price-pill").value) || 0,
              stock: Number(document.getElementById("stock-pill").value) || 0
            },
            blister: {
              price: Number(document.getElementById("price-blister").value) || 0,
              quantity_per_unit: Number(document.getElementById("qty-blister").value) || 10,
              stock: Number(document.getElementById("stock-blister").value) || 0
            },
            box: {
              price: Number(document.getElementById("price-box").value) || 0,
              quantity_per_unit: Number(document.getElementById("qty-box").value) || 100,
              stock: Number(document.getElementById("stock-box").value) || 0
            }
          },
          default_unit: document.getElementById("default-unit").value,
          
          // DEPRECATED: Gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch
          price: Number(document.getElementById("price-pill").value) || 0,
          stock: Number(document.getElementById("stock-pill").value) || 0,
        };

        // Validate
        if (!formData.drug_code || !formData.name || !formData.category_id) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (M√£ thu·ªëc, T√™n thu·ªëc, Danh m·ª•c)");
          return;
        }

        console.log("üíæ ƒêang l∆∞u thu·ªëc...", formData);

        try {
          let response;
          
          if (editingDrugId) {
            response = await drugAPI.update(editingDrugId, formData);
          } else {
            response = await drugAPI.create(formData);
          }

          console.log("Response:", response);
          closeModal();
          await loadDrugs();
        } catch (error) {
          console.error("‚ùå L·ªói l∆∞u thu·ªëc:", error);
          showError("L·ªói: " + error.message);
        }
      }

      // ========== EXPOSE FUNCTIONS TO GLOBAL SCOPE ==========
      // ‚úÖ FIX: Expose editDrug v√† deleteDrug ra window object
      window.editDrug = function(drugId) {
        console.log("‚úèÔ∏è Ch·ªânh s·ª≠a thu·ªëc ID:", drugId);
        openModal(drugId);
      };

      window.deleteDrug = async function(drugId) {
        const drug = allDrugs.find(d => d.drug_id === drugId);
        const drugName = drug ? drug.name : `ID: ${drugId}`;
        
        const confirmed = await notification.confirm(
          `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thu·ªëc <strong>"${drugName}"</strong>?<br><br>` +
          `<span style="color: #ef4444;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</span>`,
          'üóëÔ∏è X√°c nh·∫≠n x√≥a'
        );

        if (!confirmed) return;

        try {
          console.log("üóëÔ∏è ƒêang x√≥a thu·ªëc ID:", drugId);
          await drugAPI.delete(drugId);
          await loadDrugs();
        } catch (error) {
          console.error("‚ùå L·ªói x√≥a thu·ªëc:", error);
          showError("L·ªói khi x√≥a: " + error.message);
        }
      };
    </script>
  </body>
</html>

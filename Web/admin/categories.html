<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω danh m·ª•c - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <!-- Boxicons & CSS -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="index.html">
            <i class="bx bx-home"></i>
            <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
          </a>
        </li>
        <li>
          <a href="drugs.html">
            <i class="bx bx-plus-medical"></i>
            <span>Thu·ªëc</span>
          </a>
        </li>
        <li class="active">
          <a href="categories.html">
            <i class="bx bx-category"></i>
            <span>Danh m·ª•c</span>
          </a>
        </li>
        <li>
          <a href="orders.html">
            <i class="bx bx-cart-alt"></i>
            <span>ƒê∆°n h√†ng</span>
          </a>
        </li>
        <li>
          <a href="users.html">
            <i class="bx bx-user"></i>
            <span>Ng∆∞·ªùi d√πng</span>
          </a>
        </li>
        <li>
          <a href="statistics.html">
            <i class="bx bx-line-chart"></i>
            <span>Th·ªëng k√™</span>
          </a>
        </li>
        <li>
          <a href="discount.html">
            <i class="bx bx-tag"></i>
            <span>Khuy·ªÖn m√£i</span>
          </a>
        </li>
        <li class="logout">
          <a href="#">
            <i class="bx bx-log-out"></i>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar">
        <i class="bx bx-chevron-left"></i>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω danh m·ª•c</h1>
        <div class="user-info">
          <i class="bx bx-user-circle"></i>
          <span>Admin</span>
        </div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-category-btn">
            <i class="bx bx-plus"></i> Th√™m danh m·ª•c m·ªõi
          </button>
          <input
            type="text"
            id="category-search"
            class="search-input"
            placeholder="T√¨m ki·∫øm danh m·ª•c..."
          />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ danh m·ª•c</th>
                <th>T√™n danh m·ª•c</th>
                <th>M√¥ t·∫£</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>DM001</td>
                <td>Gi·∫£m ƒëau</td>
                <td>Thu·ªëc gi·∫£m ƒëau, h·∫° s·ªët</td>
                <td>
                  <button class="btn-edit">
                    <i class="bx bx-edit"></i>
                  </button>
                  <button class="btn-delete">
                    <i class="bx bx-trash"></i>
                  </button>
                </td>
              </tr>
              <tr>
                <td>DM002</td>
                <td>Kh√°ng sinh</td>
                <td>Thu·ªëc kh√°ng sinh ph·ªï r·ªông</td>
                <td>
                  <button class="btn-edit">
                    <i class="bx bx-edit"></i>
                  </button>
                  <button class="btn-delete">
                    <i class="bx bx-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT CATEGORY ========== -->
    <div id="category-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 600px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; border: none;">
          <h2 id="category-modal-title" style="color: white; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px; margin: 0;">
            <i class='bx bx-category' style="font-size: 28px;"></i>
            Th√™m danh m·ª•c
          </h2>
          <button class="modal-close" id="category-close" style="background: rgba(255,255,255,0.2); color: white; border: none; font-size: 28px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
        </div>
        
        <form id="category-form" style="padding: 32px;">
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
              <i class='bx bx-tag' style="font-size: 20px; color: #8b5cf6;"></i>
              T√™n danh m·ª•c
            </label>
            <input 
              type="text" 
              id="category-name" 
              required 
              placeholder="VD: Kh√°ng sinh" 
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
              onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px rgba(139,92,246,0.1)'"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            />
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
              <i class='bx bx-note' style="font-size: 20px; color: #8b5cf6;"></i>
              M√¥ t·∫£
            </label>
            <textarea 
              id="category-description" 
              placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ danh m·ª•c..." 
              rows="4"
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; transition: all 0.3s ease; box-sizing: border-box;"
              onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px rgba(139,92,246,0.1)'"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            ></textarea>
          </div>

          <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
            <button 
              type="button" 
              class="btn-gray" 
              id="category-cancel"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e5e7eb; background: white; color: #6b7280;"
              onmouseover="this.style.background='#f3f4f6'"
              onmouseout="this.style.background='white'"
            >
              H·ªßy
            </button>
            <button 
              type="submit" 
              class="btn-green"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: none; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; box-shadow: 0 4px 12px rgba(139,92,246,0.3);"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139,92,246,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.3)'"
            >
              <i class='bx bx-save' style="margin-right: 8px;"></i>L∆∞u
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { categoryAPI } from "../shared/api.js";
      import { initUserBackButton } from "../shared/userBackButton.js";

      // üè† Kh·ªüi t·∫°o n√∫t quay l·∫°i trang user
      initUserBackButton('/Web/user/pages/drugs.html');

      let categories = [];
      let editingCategoryId = null;
      const searchInput = document.getElementById('category-search');

      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");

      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // Modal elements
      const modal = document.getElementById('category-modal');
      const modalTitle = document.getElementById('category-modal-title');
      const closeBtn = document.getElementById('category-close');
      const cancelBtn = document.getElementById('category-cancel');
      const addBtn = document.getElementById('add-category-btn');
      const form = document.getElementById('category-form');

      function openModal(title = 'Th√™m danh m·ª•c', category = null) {
        modalTitle.textContent = title;
        editingCategoryId = category ? category.category_id : null;
        if (category) {
          document.getElementById('category-name').value = category.name || '';
          document.getElementById('category-description').value = category.description || '';
        } else {
          form.reset();
        }
        modal.style.display = 'flex';
      }

      function closeModal() {
        modal.style.display = 'none';
        editingCategoryId = null;
        form.reset();
      }

      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      addBtn.addEventListener('click', () => openModal());
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      async function loadCategories() {
        try {
          const res = await categoryAPI.getAll();
          if (res.success) {
            categories = res.data || [];
            renderTable();
          } else {
            console.error('Failed to load categories', res);
            alert('Kh√¥ng th·ªÉ t·∫£i danh m·ª•c');
          }
        } catch (err) {
          console.error(err);
          alert('L·ªói k·∫øt n·ªëi server');
        }
      }

      function renderTable(filtered = null) {
        const data = filtered ?? categories;
        const tbody = document.querySelector('table tbody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(cat => `
          <tr>
            <td><strong>${cat.category_id ?? 'N/A'}</strong></td>
            <td>${cat.name || ''}</td>
            <td>${cat.description || ''}</td>
            <td>
              <button class="btn-edit" onclick="window.editCategory(${cat.category_id})"><i class="bx bx-edit"></i></button>
              <button class="btn-delete" onclick="window.deleteCategory(${cat.category_id})"><i class="bx bx-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }

      // Search filter (client-side)
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.trim().toLowerCase();
          if (!q) {
            renderTable(categories);
            return;
          }
          const filtered = categories.filter(c => (c.name || '').toLowerCase().includes(q) || String(c.category_id).includes(q));
          renderTable(filtered);
        });
      }

      window.editCategory = (id) => {
        const cat = categories.find(c => Number(c.category_id) === Number(id));
        if (cat) openModal('S·ª≠a danh m·ª•c', cat);
      };

      // Notification helpers
      function showSuccess(message) {
        notification.success(message);
      }

      function showError(message) {
        notification.error(message);
      }

      // ========== FORM SUBMIT ==========
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          name: document.getElementById('category-name').value.trim(),
          description: document.getElementById('category-description').value.trim(),
        };
        
        try {
          let res;
          if (editingCategoryId) {
            res = await categoryAPI.update(editingCategoryId, payload);
          } else {
            res = await categoryAPI.create(payload);
          }
          
          if (res.success) {
            closeModal();
            await loadCategories();
          } else {
            showError('L·ªói: ' + (res.message || ''));
          }
        } catch (err) {
          console.error(err);
          showError('L·ªói k·∫øt n·ªëi');
        }
      });

      // ========== DELETE CATEGORY ==========
      window.deleteCategory = async (id) => {
        const category = categories.find(c => Number(c.category_id) === Number(id));
        if (!category) return;

        const confirmed = await notification.confirm(
          `
          <div style="text-align: left;">
            <div style="background: #fef2f2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
              <div style="font-weight: 700; color: #dc2626; margin-bottom: 8px;">X√≥a danh m·ª•c</div>
              <div style="font-size: 0.875rem; color: #991b1b;">‚ö†Ô∏è T·∫•t c·∫£ thu·ªëc trong danh m·ª•c n√†y s·∫Ω b·ªã ·∫£nh h∆∞·ªüng!</div>
            </div>
            
            <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
              <div style="margin-bottom: 8px;"><strong>T√™n danh m·ª•c:</strong> ${category.name}</div>
              <div><strong>M√¥ t·∫£:</strong> ${category.description || 'Kh√¥ng c√≥'}</div>
            </div>
            
            <div style="font-weight: 600; color: #1f2937;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?</div>
          </div>
          `,
          'üóëÔ∏è X√°c nh·∫≠n x√≥a'
        );

        if (!confirmed) return;

        try {
          const res = await categoryAPI.delete(id);
          if (res.success) {
            await loadCategories();
          } else {
            showError('X√≥a th·∫•t b·∫°i: ' + (res.message || ''));
          }
        } catch (err) {
          console.error(err);
          showError('L·ªói k·∫øt n·ªëi');
        }
      };

      // ========== LOGOUT ==========
      document.querySelector('.logout a').addEventListener('click', async (e) => {
        e.preventDefault();
        
        const confirmed = await notification.confirm(
          'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?',
          'üö™ X√°c nh·∫≠n ƒëƒÉng xu·∫•t'
        );
        
        if (confirmed) {
          localStorage.removeItem('user');
          localStorage.removeItem('token');
          notification.info('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
          setTimeout(() => {
            window.location.href = '/Web/user/pages/login.html';
          }, 1000);
        }
      });

      document.addEventListener('DOMContentLoaded', loadCategories);
    </script>
    <script src="../shared/notification.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý danh mục - Hệ thống quản lý nhà thuốc</title>

    <!-- Boxicons & CSS -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="index.html">
            <i class="bx bx-home"></i>
            <span>Bảng điều khiển</span>
          </a>
        </li>
        <li>
          <a href="drugs.html">
            <i class="bx bx-plus-medical"></i>
            <span>Thuốc</span>
          </a>
        </li>
        <li class="active">
          <a href="categories.html">
            <i class="bx bx-category"></i>
            <span>Danh mục</span>
          </a>
        </li>
        <li>
          <a href="orders.html">
            <i class="bx bx-cart-alt"></i>
            <span>Đơn hàng</span>
          </a>
        </li>
        <li>
          <a href="users.html">
            <i class="bx bx-user"></i>
            <span>Người dùng</span>
          </a>
        </li>
        <li>
          <a href="statistics.html">
            <i class="bx bx-line-chart"></i>
            <span>Thống kê</span>
          </a>
        </li>
        <li>
          <a href="discount.html">
            <i class="bx bx-tag"></i>
            <span>Khuyễn mãi</span>
          </a>
        </li>
        <li class="logout">
          <a href="#">
            <i class="bx bx-log-out"></i>
            <span>Đăng xuất</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar">
        <i class="bx bx-chevron-left"></i>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Quản lý danh mục</h1>
        <div class="user-info">
          <i class="bx bx-user-circle"></i>
          <span>Admin</span>
        </div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-category-btn">
            <i class="bx bx-plus"></i> Thêm danh mục mới
          </button>
          <input
            type="text"
            id="category-search"
            class="search-input"
            placeholder="Tìm kiếm danh mục..."
          />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Mã danh mục</th>
                <th>Tên danh mục</th>
                <th>Mô tả</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>DM001</td>
                <td>Giảm đau</td>
                <td>Thuốc giảm đau, hạ sốt</td>
                <td>
                  <button class="btn-edit">
                    <i class="bx bx-edit"></i>
                  </button>
                  <button class="btn-delete">
                    <i class="bx bx-trash"></i>
                  </button>
                </td>
              </tr>
              <tr>
                <td>DM002</td>
                <td>Kháng sinh</td>
                <td>Thuốc kháng sinh phổ rộng</td>
                <td>
                  <button class="btn-edit">
                    <i class="bx bx-edit"></i>
                  </button>
                  <button class="btn-delete">
                    <i class="bx bx-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT CATEGORY ========== -->
    <div id="category-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="category-modal-title">Thêm danh mục</h2>
          <button class="modal-close" id="category-close">&times;</button>
        </div>
        <form id="category-form">
          <div class="form-group">
            <label>Tên danh mục:</label>
            <input type="text" id="category-name" required placeholder="VD: Kháng sinh" />
          </div>
          <div class="form-group">
            <label>Mô tả:</label>
            <textarea id="category-description" placeholder="Mô tả danh mục..."></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-green">Lưu</button>
            <button type="button" class="btn-gray" id="category-cancel">Hủy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { categoryAPI } from "../shared/api.js";

      let categories = [];
      let editingCategoryId = null;
      const searchInput = document.getElementById('category-search');

      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");

      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // Modal elements
      const modal = document.getElementById('category-modal');
      const modalTitle = document.getElementById('category-modal-title');
      const closeBtn = document.getElementById('category-close');
      const cancelBtn = document.getElementById('category-cancel');
      const addBtn = document.getElementById('add-category-btn');
      const form = document.getElementById('category-form');

      function openModal(title = 'Thêm danh mục', category = null) {
        modalTitle.textContent = title;
        editingCategoryId = category ? category.category_id : null;
        if (category) {
          document.getElementById('category-name').value = category.name || '';
          document.getElementById('category-description').value = category.description || '';
        } else {
          form.reset();
        }
        modal.style.display = 'flex';
      }

      function closeModal() {
        modal.style.display = 'none';
        editingCategoryId = null;
        form.reset();
      }

      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      addBtn.addEventListener('click', () => openModal());
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      async function loadCategories() {
        try {
          const res = await categoryAPI.getAll();
          if (res.success) {
            categories = res.data || [];
            renderTable();
          } else {
            console.error('Failed to load categories', res);
            alert('Không thể tải danh mục');
          }
        } catch (err) {
          console.error(err);
          alert('Lỗi kết nối server');
        }
      }

      function renderTable(filtered = null) {
        const data = filtered ?? categories;
        const tbody = document.querySelector('table tbody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Không có dữ liệu</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(cat => `
          <tr>
            <td><strong>${cat.category_id ?? 'N/A'}</strong></td>
            <td>${cat.name || ''}</td>
            <td>${cat.description || ''}</td>
            <td>
              <button class="btn-edit" onclick="window.editCategory(${cat.category_id})"><i class="bx bx-edit"></i></button>
              <button class="btn-delete" onclick="window.deleteCategory(${cat.category_id})"><i class="bx bx-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }

      // Search filter (client-side)
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.trim().toLowerCase();
          if (!q) {
            renderTable(categories);
            return;
          }
          const filtered = categories.filter(c => (c.name || '').toLowerCase().includes(q) || String(c.category_id).includes(q));
          renderTable(filtered);
        });
      }

      window.editCategory = (id) => {
        const cat = categories.find(c => Number(c.category_id) === Number(id));
        if (cat) openModal('Sửa danh mục', cat);
      };

      window.deleteCategory = async (id) => {
        if (!confirm('Bạn có chắc muốn xóa danh mục này?')) return;
        try {
          const res = await categoryAPI.delete(id);
          if (res.success) {
            alert('Xóa thành công');
            await loadCategories();
          } else {
            alert('Xóa thất bại: ' + (res.message || ''));
          }
        } catch (err) {
          console.error(err);
          alert('Lỗi kết nối');
        }
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          name: document.getElementById('category-name').value.trim(),
          description: document.getElementById('category-description').value.trim(),
        };
        try {
          let res;
          if (editingCategoryId) {
            res = await categoryAPI.update(editingCategoryId, payload);
          } else {
            res = await categoryAPI.create(payload);
          }
          if (res.success) {
            closeModal();
            await loadCategories();
            alert('Lưu thành công');
          } else {
            alert('Lỗi: ' + (res.message || ''));
          }
        } catch (err) {
          console.error(err);
          alert('Lỗi kết nối');
        }
      });

      document.addEventListener('DOMContentLoaded', loadCategories);
    </script>
  </body>
</html>

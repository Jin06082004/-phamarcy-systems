<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω khuy·∫øn m√£i - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li class="active"><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·∫øn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω khuy·∫øn m√£i</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-discount-btn"><i class="bx bx-plus"></i> Th√™m m√£ gi·∫£m gi√° m·ªõi</button>
          <input type="text" id="discount-search" class="search-input" placeholder="T√¨m ki·∫øm m√£ gi·∫£m gi√°..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ gi·∫£m gi√°</th>
                <th>M√¥ t·∫£</th>
                <th>Ph·∫ßn trƒÉm gi·∫£m</th>
                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th>Ng√†y k·∫øt th√∫c</th>
                <th>L∆∞·ª£t s·ª≠ d·ª•ng</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT DISCOUNT ========== -->
    <div id="discount-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 700px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; border: none;">
          <h2 id="discount-modal-title" style="color: white; font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 12px; margin: 0;">
            <i class='bx bx-purchase-tag' style="font-size: 28px;"></i>
            Th√™m m√£ gi·∫£m gi√° m·ªõi
          </h2>
          <button class="modal-close" id="discount-close" style="background: rgba(255,255,255,0.2); color: white; border: none; font-size: 28px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
        </div>
        
        <form id="discount-form" style="padding: 32px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-barcode' style="font-size: 20px; color: #f59e0b;"></i>
                M√£ gi·∫£m gi√°
              </label>
              <input 
                type="text" 
                id="discount-code" 
                required 
                placeholder="VD: DISCOUNT10" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; text-transform: uppercase;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-purchase-tag-alt' style="font-size: 20px; color: #f59e0b;"></i>
                Ph·∫ßn trƒÉm gi·∫£m (%)
              </label>
              <input 
                type="number" 
                id="discount-percentage" 
                required 
                min="0" 
                max="100" 
                placeholder="VD: 10" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
              <i class='bx bx-note' style="font-size: 20px; color: #f59e0b;"></i>
              M√¥ t·∫£
            </label>
            <textarea 
              id="discount-description" 
              placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ m√£ gi·∫£m gi√°..." 
              rows="3"
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; transition: all 0.3s ease; box-sizing: border-box;"
              onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
              onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
            ></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-calendar-check' style="font-size: 20px; color: #f59e0b;"></i>
                Ng√†y b·∫Øt ƒë·∫ßu
              </label>
              <input 
                type="date" 
                id="discount-start-date" 
                required 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; cursor: pointer;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-calendar-x' style="font-size: 20px; color: #f59e0b;"></i>
                Ng√†y k·∫øt th√∫c
              </label>
              <input 
                type="date" 
                id="discount-end-date" 
                required 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; cursor: pointer;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-trending-up' style="font-size: 20px; color: #f59e0b;"></i>
                Gi·ªõi h·∫°n l∆∞·ª£t s·ª≠ d·ª•ng
              </label>
              <input 
                type="number" 
                id="discount-usage-limit" 
                min="0" 
                placeholder="0 = kh√¥ng gi·ªõi h·∫°n" 
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              />
            </div>

            <div class="form-group" style="margin: 0;">
              <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 10px; font-size: 14px;">
                <i class='bx bx-toggle-right' style="font-size: 20px; color: #f59e0b;"></i>
                Tr·∫°ng th√°i
              </label>
              <select 
                id="discount-status"
                style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; box-sizing: border-box; cursor: pointer;"
                onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 0 0 3px rgba(245,158,11,0.1)'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
              >
                <option value="true">Ho·∫°t ƒë·ªông</option>
                <option value="false">T·∫°m d·ª´ng</option>
              </select>
            </div>
          </div>

          <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
            <button 
              type="button" 
              class="btn-gray" 
              id="discount-cancel"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: 2px solid #e5e7eb; background: white; color: #6b7280;"
              onmouseover="this.style.background='#f3f4f6'"
              onmouseout="this.style.background='white'"
            >
              H·ªßy
            </button>
            <button 
              type="submit" 
              class="btn-green"
              style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s ease; border: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; box-shadow: 0 4px 12px rgba(245,158,11,0.3);"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245,158,11,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'"
            >
              <i class='bx bx-save' style="margin-right: 8px;"></i>L∆∞u
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script src="../shared/notification.js"></script>
    <script type="module">
      import { discountAPI } from "../shared/api.js";
      import { initUserBackButton } from "../shared/userBackButton.js";

      // üè† Kh·ªüi t·∫°o n√∫t quay l·∫°i trang user
      initUserBackButton('/Web/user/pages/promotions.html');

      // ========== STATE ==========
      let discounts = [];
      let editingDiscountId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("discount-modal");
      const modalTitle = document.getElementById("discount-modal-title");
      const closeBtn = document.getElementById("discount-close");
      const cancelBtn = document.getElementById("discount-cancel");
      const addBtn = document.getElementById("add-discount-btn");
      const form = document.getElementById("discount-form");
      const searchInput = document.getElementById("discount-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m m√£ gi·∫£m gi√° m·ªõi", discountId = null) {
        modalTitle.textContent = title;
        editingDiscountId = discountId;

        if (discountId) {
          // Edit mode
          const discount = discounts.find(d => d._id === discountId);
          if (discount) {
            document.getElementById("discount-code").value = discount.code || "";
            document.getElementById("discount-code").disabled = true;
            document.getElementById("discount-description").value = discount.description || "";
            document.getElementById("discount-percentage").value = discount.percentage || "";
            document.getElementById("discount-start-date").value = discount.start_date ? discount.start_date.split('T')[0] : "";
            document.getElementById("discount-end-date").value = discount.end_date ? discount.end_date.split('T')[0] : "";
            document.getElementById("discount-usage-limit").value = discount.usage_limit || "";
            document.getElementById("discount-status").value = String(discount.is_active);
          }
        } else {
          // Add mode
          document.getElementById("discount-code").disabled = false;
          form.reset();
          document.getElementById("discount-status").value = "true";
        }

        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingDiscountId = null;
        form.reset();
        document.getElementById("discount-code").disabled = false;
      }

      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

      // ========== LOAD DISCOUNTS ==========
      async function loadDiscounts() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch m√£ gi·∫£m gi√°...");
          const res = await discountAPI.getAll();
          console.log("üì¶ Response:", res);

          if (Array.isArray(res)) {
            discounts = res;
            renderTable(discounts);
          } else if (res.success && Array.isArray(res.data)) {
            discounts = res.data;
            renderTable(discounts);
          } else {
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√£ gi·∫£m gi√°");
          }
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i m√£ gi·∫£m gi√°:", error);
          showError("L·ªói k·∫øt n·ªëi server: " + error.message);
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = discounts) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(discount => {
          const startDate = new Date(discount.start_date);
          const endDate = new Date(discount.end_date);
          const now = new Date();
          
          let status = "";
          if (now < startDate) {
            status = "Ch∆∞a b·∫Øt ƒë·∫ßu";
          } else if (now > endDate) {
            status = "ƒê√£ k·∫øt th√∫c";
          } else if (discount.is_active) {
            status = "Ho·∫°t ƒë·ªông";
          } else {
            status = "T·∫°m d·ª´ng";
          }

          const statusColor = status === "Ho·∫°t ƒë·ªông" ? "#d4fcd7" : status === "T·∫°m d·ª´ng" ? "#ffd6d6" : "#fff3cd";

          return `
            <tr>
              <td><strong>${discount.code}</strong></td>
              <td>${discount.description || "‚Äî"}</td>
              <td><strong>${discount.percentage}%</strong></td>
              <td>${new Date(discount.start_date).toLocaleDateString('vi-VN')}</td>
              <td>${new Date(discount.end_date).toLocaleDateString('vi-VN')}</td>
              <td>${discount.used_count || 0} / ${discount.usage_limit || "‚àû"}</td>
              <td>
                <span style="background-color: ${statusColor}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${status}
                </span>
              </td>
              <td>
                <button class="btn-edit" onclick="window.editDiscount('${discount._id}')" title="S·ª≠a"><i class="bx bx-edit"></i></button>
                <button class="btn-delete" onclick="window.deleteDiscount('${discount._id}')" title="X√≥a"><i class="bx bx-trash"></i></button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = discounts.filter(discount =>
          (discount.code && discount.code.toLowerCase().includes(keyword)) ||
          (discount.description && discount.description.toLowerCase().includes(keyword))
        );
        renderTable(filtered);
      });

      // ========== FORM SUBMIT ==========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const code = document.getElementById("discount-code").value.trim().toUpperCase();
        const description = document.getElementById("discount-description").value.trim();
        const percentage = Number(document.getElementById("discount-percentage").value);
        const start_date = document.getElementById("discount-start-date").value;
        const end_date = document.getElementById("discount-end-date").value;
        const usage_limit = Number(document.getElementById("discount-usage-limit").value) || null;
        const is_active = document.getElementById("discount-status").value === "true";

        const payload = {
          code,
          description,
          percentage,
          start_date,
          end_date,
          usage_limit,
          is_active
        };

        if (!code || !description || percentage <= 0 || percentage > 100 || !start_date || !end_date) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá");
          return;
        }

        if (new Date(start_date) >= new Date(end_date)) {
          showError("Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu");
          return;
        }

        try {
          let res;
          if (editingDiscountId) {
            res = await discountAPI.update(editingDiscountId, payload);
          } else {
            res = await discountAPI.create(payload);
          }

          console.log("Response:", res);
          closeModal();
          await loadDiscounts();
        } catch (error) {
          console.error("Error:", error);
          showError("L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.editDiscount = (id) => {
        openModal("S·ª≠a m√£ gi·∫£m gi√°", id);
      };

      window.deleteDiscount = async (id) => {
        const discount = discounts.find(d => d.discount_id === id);
        if (!discount) return;

        const confirmed = await notification.confirm(
          `
          <div style="text-align: left;">
            <div style="background: #fef2f2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
              <div style="font-weight: 700; color: #dc2626; margin-bottom: 8px;">X√≥a m√£ gi·∫£m gi√°</div>
              <div style="font-size: 0.875rem; color: #991b1b;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</div>
            </div>
            
            <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
              <div style="margin-bottom: 12px;">
                <strong>M√£ gi·∫£m gi√°:</strong> 
                <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 6px 12px; border-radius: 6px; font-weight: 700; margin-left: 8px;">${discount.code}</span>
              </div>
              <div style="margin-bottom: 8px;"><strong>M√¥ t·∫£:</strong> ${discount.description}</div>
              <div style="margin-bottom: 8px;"><strong>Gi·∫£m gi√°:</strong> <span style="color: #ef4444; font-weight: 700;">${discount.percentage}%</span></div>
              <div style="margin-bottom: 8px;"><strong>L∆∞·ª£t d√πng:</strong> ${discount.usage_count || 0}${discount.usage_limit ? ` / ${discount.usage_limit}` : ''}</div>
            </div>
            
            <div style="font-weight: 600; color: #1f2937;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√£ gi·∫£m gi√° n√†y?</div>
          </div>
          `,
          'üóëÔ∏è X√°c nh·∫≠n x√≥a'
        );

        if (!confirmed) return;

        try {
          const res = await discountAPI.delete(id);
          await loadDiscounts();
        } catch (error) {
          showError("L·ªói khi x√≥a: " + error.message);
        }
      };

      // ========== NOTIFICATIONS ==========
      function showError(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f44336;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      function showSuccess(message) {
        notification.success(message);
      }

      // ========== INIT ==========
      document.addEventListener("DOMContentLoaded", loadDiscounts);

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", async (e) => {
        e.preventDefault();
        
        const confirmed = await notification.confirm(
          'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?',
          'üö™ X√°c nh·∫≠n ƒëƒÉng xu·∫•t'
        );
        
        if (confirmed) {
          localStorage.removeItem("user");
          localStorage.removeItem("token");
          notification.info('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
          setTimeout(() => {
            window.location.href = "/Web/user/pages/login.html";
          }, 1000);
        }
      });
    </script>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω khuy·∫øn m√£i - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li class="active"><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·∫øn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω khuy·∫øn m√£i</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-discount-btn"><i class="bx bx-plus"></i> Th√™m m√£ gi·∫£m gi√° m·ªõi</button>
          <input type="text" id="discount-search" class="search-input" placeholder="T√¨m ki·∫øm m√£ gi·∫£m gi√°..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ gi·∫£m gi√°</th>
                <th>M√¥ t·∫£</th>
                <th>Ph·∫ßn trƒÉm gi·∫£m</th>
                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th>Ng√†y k·∫øt th√∫c</th>
                <th>L∆∞·ª£t s·ª≠ d·ª•ng</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT DISCOUNT ========== -->
    <div id="discount-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="discount-modal-title">Th√™m m√£ gi·∫£m gi√° m·ªõi</h2>
          <button class="modal-close" id="discount-close">&times;</button>
        </div>
        <form id="discount-form">
          <div class="form-group">
            <label>M√£ gi·∫£m gi√°:</label>
            <input type="text" id="discount-code" required placeholder="VD: DISCOUNT10" />
          </div>

          <div class="form-group">
            <label>M√¥ t·∫£:</label>
            <textarea id="discount-description" placeholder="M√¥ t·∫£ m√£ gi·∫£m gi√°..."></textarea>
          </div>

          <div class="form-group">
            <label>Ph·∫ßn trƒÉm gi·∫£m (%):</label>
            <input type="number" id="discount-percentage" required min="0" max="100" placeholder="VD: 10" />
          </div>

          <div class="form-group">
            <label>Ng√†y b·∫Øt ƒë·∫ßu:</label>
            <input type="date" id="discount-start-date" required />
          </div>

          <div class="form-group">
            <label>Ng√†y k·∫øt th√∫c:</label>
            <input type="date" id="discount-end-date" required />
          </div>

          <div class="form-group">
            <label>Gi·ªõi h·∫°n l∆∞·ª£t s·ª≠ d·ª•ng (0 = kh√¥ng gi·ªõi h·∫°n):</label>
            <input type="number" id="discount-usage-limit" min="0" placeholder="100" />
          </div>

          <div class="form-group">
            <label>Tr·∫°ng th√°i:</label>
            <select id="discount-status">
              <option value="true">Ho·∫°t ƒë·ªông</option>
              <option value="false">T·∫°m d·ª´ng</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-green">L∆∞u</button>
            <button type="button" class="btn-gray" id="discount-cancel">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { discountAPI } from "../shared/api.js";

      // ========== STATE ==========
      let discounts = [];
      let editingDiscountId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("discount-modal");
      const modalTitle = document.getElementById("discount-modal-title");
      const closeBtn = document.getElementById("discount-close");
      const cancelBtn = document.getElementById("discount-cancel");
      const addBtn = document.getElementById("add-discount-btn");
      const form = document.getElementById("discount-form");
      const searchInput = document.getElementById("discount-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m m√£ gi·∫£m gi√° m·ªõi", discountId = null) {
        modalTitle.textContent = title;
        editingDiscountId = discountId;

        if (discountId) {
          // Edit mode
          const discount = discounts.find(d => d._id === discountId);
          if (discount) {
            document.getElementById("discount-code").value = discount.code || "";
            document.getElementById("discount-code").disabled = true;
            document.getElementById("discount-description").value = discount.description || "";
            document.getElementById("discount-percentage").value = discount.percentage || "";
            document.getElementById("discount-start-date").value = discount.start_date ? discount.start_date.split('T')[0] : "";
            document.getElementById("discount-end-date").value = discount.end_date ? discount.end_date.split('T')[0] : "";
            document.getElementById("discount-usage-limit").value = discount.usage_limit || "";
            document.getElementById("discount-status").value = String(discount.is_active);
          }
        } else {
          // Add mode
          document.getElementById("discount-code").disabled = false;
          form.reset();
          document.getElementById("discount-status").value = "true";
        }

        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingDiscountId = null;
        form.reset();
        document.getElementById("discount-code").disabled = false;
      }

      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

      // ========== LOAD DISCOUNTS ==========
      async function loadDiscounts() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch m√£ gi·∫£m gi√°...");
          const res = await discountAPI.getAll();
          console.log("üì¶ Response:", res);

          if (Array.isArray(res)) {
            discounts = res;
            renderTable(discounts);
          } else if (res.success && Array.isArray(res.data)) {
            discounts = res.data;
            renderTable(discounts);
          } else {
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√£ gi·∫£m gi√°");
          }
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i m√£ gi·∫£m gi√°:", error);
          showError("L·ªói k·∫øt n·ªëi server: " + error.message);
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = discounts) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(discount => {
          const startDate = new Date(discount.start_date);
          const endDate = new Date(discount.end_date);
          const now = new Date();
          
          let status = "";
          if (now < startDate) {
            status = "Ch∆∞a b·∫Øt ƒë·∫ßu";
          } else if (now > endDate) {
            status = "ƒê√£ k·∫øt th√∫c";
          } else if (discount.is_active) {
            status = "Ho·∫°t ƒë·ªông";
          } else {
            status = "T·∫°m d·ª´ng";
          }

          const statusColor = status === "Ho·∫°t ƒë·ªông" ? "#d4fcd7" : status === "T·∫°m d·ª´ng" ? "#ffd6d6" : "#fff3cd";

          return `
            <tr>
              <td><strong>${discount.code}</strong></td>
              <td>${discount.description || "‚Äî"}</td>
              <td><strong>${discount.percentage}%</strong></td>
              <td>${new Date(discount.start_date).toLocaleDateString('vi-VN')}</td>
              <td>${new Date(discount.end_date).toLocaleDateString('vi-VN')}</td>
              <td>${discount.used_count || 0} / ${discount.usage_limit || "‚àû"}</td>
              <td>
                <span style="background-color: ${statusColor}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${status}
                </span>
              </td>
              <td>
                <button class="btn-edit" onclick="window.editDiscount('${discount._id}')" title="S·ª≠a"><i class="bx bx-edit"></i></button>
                <button class="btn-delete" onclick="window.deleteDiscount('${discount._id}')" title="X√≥a"><i class="bx bx-trash"></i></button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = discounts.filter(discount =>
          (discount.code && discount.code.toLowerCase().includes(keyword)) ||
          (discount.description && discount.description.toLowerCase().includes(keyword))
        );
        renderTable(filtered);
      });

      // ========== FORM SUBMIT ==========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          code: document.getElementById("discount-code").value.trim().toUpperCase(),
          description: document.getElementById("discount-description").value.trim(),
          percentage: Number(document.getElementById("discount-percentage").value),
          start_date: document.getElementById("discount-start-date").value,
          end_date: document.getElementById("discount-end-date").value,
          usage_limit: Number(document.getElementById("discount-usage-limit").value) || 0,
          is_active: document.getElementById("discount-status").value === "true",
        };

        // Validate
        if (!payload.code || payload.percentage < 0 || payload.percentage > 100) {
          showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá");
          return;
        }

        if (new Date(payload.start_date) >= new Date(payload.end_date)) {
          showError("Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu");
          return;
        }

        try {
          let res;
          if (editingDiscountId) {
            // Update
            res = await discountAPI.update(editingDiscountId, payload);
            showSuccess("‚úÖ C·∫≠p nh·∫≠t m√£ gi·∫£m gi√° th√†nh c√¥ng");
          } else {
            // Create
            res = await discountAPI.create(payload);
            showSuccess("‚úÖ Th√™m m√£ gi·∫£m gi√° th√†nh c√¥ng");
          }

          console.log("Response:", res);
          closeModal();
          await loadDiscounts();
        } catch (error) {
          console.error("Error:", error);
          showError("‚ùå L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.editDiscount = (id) => {
        openModal("S·ª≠a m√£ gi·∫£m gi√°", id);
      };

      window.deleteDiscount = async (id) => {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√£ gi·∫£m gi√° n√†y?")) {
          try {
            const res = await discountAPI.delete(id);
            showSuccess("‚úÖ X√≥a m√£ gi·∫£m gi√° th√†nh c√¥ng");
            await loadDiscounts();
          } catch (error) {
            showError("‚ùå L·ªói khi x√≥a: " + error.message);
          }
        }
      };

      // ========== NOTIFICATIONS ==========
      function showError(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f44336;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      function showSuccess(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      // ========== INIT ==========
      document.addEventListener("DOMContentLoaded", loadDiscounts);

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
          localStorage.removeItem("user");
          window.location.href = "/Web/user/pages/login.html";
        }
      });
    </script>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </body>
</html>

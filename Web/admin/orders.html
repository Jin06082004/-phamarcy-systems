<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li class="active"><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·∫øn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-order-btn"><i class="bx bx-plus"></i> Th√™m ƒë∆°n h√†ng m·ªõi</button>
          <input type="text" id="order-search" class="search-input" placeholder="T√¨m ki·∫øm theo m√£ ƒë∆°n ho·∫∑c kh√°ch h√†ng..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ ƒë∆°n h√†ng</th>
                <th>Kh√°ch h√†ng</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>S·ªë m·∫∑t h√†ng</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Ph∆∞∆°ng th·ª©c</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT ORDER ========== -->
    <div id="order-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h2 id="order-modal-title">Th√™m ƒë∆°n h√†ng m·ªõi</h2>
          <button class="modal-close" id="order-close">&times;</button>
        </div>
        <form id="order-form">
          <div class="form-group">
            <label>Kh√°ch h√†ng (Customer ID):</label>
            <input type="text" id="order-customer-id" placeholder="ObjectId kh√°ch h√†ng" />
            <small style="color: #666;">ƒê·ªÉ tr·ªëng n·∫øu l√† kh√°ch v√£ng lai</small>
          </div>

          <div class="form-group">
            <label>M·∫∑t h√†ng (JSON Array):</label>
            <textarea id="order-items" 
              placeholder='[{"drug_id":1,"drug_name":"Paracetamol","quantity":2,"price":25000}]'
              style="min-height: 120px;"></textarea>
          </div>

          <div class="form-group">
            <label>Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
            <select id="order-payment-method">
              <option value="cash">Ti·ªÅn m·∫∑t</option>
              <option value="card">Th·∫ª t√≠n d·ª•ng</option>
              <option value="online">Thanh to√°n online</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ghi ch√∫:</label>
            <textarea id="order-notes" placeholder="Ghi ch√∫ ƒë∆°n h√†ng..." style="min-height: 80px;"></textarea>
          </div>

          <div class="form-group">
            <label>Tr·∫°ng th√°i:</label>
            <select id="order-status">
              <option value="Pending">Ch·ªù x·ª≠ l√Ω (Pending)</option>
              <option value="Processing">ƒêang x·ª≠ l√Ω (Processing)</option>
              <option value="Completed">Ho√†n th√†nh (Completed)</option>
              <option value="Cancelled">ƒê√£ h·ªßy (Cancelled)</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-green">L∆∞u</button>
            <button type="button" class="btn-gray" id="order-cancel">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== DETAIL MODAL ========== -->
    <div id="detail-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
          <button class="modal-close" id="detail-close">&times;</button>
        </div>
        <div id="detail-content" style="padding: 20px;">
          <!-- Detail content will be injected here -->
        </div>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { orderAPI } from "../shared/api.js";

      // ========== STATE ==========
      let orders = [];
      let editingOrderId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("order-modal");
      const detailModal = document.getElementById("detail-modal");
      const modalTitle = document.getElementById("order-modal-title");
      const closeBtn = document.getElementById("order-close");
      const detailCloseBtn = document.getElementById("detail-close");
      const cancelBtn = document.getElementById("order-cancel");
      const addBtn = document.getElementById("add-order-btn");
      const form = document.getElementById("order-form");
      const searchInput = document.getElementById("order-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m ƒë∆°n h√†ng m·ªõi", orderId = null) {
        modalTitle.textContent = title;
        editingOrderId = orderId;

        if (orderId) {
          // Edit mode
          const order = orders.find(o => o.order_id === orderId);
          if (order) {
            document.getElementById("order-customer-id").value = order.customer_id || "";
            document.getElementById("order-items").value = JSON.stringify(order.order_items || [], null, 2);
            document.getElementById("order-payment-method").value = order.payment_method || "cash";
            document.getElementById("order-notes").value = order.notes || "";
            document.getElementById("order-status").value = order.status || "Pending";
          }
        } else {
          // Add mode
          form.reset();
          document.getElementById("order-payment-method").value = "cash";
          document.getElementById("order-status").value = "Pending";
        }

        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
        editingOrderId = null;
        form.reset();
      }

      function openDetailModal(order) {
        const content = document.getElementById("detail-content");
        const itemsHtml = (order.order_items || [])
          .map(item => `
            <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
              <strong>${item.drug_name}</strong> (ID: ${item.drug_id})<br/>
              S·ªë l∆∞·ª£ng: ${item.quantity}, Gi√°: ${item.price.toLocaleString()}‚Ç´<br/>
              Th√†nh ti·ªÅn: ${(item.quantity * item.price).toLocaleString()}‚Ç´
            </div>
          `).join("");

        const paymentStatusColor = order.status === "Completed" ? "#d4fcd7" : 
                                   order.status === "Cancelled" ? "#ffd6d6" : "#fff3cd";

        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${order.order_id}</p>
            <p><strong>Kh√°ch h√†ng:</strong> ${order.customer_id ? `ID: ${order.customer_id}` : "Kh√°ch v√£ng lai"}</p>
            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(order.order_date || order.createdAt).toLocaleString('vi-VN')}</p>
            <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${order.payment_method === "cash" ? "Ti·ªÅn m·∫∑t" : order.payment_method === "card" ? "Th·∫ª t√≠n d·ª•ng" : "Thanh to√°n online"}</p>
            <p><strong>Ghi ch√∫:</strong> ${order.notes || "‚Äî"}</p>
            
            <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
              <h4>C√°c m·∫∑t h√†ng:</h4>
              ${itemsHtml}
            </div>

            <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
              <p><strong>T·ªïng ti·ªÅn:</strong> <span style="font-size: 18px; color: #d32f2f;">${order.total_amount.toLocaleString()}‚Ç´</span></p>
              <p><strong>Tr·∫°ng th√°i:</strong> 
                <span style="background-color: ${paymentStatusColor}; padding: 5px 10px; border-radius: 4px; font-weight: 600;">
                  ${order.status}
                </span>
              </p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button onclick="window.editOrder(${order.order_id})" class="btn-green">S·ª≠a</button>
              <button onclick="window.changeStatus(${order.order_id})" class="btn-blue" style="background: #2196F3;">ƒê·ªïi tr·∫°ng th√°i</button>
              <button onclick="window.deleteOrder(${order.order_id})" class="btn-delete">X√≥a</button>
            </div>
          </div>
        `;
        detailModal.style.display = "flex";
      }

      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      detailCloseBtn.addEventListener("click", () => { detailModal.style.display = "none"; });
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
      detailModal.addEventListener("click", (e) => { if (e.target === detailModal) detailModal.style.display = "none"; });

      // ========== LOAD ORDERS ==========
      async function loadOrders() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...");
          const res = await orderAPI.getAll();
          console.log("üì¶ Response:", res);

          if (Array.isArray(res)) {
            orders = res;
            renderTable(orders);
          } else if (res.success && Array.isArray(res.data)) {
            orders = res.data;
            renderTable(orders);
          } else {
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng");
          }
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i ƒë∆°n h√†ng:", error);
          showError("L·ªói k·∫øt n·ªëi server: " + error.message);
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = orders) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(order => {
          const statusColor = order.status === "Completed" ? "#d4fcd7" : 
                             order.status === "Cancelled" ? "#ffd6d6" : "#fff3cd";
          const paymentMethodText = order.payment_method === "cash" ? "Ti·ªÅn m·∫∑t" : 
                                   order.payment_method === "card" ? "Th·∫ª" : "Online";

          return `
            <tr>
                <td><strong>ORD-${order.order_id}</strong></td>
                <td>${(() => {
                  let customerDisplay = "V√£ng lai";
                  if (order.customer_id) {
                    if (typeof order.customer_id === 'string') {
                      customerDisplay = `ID: ${order.customer_id.substring(0, 8)}...`;
                    } else if (typeof order.customer_id === 'object') {
                      customerDisplay = order.customer_id.username || order.customer_id.full_name || order.customer_id.email || (order.customer_id._id ? `ID: ${String(order.customer_id._id).substring(0,8)}...` : 'V√£ng lai');
                    }
                  }
                  return customerDisplay;
                })()}</td>
                <td>${new Date(order.order_date || order.createdAt).toLocaleString('vi-VN')}</td>
                <td>${order.order_items ? order.order_items.length : 0}</td>
                <td>${order.total_amount.toLocaleString()}‚Ç´</td>
                <td>${paymentMethodText}</td>
              <td>
                <span style="background-color: ${statusColor}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${order.status}
                </span>
              </td>
              <td>
                <button class="btn-edit" onclick="window.viewOrder(${order.order_id})" title="Xem"><i class="bx bx-show"></i></button>
                <button class="btn-edit" onclick="window.editOrder(${order.order_id})" title="S·ª≠a"><i class="bx bx-edit"></i></button>
                <button class="btn-delete" onclick="window.deleteOrder(${order.order_id})" title="X√≥a"><i class="bx bx-trash"></i></button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = orders.filter(order => {
          const orderIdMatch = String(order.order_id).includes(keyword);
          let customerText = "";
          if (order.customer_id) {
            if (typeof order.customer_id === 'string') customerText = order.customer_id;
            else if (typeof order.customer_id === 'object') {
              customerText = order.customer_id.username || order.customer_id.full_name || order.customer_id.email || String(order.customer_id._id || '');
            }
          }
          const customerMatch = customerText && customerText.toLowerCase().includes(keyword);
          return orderIdMatch || customerMatch;
        });
        renderTable(filtered);
      });

      // ========== FORM SUBMIT ==========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let items = [];
        try {
          items = JSON.parse(document.getElementById("order-items").value || "[]");
          if (!Array.isArray(items) || items.length === 0) {
            showError("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt m·∫∑t h√†ng");
            return;
          }
        } catch (err) {
          showError("ƒê·ªãnh d·∫°ng JSON m·∫∑t h√†ng kh√¥ng h·ª£p l·ªá");
          return;
        }

        const payload = {
          customer_id: document.getElementById("order-customer-id").value.trim() || null,
          order_items: items,
          payment_method: document.getElementById("order-payment-method").value,
          notes: document.getElementById("order-notes").value.trim(),
          status: document.getElementById("order-status").value,
        };

        try {
          let res;
          if (editingOrderId) {
            // Update
            res = await orderAPI.update(editingOrderId, payload);
            showSuccess("‚úÖ C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng");
          } else {
            // Create
            res = await orderAPI.create(payload);
            showSuccess("‚úÖ Th√™m ƒë∆°n h√†ng th√†nh c√¥ng");
          }

          console.log("Response:", res);
          closeModal();
          await loadOrders();
        } catch (error) {
          console.error("Error:", error);
          showError("‚ùå L·ªói: " + error.message);
        }
      });

      // ========== ACTIONS ==========
      window.viewOrder = (id) => {
        const order = orders.find(o => o.order_id === id);
        if (order) openDetailModal(order);
      };

      window.editOrder = (id) => {
        openModal("S·ª≠a ƒë∆°n h√†ng", id);
      };

      window.changeStatus = async (id) => {
        const statuses = ["Pending", "Processing", "Completed", "Cancelled"];
        const status = prompt("Nh·∫≠p tr·∫°ng th√°i m·ªõi (Pending/Processing/Completed/Cancelled):");
        
        if (status && statuses.includes(status)) {
          try {
            await orderAPI.updateStatus(id, status);
            showSuccess("‚úÖ C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng");
            detailModal.style.display = "none";
            await loadOrders();
          } catch (error) {
            showError("‚ùå L·ªói: " + error.message);
          }
        }
      };

      window.deleteOrder = async (id) => {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng n√†y?")) {
          try {
            await orderAPI.delete(id);
            showSuccess("‚úÖ X√≥a ƒë∆°n h√†ng th√†nh c√¥ng");
            detailModal.style.display = "none";
            await loadOrders();
          } catch (error) {
            showError("‚ùå L·ªói khi x√≥a: " + error.message);
          }
        }
      };

      // ========== NOTIFICATIONS ==========
      function showError(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #f44336;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      function showSuccess(message) {
        const msg = document.createElement("div");
        msg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #4CAF50;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          animation: slideIn 0.3s ease;
        `;
        msg.textContent = message;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      // ========== INIT ==========
      document.addEventListener("DOMContentLoaded", loadOrders);

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
          localStorage.removeItem("user");
          window.location.href = "/Web/user/pages/login.html";
        }
      });
    </script>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .btn-blue {
        background: #2196F3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
      }

      .btn-blue:hover {
        background: #0b7dda;
      }
    </style>
  </body>
</html>

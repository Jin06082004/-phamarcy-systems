<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - H·ªá th·ªëng qu·∫£n l√Ω nh√† thu·ªëc</title>

    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/admin.css" />
  </head>
  <body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="bx bx-capsule logo-icon"></i>
        <span class="logo-text">Pharmacy</span>
      </div>

      <ul class="sidebar-menu">
        <li><a href="index.html"><i class="bx bx-home"></i><span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span></a></li>
        <li><a href="drugs.html"><i class="bx bx-plus-medical"></i><span>Thu·ªëc</span></a></li>
        <li><a href="categories.html"><i class="bx bx-category"></i><span>Danh m·ª•c</span></a></li>
        <li class="active"><a href="orders.html"><i class="bx bx-cart-alt"></i><span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="users.html"><i class="bx bx-user"></i><span>Ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="statistics.html"><i class="bx bx-line-chart"></i><span>Th·ªëng k√™</span></a></li>
        <li><a href="discount.html"><i class="bx bx-tag"></i><span>Khuy·∫øn m√£i</span></a></li>
        <li class="logout"><a href="#" id="logout-link"><i class="bx bx-log-out"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>

      <div class="sidebar-toggle" id="toggleSidebar"><i class="bx bx-chevron-left"></i></div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <header class="main-header">
        <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
        <div class="user-info"><i class="bx bx-user-circle"></i><span>Admin</span></div>
      </header>

      <section class="content">
        <div class="toolbar">
          <button class="btn-green" id="add-order-btn"><i class="bx bx-plus"></i> Th√™m ƒë∆°n h√†ng m·ªõi</button>
          <input type="text" id="order-search" class="search-input" placeholder="T√¨m ki·∫øm theo m√£ ƒë∆°n ho·∫∑c kh√°ch h√†ng..." />
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>M√£ ƒë∆°n h√†ng</th>
                <th>Kh√°ch h√†ng</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>S·ªë m·∫∑t h√†ng</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Ph∆∞∆°ng th·ª©c</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr style="text-align:center;"><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- ========== MODAL ADD/EDIT ORDER ========== -->
    <div id="order-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; border-bottom: none;">
          <h2 id="order-modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 700;">‚úèÔ∏è S·ª≠a ƒë∆°n h√†ng</h2>
          <button class="modal-close" id="order-close" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
        </div>
        <form id="order-form" style="padding: 32px;">
          <!-- Customer ID -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-user' style="font-size: 1.2rem; color: #10b981;"></i>
              Kh√°ch h√†ng (Customer ID):
            </label>
            <input type="text" id="order-customer-id" placeholder="Nh·∫≠p ID kh√°ch h√†ng (VD: 14)" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'" />
            <small style="color: #6b7280; display: block; margin-top: 6px; font-size: 0.875rem;">üí° ƒê·ªÉ tr·ªëng n·∫øu l√† kh√°ch v√£ng lai</small>
          </div>

          <!-- Order Items -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-list-ul' style="font-size: 1.2rem; color: #10b981;"></i>
              M·∫∑t h√†ng:
            </label>
            
            <!-- Display mode (khi edit) -->
            <div id="order-items-display" style="display: none;"></div>
            
            <!-- Edit mode (khi add new) -->
            <textarea id="order-items" 
              placeholder='[
  {
    "drug_name": "Paracetamol 500mg",
    "drug_id": 7,
    "quantity": 2,
    "price": 120000
  }
]'
              style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; font-family: 'Courier New', monospace; min-height: 180px; background: #f9fafb; transition: all 0.3s; resize: vertical;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'; this.style.background='#ffffff'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.background='#f9fafb'"></textarea>
          </div>

          <!-- Payment Method -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-credit-card' style="font-size: 1.2rem; color: #10b981;"></i>
              Ph∆∞∆°ng th·ª©c thanh to√°n:
            </label>
            <select id="order-payment-method" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; background: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
              <option value="cash">üíµ Ti·ªÅn m·∫∑t (Cash)</option>
              <option value="card">üí≥ Th·∫ª t√≠n d·ª•ng (Card)</option>
              <option value="online">üåê Thanh to√°n online (QR Code)</option>
            </select>
          </div>

          <!-- Notes -->
          <div class="form-group" style="margin-bottom: 24px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-note' style="font-size: 1.2rem; color: #10b981;"></i>
              Ghi ch√∫ / Th√¥ng tin giao h√†ng:
            </label>
            
            <!-- Display mode (khi edit) -->
            <div id="order-notes-display" style="display: none;"></div>
            
            <!-- Edit mode (khi add new) -->
            <textarea id="order-notes" placeholder='{"fullName":"Jin","phone":"0974088423","address":"363/2/24 b√¨nh l·ª£i, B√¨nh Th·∫°nh, TP H·ªì Ch√≠ Minh","notes":""}' style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; min-height: 100px; font-family: 'Courier New', monospace; background: #f9fafb; transition: all 0.3s; resize: vertical;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'; this.style.background='#ffffff'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.background='#f9fafb'"></textarea>
          </div>

          <!-- Status -->
          <div class="form-group" style="margin-bottom: 32px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 0.95rem;">
              <i class='bx bx-info-circle' style="font-size: 1.2rem; color: #10b981;"></i>
              Tr·∫°ng th√°i:
            </label>
            <select id="order-status" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; background: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
              <option value="Pending">‚è≥ Ch·ªù x·ª≠ l√Ω (Pending)</option>
              <option value="Processing">üîÑ ƒêang x·ª≠ l√Ω (Processing)</option>
              <option value="Completed">‚úÖ Ho√†n th√†nh (Completed)</option>
              <option value="Cancelled">‚ùå ƒê√£ h·ªßy (Cancelled)</option>
            </select>
            <small style="color: #f59e0b; display: block; margin-top: 8px; font-size: 0.875rem; background: #fef3c7; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #f59e0b;">
              <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Chuy·ªÉn sang "ƒê√£ h·ªßy" s·∫Ω ho√†n tr·∫£ s·ªë l∆∞·ª£ng thu·ªëc v√†o kho
            </small>
          </div>

          <!-- Actions -->
          <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #f3f4f6;">
            <button type="button" class="btn-gray" id="order-cancel" style="padding: 12px 28px; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#9ca3af'" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db'">
              ‚úñÔ∏è H·ªßy
            </button>
            <button type="submit" class="btn-green" style="padding: 12px 32px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
              üíæ L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ========== DETAIL MODAL ========== -->
    <div id="detail-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 850px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; border-bottom: none; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px;">
            <i class='bx bx-receipt' style="font-size: 1.8rem;"></i>
            Chi ti·∫øt ƒë∆°n h√†ng
          </h2>
          <button class="modal-close" id="detail-close" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0deg)'">&times;</button>
        </div>
        <div id="detail-content" style="padding: 8px;">
          <!-- Detail content will be injected here -->
        </div>
      </div>
    </div>

    <!-- ========== SCRIPT ========== -->
    <script type="module">
      import { orderAPI } from "../shared/api.js";

      // ========== STATE ==========
      let orders = [];
      let editingOrderId = null;

      // ========== DOM ELEMENTS ==========
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const icon = toggleSidebar.querySelector("i");
      const modal = document.getElementById("order-modal");
      const detailModal = document.getElementById("detail-modal");
      const modalTitle = document.getElementById("order-modal-title");
      const closeBtn = document.getElementById("order-close");
      const detailCloseBtn = document.getElementById("detail-close");
      const cancelBtn = document.getElementById("order-cancel");
      const addBtn = document.getElementById("add-order-btn");
      const orderForm = document.getElementById("order-form");
      const searchInput = document.getElementById("order-search");

      // ========== SIDEBAR TOGGLE ==========
      toggleSidebar.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        icon.classList.toggle("bx-chevron-right");
      });

      // ========== MODAL CONTROL ==========
      function openModal(title = "Th√™m ƒë∆°n h√†ng m·ªõi", orderId = null) {
        modalTitle.textContent = title;
        editingOrderId = orderId;

        if (orderId) {
          // Edit mode
          const order = orders.find(o => o.order_id === orderId);
          if (order) {
            document.getElementById("order-customer-id").value = order.customer_id || "";
            
            // Hi·ªÉn th·ªã items d·∫°ng HTML table thay v√¨ JSON
            const itemsContainer = document.getElementById("order-items-display");
            itemsContainer.innerHTML = (order.order_items || []).map((item, index) => `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; color: #1f2937; margin-bottom: 4px;">
                      ${item.drug_name || 'Kh√¥ng r√µ t√™n'}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem;">
                      üè∑Ô∏è ID: ${item.drug_id}
                    </div>
                  </div>
                  <button type="button" onclick="removeOrderItem(${index})" style="background: #fee2e2; color: #dc2626; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                    üóëÔ∏è X√≥a
                  </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6;">
                  <div>
                    <div style="color: #6b7280; font-size: 0.8rem; margin-bottom: 4px;">S·ªë l∆∞·ª£ng</div>
                    <div style="font-weight: 600; color: #10b981;">√ó${item.quantity}</div>
                  </div>
                  <div>
                    <div style="color: #6b7280; font-size: 0.8rem; margin-bottom: 4px;">ƒê∆°n gi√°</div>
                    <div style="font-weight: 600; color: #3b82f6;">${item.price?.toLocaleString() || 0}‚Ç´</div>
                  </div>
                  <div>
                    <div style="color: #6b7280; font-size: 0.8rem; margin-bottom: 4px;">Th√†nh ti·ªÅn</div>
                    <div style="font-weight: 700; color: #dc2626;">${((item.quantity || 0) * (item.price || 0)).toLocaleString()}‚Ç´</div>
                  </div>
                </div>
              </div>
            `).join('');
            
            document.getElementById("order-payment-method").value = order.payment_method || "cash";
            
            // Parse v√† hi·ªÉn th·ªã notes d·∫°ng ƒë·∫πp
            try {
              const notesData = typeof order.notes === 'string' ? JSON.parse(order.notes) : order.notes;
              if (notesData && typeof notesData === 'object') {
                document.getElementById("order-notes-display").innerHTML = `
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
                    <div style="display: grid; gap: 16px;">
                      <div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 6px;">üë§ H·ªç t√™n</div>
                        <div style="font-weight: 600; color: #1f2937; font-size: 1.05rem;">${notesData.fullName || 'Ch∆∞a c√≥'}</div>
                      </div>
                      <div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 6px;">üìû S·ªë ƒëi·ªán tho·∫°i</div>
                        <div style="font-weight: 600; color: #1f2937;">${notesData.phone || 'Ch∆∞a c√≥'}</div>
                      </div>
                      <div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 6px;">üìç ƒê·ªãa ch·ªâ giao h√†ng</div>
                        <div style="font-weight: 600; color: #1f2937; line-height: 1.6;">${notesData.address || 'Ch∆∞a c√≥'}</div>
                      </div>
                      ${notesData.notes ? `
                      <div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 6px;">üìù Ghi ch√∫ th√™m</div>
                        <div style="color: #1f2937; line-height: 1.6;">${notesData.notes}</div>
                      </div>
                      ` : ''}
                    </div>
                  </div>
                `;
              } else {
                document.getElementById("order-notes-display").innerHTML = `
                  <div style="background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 10px; padding: 20px; text-align: center; color: #6b7280;">
                    üìù ${order.notes || 'Kh√¥ng c√≥ ghi ch√∫'}
                  </div>
                `;
              }
            } catch (e) {
              document.getElementById("order-notes-display").innerHTML = `
                <div style="background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 10px; padding: 20px; text-align: center; color: #6b7280;">
                  üìù ${order.notes || 'Kh√¥ng c√≥ ghi ch√∫'}
                </div>
              `;
            }
            
            document.getElementById("order-status").value = order.status || "Pending";
            
            // ·∫®n textarea JSON, hi·ªán display
            document.getElementById("order-items").style.display = "none";
            document.getElementById("order-notes").style.display = "none";
            document.getElementById("order-items-display").style.display = "block";
            document.getElementById("order-notes-display").style.display = "block";
          }
        } else {
          // Add mode
          orderForm.reset();
          document.getElementById("order-payment-method").value = "cash";
          document.getElementById("order-status").value = "Pending";
          
          // Hi·ªán textarea JSON, ·∫©n display
          document.getElementById("order-items").style.display = "block";
          document.getElementById("order-notes").style.display = "block";
          document.getElementById("order-items-display").style.display = "none";
          document.getElementById("order-notes-display").style.display = "none";
        }

        modal.style.display = "flex";
      }

      // Function ƒë·ªÉ x√≥a item
      window.removeOrderItem = function(index) {
        const order = orders.find(o => o.order_id === editingOrderId);
        if (order && order.order_items) {
          order.order_items.splice(index, 1);
          openModal("‚úèÔ∏è S·ª≠a ƒë∆°n h√†ng", editingOrderId);
        }
      };

      function closeModal() {
        modal.style.display = "none";
        editingOrderId = null;
        orderForm.reset();
      }

      function openDetailModal(order) {
        const content = document.getElementById("detail-content");
        
        // Parse notes n·∫øu l√† JSON
        let notesDisplay = '';
        try {
          const notesData = typeof order.notes === 'string' ? JSON.parse(order.notes) : order.notes;
          if (notesData && typeof notesData === 'object') {
            notesDisplay = `
              <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px solid #86efac;">
                <h3 style="margin: 0 0 16px 0; color: #15803d; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                  <i class='bx bx-map' style="font-size: 1.4rem;"></i>
                  üì¶ Th√¥ng tin giao h√†ng
                </h3>
                <div style="display: grid; gap: 14px;">
                  <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      <i class='bx bx-user' style="font-size: 1.3rem; color: #10b981;"></i>
                    </div>
                    <div style="flex: 1;">
                      <div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 4px;">H·ªç t√™n</div>
                      <div style="font-weight: 600; color: #1f2937; font-size: 1.05rem;">${notesData.fullName || 'Ch∆∞a c√≥'}</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      <i class='bx bx-phone' style="font-size: 1.3rem; color: #10b981;"></i>
                    </div>
                    <div style="flex: 1;">
                      <div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 4px;">S·ªë ƒëi·ªán tho·∫°i</div>
                      <div style="font-weight: 600; color: #1f2937; font-size: 1.05rem;">${notesData.phone || 'Ch∆∞a c√≥'}</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      <i class='bx bx-map-pin' style="font-size: 1.3rem; color: #10b981;"></i>
                    </div>
                    <div style="flex: 1;">
                      <div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 4px;">ƒê·ªãa ch·ªâ giao h√†ng</div>
                      <div style="font-weight: 600; color: #1f2937; line-height: 1.6;">${notesData.address || 'Ch∆∞a c√≥'}</div>
                    </div>
                  </div>
                  ${notesData.notes ? `
                  <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      <i class='bx bx-note' style="font-size: 1.3rem; color: #10b981;"></i>
                    </div>
                    <div style="flex: 1;">
                      <div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 4px;">Ghi ch√∫ th√™m</div>
                      <div style="color: #1f2937; line-height: 1.6;">${notesData.notes}</div>
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>
            `;
          } else {
            notesDisplay = `
              <div style="background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 10px; padding: 16px; margin-top: 20px; text-align: center;">
                <i class='bx bx-note' style="font-size: 2rem; color: #9ca3af; margin-bottom: 8px;"></i>
                <div style="color: #6b7280; font-size: 0.95rem;">${order.notes || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
              </div>
            `;
          }
        } catch (e) {
          notesDisplay = `
            <div style="background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 10px; padding: 16px; margin-top: 20px; text-align: center;">
              <i class='bx bx-note' style="font-size: 2rem; color: #9ca3af; margin-bottom: 8px;"></i>
              <div style="color: #6b7280; font-size: 0.95rem;">${order.notes || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
            </div>
          `;
        }

        // Items display v·ªõi card ƒë·∫πp
        const itemsHtml = (order.order_items || []).map(item => `
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 18px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='#10b981'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'; this.style.borderColor='#e5e7eb'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 14px;">
              <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 1.15rem; color: #1f2937; margin-bottom: 6px;">
                  ${item.drug_name || 'Kh√¥ng r√µ t√™n'}
                </div>
                <div style="display: inline-block; background: #f0fdf4; color: #15803d; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                  üè∑Ô∏è ID: ${item.drug_id}
                </div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-top: 14px; border-top: 2px solid #f3f4f6;">
              <div>
                <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 6px; font-weight: 500;">S·ªë l∆∞·ª£ng</div>
                <div style="font-weight: 700; color: #10b981; font-size: 1.1rem;">√ó${item.quantity}</div>
              </div>
              <div>
                <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 6px; font-weight: 500;">ƒê∆°n gi√°</div>
                <div style="font-weight: 700; color: #3b82f6; font-size: 1.1rem;">${(item.price || 0).toLocaleString()}‚Ç´</div>
              </div>
              <div>
                <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 6px; font-weight: 500;">Th√†nh ti·ªÅn</div>
                <div style="font-weight: 700; color: #dc2626; font-size: 1.15rem;">${((item.quantity || 0) * (item.price || 0)).toLocaleString()}‚Ç´</div>
              </div>
            </div>
          </div>
        `).join("");

        // Status styling
        const statusInfo = {
          'Pending': { color: '#fef3c7', textColor: '#92400e', icon: '‚è≥', label: 'Ch·ªù x·ª≠ l√Ω' },
          'Processing': { color: '#dbeafe', textColor: '#1e40af', icon: 'üîÑ', label: 'ƒêang x·ª≠ l√Ω' },
          'Completed': { color: '#d1fae5', textColor: '#065f46', icon: '‚úÖ', label: 'Ho√†n th√†nh' },
          'Cancelled': { color: '#fee2e2', textColor: '#991b1b', icon: '‚ùå', label: 'ƒê√£ h·ªßy' }
        };
        const currentStatus = statusInfo[order.status] || statusInfo['Pending'];

        // Payment method icon
        const paymentIcons = {
          'cash': 'üíµ',
          'card': 'üí≥',
          'online': 'üåê'
        };
        const paymentLabels = {
          'cash': 'Ti·ªÅn m·∫∑t',
          'card': 'Th·∫ª t√≠n d·ª•ng',
          'online': 'Thanh to√°n online'
        };

        content.innerHTML = `
          <div style="padding: 8px;">
            <!-- Header Info -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; box-shadow: 0 8px 24px rgba(59,130,246,0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                  <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 4px;">M√£ ƒë∆°n h√†ng</div>
                  <div style="font-size: 2rem; font-weight: 800;">ORD-${order.order_id}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px;">
                  <i class='bx bx-receipt' style="font-size: 2.5rem;"></i>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px;">üë§ Kh√°ch h√†ng</div>
                  <div style="font-weight: 600; font-size: 1.05rem;">${order.customer_id ? `ID: ${order.customer_id}` : "Kh√°ch v√£ng lai"}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px;">üìÖ Ng√†y ƒë·∫∑t</div>
                  <div style="font-weight: 600; font-size: 1.05rem;">${new Date(order.order_date || order.createdAt).toLocaleDateString('vi-VN')}</div>
                </div>
              </div>
            </div>

            <!-- Payment Method -->
            <div style="background: #fef3c7; border-radius: 12px; padding: 16px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 2rem;">${paymentIcons[order.payment_method] || 'üíµ'}</div>
                <div>
                  <div style="color: #92400e; font-size: 0.85rem; margin-bottom: 2px;">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
                  <div style="font-weight: 700; color: #78350f; font-size: 1.1rem;">${paymentLabels[order.payment_method] || 'Ti·ªÅn m·∫∑t'}</div>
                </div>
              </div>
            </div>

            <!-- Items -->
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-list-ul' style="font-size: 1.5rem; color: #10b981;"></i>
                Danh s√°ch s·∫£n ph·∫©m
              </h3>
              ${itemsHtml}
            </div>

            <!-- Notes -->
            ${notesDisplay}

              <!-- Summary -->
            <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 16px; padding: 24px; margin-top: 24px; border: 2px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 6px;">T·ªïng thanh to√°n</div>
                  <div style="font-size: 2rem; font-weight: 800; color: #dc2626;">${(order.total_amount || 0).toLocaleString()}‚Ç´</div>
                </div>
                <div style="text-align: right;">
                  <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 8px;">Tr·∫°ng th√°i</div>
                  <div style="background: ${currentStatus.color}; color: ${currentStatus.textColor}; padding: 10px 20px; border-radius: 10px; font-weight: 700; font-size: 1.1rem; display: inline-block; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    ${currentStatus.icon} ${currentStatus.label}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        detailModal.style.display = "flex";
      }      addBtn.addEventListener("click", () => openModal());
      closeBtn.addEventListener("click", closeModal);
      detailCloseBtn.addEventListener("click", () => { detailModal.style.display = "none"; });
      cancelBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
      detailModal.addEventListener("click", (e) => { if (e.target === detailModal) detailModal.style.display = "none"; });

      // ========== LOAD ORDERS ==========
      async function loadOrders() {
        try {
          console.log("üîÑ ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...");
          
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          console.log('üìã Token:', token ? `${token.substring(0, 20)}...` : 'KH√îNG C√ì');
          console.log('üë§ User:', user);
          
          if (!token || !user || user.role !== 'admin') {
            console.warn('‚ö†Ô∏è Kh√¥ng c√≥ token ho·∫∑c kh√¥ng ph·∫£i admin');
            showError('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i v·ªõi t√†i kho·∫£n admin');
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/Web/user/pages/login.html';
            }, 2000);
            return;
          }
          
          const res = await orderAPI.getAll();
          console.log("üì¶ Response:", res);

          if (Array.isArray(res)) {
            orders = res;
          } else if (res.success && Array.isArray(res.data)) {
            orders = res.data;
          } else {
            console.error('Unexpected response format:', res);
            showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng");
            return;
          }

          renderTable(orders);
          console.log(`‚úÖ ƒê√£ load ${orders.length} ƒë∆°n h√†ng`);
          
        } catch (error) {
          console.error("‚ùå L·ªói t·∫£i ƒë∆°n h√†ng:", error);
          
          // Auto clear invalid token
          if (error.status === 401 || error.status === 403) {
            showError("Token kh√¥ng h·ª£p l·ªá. ƒêang ƒëƒÉng xu·∫•t...");
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/Web/user/pages/login.html';
            }, 2000);
          } else {
            showError("L·ªói k·∫øt n·ªëi server: " + error.message);
            // Show retry button
            const tbody = document.querySelector("table tbody");
            tbody.innerHTML = `
              <tr style="text-align: center;">
                <td colspan="8" style="padding: 40px;">
                  <div style="font-size: 1.2rem; margin-bottom: 10px; color: #ef4444;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</div>
                  <div style="font-size: 0.9rem; margin-bottom: 20px; color: #666;">${error.message}</div>
                  <button onclick="location.reload()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    üîÑ Th·ª≠ l·∫°i
                  </button>
                </td>
              </tr>
            `;
          }
        }
      }

      // ========== RENDER TABLE ==========
      function renderTable(data = orders) {
        const tbody = document.querySelector("table tbody");
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(order => {
          const statusColor = order.status === "Completed" ? "#d4fcd7" : 
                             order.status === "Cancelled" ? "#ffd6d6" : "#fff3cd";
          const paymentMethodText = order.payment_method === "cash" ? "Ti·ªÅn m·∫∑t" : 
                                   order.payment_method === "card" ? "Th·∫ª" : "Online";

          return `
            <tr>
                <td><strong>ORD-${order.order_id}</strong></td>
                <td>${(() => {
                  let customerDisplay = "V√£ng lai";
                  if (order.customer_id) {
                    if (typeof order.customer_id === 'string') {
                      customerDisplay = `ID: ${order.customer_id.substring(0, 8)}...`;
                    } else if (typeof order.customer_id === 'object') {
                      customerDisplay = order.customer_id.username || order.customer_id.full_name || order.customer_id.email || (order.customer_id._id ? `ID: ${String(order.customer_id._id).substring(0,8)}...` : 'V√£ng lai');
                    }
                  }
                  return customerDisplay;
                })()}</td>
                <td>${new Date(order.order_date || order.createdAt).toLocaleString('vi-VN')}</td>
                <td>${order.order_items ? order.order_items.length : 0}</td>
                <td>${order.total_amount.toLocaleString()}‚Ç´</td>
                <td>${paymentMethodText}</td>
              <td>
                <span style="background-color: ${statusColor}; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${order.status}
                </span>
              </td>
              <td>
                <button class="btn-edit" onclick="window.viewOrder(${order.order_id})" title="Xem"><i class="bx bx-show"></i></button>
                <button class="btn-edit" onclick="window.editOrder(${order.order_id})" title="S·ª≠a"><i class="bx bx-edit"></i></button>
                <button class="btn-delete" onclick="window.deleteOrder(${order.order_id})" title="X√≥a"><i class="bx bx-trash"></i></button>
              </td>
            </tr>
          `;
        }).join("");
      }

      // ========== SEARCH ==========
      searchInput.addEventListener("keyup", () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = orders.filter(order => {
          const orderIdMatch = String(order.order_id).includes(keyword);
          let customerText = "";
          if (order.customer_id) {
            if (typeof order.customer_id === 'string') customerText = order.customer_id;
            else if (typeof order.customer_id === 'object') {
              customerText = order.customer_id.username || order.customer_id.full_name || order.customer_id.email || String(order.customer_id._id || '');
            }
          }
          const customerMatch = customerText && customerText.toLowerCase().includes(keyword);
          return orderIdMatch || customerMatch;
        });
        renderTable(filtered);
      });

      // ========== ACTIONS ==========
      window.viewOrder = (id) => {
        const order = orders.find(o => o.order_id === id);
        if (order) openDetailModal(order);
      };

      window.editOrder = (id) => {
        openModal("S·ª≠a ƒë∆°n h√†ng", id);
      };

      // Notification helpers
      function showSuccess(message) {
        notification.success(message);
      }

      function showError(message) {
        notification.error(message);
      }

      function showInfo(message) {
        notification.info(message);
      }

      // ========== CHANGE STATUS ==========
      window.changeStatus = async (id) => {
        const order = orders.find(o => o.order_id === id);
        if (!order) return;

        const statuses = [
          { value: "Pending", label: "‚è≥ Ch·ªù x·ª≠ l√Ω", color: "#f59e0b" },
          { value: "Processing", label: "üîÑ ƒêang x·ª≠ l√Ω", color: "#3b82f6" },
          { value: "Completed", label: "‚úÖ Ho√†n th√†nh", color: "#10b981" },
          { value: "Cancelled", label: "‚ùå ƒê√£ h·ªßy", color: "#ef4444" }
        ];

        const currentStatus = order.status;
        const currentStatusInfo = statuses.find(s => s.value === currentStatus);

        // Create custom modal with status options
        const statusOptions = statuses.map(s => `
          <label style="display: flex; align-items: center; gap: 12px; padding: 16px; background: ${s.value === currentStatus ? '#f0fdf4' : '#f9fafb'}; border: 2px solid ${s.value === currentStatus ? '#10b981' : '#e5e7eb'}; border-radius: 12px; cursor: pointer; transition: all 0.3s; margin-bottom: 12px;" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background='${s.value === currentStatus ? '#f0fdf4' : '#f9fafb'}'">
            <input type="radio" name="orderStatus" value="${s.value}" ${s.value === currentStatus ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 1.125rem; color: ${s.color}; margin-bottom: 4px;">${s.label}</div>
              ${s.value === currentStatus ? '<div style="font-size: 0.875rem; color: #6b7280;">(Hi·ªán t·∫°i)</div>' : ''}
            </div>
          </label>
        `).join('');

        const result = await notification.show({
          type: 'question',
          title: `üìã Thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng #${id}`,
          message: `
            <div style="text-align: left; margin-bottom: 20px;">
              <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 8px;">Tr·∫°ng th√°i hi·ªán t·∫°i:</div>
                <div style="font-weight: 700; font-size: 1.25rem; color: ${currentStatusInfo.color};">${currentStatusInfo.label}</div>
              </div>
              
              <div style="font-weight: 600; margin-bottom: 16px; color: #1f2937;">Ch·ªçn tr·∫°ng th√°i m·ªõi:</div>
              ${statusOptions}
              
              <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-top: 20px;">
                <div style="font-size: 0.875rem; color: #92400e;">
                  <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> N·∫øu chuy·ªÉn sang tr·∫°ng th√°i <strong>"ƒê√£ h·ªßy"</strong>, s·ªë l∆∞·ª£ng thu·ªëc s·∫Ω ƒë∆∞·ª£c ho√†n tr·∫£ v√†o kho.
                </div>
              </div>
            </div>
          `,
          confirmText: 'X√°c nh·∫≠n thay ƒë·ªïi',
          cancelText: 'H·ªßy b·ªè'
        });

        if (!result) return;

        const selectedStatus = document.querySelector('input[name="orderStatus"]:checked')?.value;
        
        if (!selectedStatus || selectedStatus === currentStatus) {
          showInfo('Tr·∫°ng th√°i kh√¥ng thay ƒë·ªïi');
          return;
        }

        try {
          await orderAPI.updateStatus(id, selectedStatus);
          
          let message = `C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng: ${currentStatusInfo.label} ‚Üí ${statuses.find(s => s.value === selectedStatus).label}`;
          
          if (selectedStatus === 'Cancelled' && currentStatus !== 'Cancelled') {
            message += '\n\n‚úÖ ƒê√£ ho√†n tr·∫£ s·ªë l∆∞·ª£ng thu·ªëc v√†o kho';
          } else if (currentStatus === 'Cancelled' && selectedStatus !== 'Cancelled') {
            message += '\n\n‚úÖ ƒê√£ tr·ª´ l·∫°i s·ªë l∆∞·ª£ng thu·ªëc t·ª´ kho';
          }
          
          showSuccess(message);
          detailModal.style.display = "none";
          await loadOrders();
        } catch (error) {
          console.error('Change status error:', error);
          showError("L·ªói: " + (error.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i'));
        }
      };

      // ========== DELETE ORDER ==========
      window.deleteOrder = async (id) => {
        const order = orders.find(o => o.order_id === id);
        if (!order) return;

        const itemsList = order.order_items.map(item => 
          `‚Ä¢ ${item.drug_name} x${item.quantity}`
        ).join('<br>');

        const confirmed = await notification.confirm(
          `
          <div style="text-align: left;">
            <div style="background: #fef2f2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
              <div style="font-weight: 700; color: #dc2626; margin-bottom: 12px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?</div>
              <div style="font-size: 0.875rem; color: #991b1b;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <strong>M√£ ƒë∆°n:</strong> <span style="color: #10b981;">ORD-${id}</span>
            </div>
            <div style="margin-bottom: 12px;">
              <strong>T·ªïng ti·ªÅn:</strong> <span style="color: #ef4444; font-weight: 700;">${order.total_amount.toLocaleString()}‚Ç´</span>
            </div>
            <div style="margin-bottom: 16px;">
              <strong>S·∫£n ph·∫©m:</strong><br>
              <div style="margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 0.875rem;">
                ${itemsList}
              </div>
            </div>
            
            ${order.status !== 'Cancelled' ? '<div style="background: #d1fae5; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;"><div style="font-size: 0.875rem; color: #065f46;">‚úÖ S·ªë l∆∞·ª£ng thu·ªëc s·∫Ω ƒë∆∞·ª£c ho√†n tr·∫£ v√†o kho</div></div>' : ''}
          </div>
          `,
          'üóëÔ∏è X√°c nh·∫≠n x√≥a ƒë∆°n h√†ng'
        );

        if (!confirmed) return;

        try {
          await orderAPI.delete(id);
          showSuccess("X√≥a ƒë∆°n h√†ng th√†nh c√¥ng!" + (order.status !== 'Cancelled' ? '\n‚úÖ ƒê√£ ho√†n tr·∫£ s·ªë l∆∞·ª£ng thu·ªëc v√†o kho' : ''));
          detailModal.style.display = "none";
          await loadOrders();
        } catch (error) {
          showError("L·ªói khi x√≥a: " + error.message);
        }
      };

      // ========== FORM SUBMIT ==========
      orderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const customerId = document.getElementById("order-customer-id").value.trim();
        const paymentMethod = document.getElementById("order-payment-method").value;
        const status = document.getElementById("order-status").value;

        // Parse order items from textarea or get from current order
        let orderItems = [];
        if (editingOrderId) {
          const order = orders.find(o => o.order_id === editingOrderId);
          orderItems = order ? order.order_items : [];
        } else {
          const itemsText = document.getElementById("order-items").value.trim();
          if (!itemsText) {
            showError("Vui l√≤ng nh·∫≠p danh s√°ch s·∫£n ph·∫©m");
            return;
          }
          try {
            orderItems = JSON.parse(itemsText);
            if (!Array.isArray(orderItems)) {
              showError("Danh s√°ch s·∫£n ph·∫©m ph·∫£i l√† m·∫£ng JSON");
              return;
            }
          } catch (error) {
            showError("D·ªØ li·ªáu s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng JSON");
            return;
          }
        }

        // Parse notes
        let notes = '';
        if (editingOrderId) {
          const order = orders.find(o => o.order_id === editingOrderId);
          notes = order ? order.notes : '';
        } else {
          notes = document.getElementById("order-notes").value.trim();
        }

        const payload = {
          customer_id: customerId ? Number(customerId) : null,
          payment_method: paymentMethod,
          status: status,
          notes: notes,
          order_items: orderItems
        };

        try {
          let res;
          if (editingOrderId) {
            res = await orderAPI.update(editingOrderId, payload);
            showSuccess("C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng");
          } else {
            res = await orderAPI.create(payload);
            showSuccess("Th√™m ƒë∆°n h√†ng th√†nh c√¥ng");
          }

          console.log("Response:", res);
          closeModal();
          await loadOrders();
        } catch (error) {
          console.error("Error:", error);
          showError("L·ªói: " + error.message);
        }
      });

      // ========== LOGOUT ==========
      document.getElementById("logout-link").addEventListener("click", async (e) => {
        e.preventDefault();
        
        const confirmed = await notification.confirm(
          'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?',
          'üö™ X√°c nh·∫≠n ƒëƒÉng xu·∫•t'
        );
        
        if (confirmed) {
          localStorage.removeItem("user");
          localStorage.removeItem("token");
          showInfo('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
          setTimeout(() => {
            window.location.href = "/Web/user/pages/login.html";
          }, 1000);
        }
      });

      // ========== INITIALIZATION ==========
      (async function init() {
        try {
          console.log("üöÄ Kh·ªüi t·∫°o trang Qu·∫£n l√Ω ƒë∆°n h√†ng...");
          
          // Check authentication
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || 'null');
          
          if (!token || !user) {
            console.warn('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p');
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c');
            window.location.href = '/Web/user/pages/login.html';
            return;
          }
          
          if (user.role !== 'admin') {
            console.warn('‚ö†Ô∏è Kh√¥ng ph·∫£i admin');
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
            window.location.href = '/Web/user/index.html';
            return;
          }
          
          console.log('‚úÖ User authenticated:', user.username);
          
          // Load data
          await loadOrders();
          
          console.log("‚úÖ Kh·ªüi t·∫°o th√†nh c√¥ng!");
          
        } catch (error) {
          console.error("‚ùå L·ªói kh·ªüi t·∫°o:", error);
          const tbody = document.querySelector("table tbody");
          tbody.innerHTML = `
            <tr style="text-align: center;">
              <td colspan="8" style="padding: 40px;">
                <div style="font-size: 1.2rem; margin-bottom: 10px; color: #ef4444;">‚ùå L·ªói kh·ªüi t·∫°o trang</div>
                <div style="font-size: 0.9rem; margin-bottom: 20px; color: #666;">${error.message}</div>
                <button onclick="localStorage.clear(); location.reload();" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                  üîÑ ƒêƒÉng nh·∫≠p l·∫°i
                </button>
              </td>
            </tr>
          `;
        }
      })();
    </script>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .btn-blue {
        background: #2196F3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
      }

      .btn-blue:hover {
        background: #0b7dda;
      }
    </style>

    <script src="../shared/notification.js"></script>
  </body>
</html>
